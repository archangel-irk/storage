!function(a){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=a();else if("function"==typeof define&&define.amd)define([],a);else{var b;"undefined"!=typeof window?b=window:"undefined"!=typeof global?b=global:"undefined"!=typeof self&&(b=self),b.storage=a()}}(function(){return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b){function c(a,b,c){this.name=a,this.documents={},!_.isObject(b)||b instanceof d||(b=new d(b)),this.api=c,this.schema=b,this.array=[],window.ko&&ko.track(this,["array"])}var d=a("./schema"),e=a("./document");c.prototype={add:function(a,b,c,d){var f=this;if(null==a&&(a=null),_.isArray(a)){var g=[];return _.each(a,function(a){g.push(f.add(a,b,c,!0))}),this.storageHasMutated(),g}var h=a&&a._id;if(h&&this.documents[h])this.documents[h].set(a);else{var i,j=this.schema?this.schema.discriminatorMapping:null,k=j&&j.isRoot?j.key:null;i=k&&a&&a[k]&&this.schema.discriminators&&this.schema.discriminators[a[k]]?this.schema.discriminators[a[k]]:this.schema;var l=new e(a,this.name,i,b,c);h=l._id.toString()}return d||this.storageHasMutated(),this.documents[h]},remove:function(a){return delete this.documents[a._id||a]},find:function(a){return _.where(this.documents,a)},findById:function(a){return this.documents[a]},findByIdAndRemove:function(a){return this.remove(this.findById(a)),this},findByIdAndUpdate:function(a,b,c){return this.update(this.findById(a),b,c)},findOne:function(a){return _.findWhere(this.documents,a)},findOneAndRemove:function(a){return this.remove(this.findOne(a)),this},findOneAndUpdate:function(a,b,c){return this.update(this.findOne(a),b,c)},update:function(a,b,c){var d=this.documents[a._id||a];return null==d?(console.warn("storage::update: Document is not found."),!1):d.set(b,c)},storageHasMutated:function(){this.array=_.toArray(this.documents)}},b.exports=c},{"./document":2,"./schema":12}],2:[function(a,b){function c(a,b,c,d,e){if(this.$__=new u,this.isNew=!0,"boolean"==typeof a&&(e=a,a=null),!_.isObject(c)||c instanceof p||(c=new p(c)),a instanceof p?(c=a,a=null,c.options._id&&(a={_id:new o})):(c=this.schema||c,!this.schema&&c.options._id&&(a=a||{},void 0===a._id&&(a._id=new o))),!c)throw new TypeError("Нельзя создавать документ без схемы");if("boolean"==typeof b&&(e=b,b=void 0),"boolean"==typeof d?(this.$__.strictMode=d,d=void 0):(this.$__.strictMode=c.options&&c.options.strict,this.$__.selected=d),this.schema=c,this.collection=window.storage[b],this.collectionName=b,this.collection){if(null==a||!a._id)throw new TypeError("Для помещения в коллекцию необходимо, чтобы у документа был _id");this.collection.documents[a._id]=this}for(var f=c.requiredPaths(),g=0;g<f.length;++g)this.$__.activePaths.require(f[g]);this.$__setSchema(c),this._doc=this.$__buildDoc(a,e),e?this.init(a):a&&this.set(a,void 0,!0);for(var h in c.methods)this[h]=c.methods[h];for(var i in c.statics)this[i]=c.statics[i]}function d(a,b,c,e){e=e||"";for(var f,g,h,i=Object.keys(b),j=i.length;j--;)h=i[j],g=e+h,f=a.schema.path(g),f||!_.isPlainObject(b[h])||b[h].constructor&&"Object"!=r.getFunctionName(b[h].constructor)?(null===b[h]?c[h]=null:void 0!==b[h]&&(f?a.$__try(function(){c[h]=f.cast(b[h],a,!0)}):c[h]=b[h],a.adapterHooks.documentSetInitialValue.call(a,a,g,c[h])),a.$__.activePaths.init(g)):(c[h]||(c[h]={}),d(a,b[h],c[h],g+"."))}function e(a,b,c,d){for(var e,f,h=Object.keys(b),i=h.length;i--;)f=h[i],e=b[f],g(a,f,"Object"!==r.getFunctionName(e.constructor)||!Object.keys(e).length||e.type&&!e.type.type?null:e,c,d,h)}function f(a){var b={};return Object.getOwnPropertyNames(a).forEach(function(c){b[c]=Object.getOwnPropertyDescriptor(a,c),b[c].enumerable=!1}),b}function g(a,b,d,g,h,i){h=h||"";var j=(h?h+".":"")+b;d?Object.defineProperty(g,b,{enumerable:!0,configurable:!0,get:function(){if(this.$__.getters||(this.$__.getters={}),!this.$__.getters[j]){var b=Object.create(Object.getPrototypeOf(this),f(this));h||(b.$__.scope=this);for(var c=0,g=i.length;g>c;++c)Object.defineProperty(b,i[c],{enumerable:!1,writable:!0,configurable:!0,value:void 0});b.toObject=function(){return this.get(j)},e(a,d,b,j),this.$__.getters[j]=b}return this.$__.getters[j]},set:function(a){return a instanceof c&&(a=a.toObject()),(this.$__.scope||this).set(j,a)}}):(Object.defineProperty(g,b,{enumerable:!0,configurable:!0,get:function(){return this.get.call(this.$__.scope||this,j)},set:function(a){return this.set.call(this.$__.scope||this,j,a)}}),a.adapterHooks.documentDefineProperty.call(a,a,j,g))}function h(a){for(var b,c,d,e=Object.keys(a),f=e.length;f--;)c=e[f],d=a[c],_.isPlainObject(d)&&(a[c]=h(d)),void 0!==a[c]?b=!0:delete a[c];return b?a:void 0}function i(a,b,c,d){for(var e,f=a.schema,g=Object.keys(f[c]),h=g.length;h--;){e=g[h];for(var i,j=e.split("."),k=j.length,l=k-1,m=b,n=0;k>n;++n)i=j[n],n===l?m[i]=r.clone(a.get(e),d):m=m[i]||(m[i]={})}return b}var j,k,l=a("./events"),m=a("./error"),n=a("./schema/mixed"),o=a("./types/objectid"),p=a("./schema"),q=a("./schematype").ValidatorError,r=a("./utils"),s=r.clone,t=m.ValidationError,u=a("./internal"),v=r.deepEqual;c.prototype=Object.create(l.prototype),c.prototype.constructor=c,c.prototype.schema,c.prototype.isNew,c.prototype.id,c.prototype.errors,c.prototype.adapterHooks={documentDefineProperty:$.noop,documentSetInitialValue:$.noop,documentGetValue:$.noop,documentSetValue:$.noop},c.prototype.$__buildDoc=function(a,b){for(var c={},d=this,e=Object.keys(this.schema.paths),f=e.length,g=0;f>g;++g){var h=e[g];if("_id"==h){if(b)continue;if(a&&"_id"in a)continue}for(var i=this.schema.paths[h],j=h.split("."),k=j.length,l=k-1,m=c,n=0;k>n;++n){var o,p=j[n];n===l?(o=i.getDefault(d,!0),"undefined"!=typeof o&&(m[p]=o,d.$__.activePaths.default(h))):m=m[p]||(m[p]={})}}return c},c.prototype.init=function(a){return this.isNew=!1,d(this,a,this._doc),this},c.prototype.set=function(a,b,d,e){d&&"Object"==r.getFunctionName(d.constructor)&&(e=d,d=void 0);var f,g=e&&e.merge,h=d&&!0!==d,i=!0===d,j=e&&"strict"in e?e.strict:this.$__.strictMode;if(h&&(f=this.$__.adhocPaths||(this.$__.adhocPaths={}),f[a]=p.interpretAsType(a,d)),"string"!=typeof a){if(null!==a&&void 0!==a){var k=b?b+".":"";a instanceof c&&(a=a._doc);for(var l,m,o=Object.keys(a),q=o.length;q--;)if(m=o[q],l=this.schema.pathType(k+m),null==a[m]||!_.isPlainObject(a[m])||a[m].constructor&&"Object"!=r.getFunctionName(a[m].constructor)||"virtual"==l||this.$__path(k+m)instanceof n||this.schema.paths[m]&&this.schema.paths[m].options.ref)if(j){if("real"===l||"virtual"===l)this.set(k+m,a[m],i);else if("throw"==j)throw new Error("Field `"+m+"` is not in schema.")}else void 0!==a[m]&&this.set(k+m,a[m],i);else this.set(a[m],k+m,i);return this}var s=a;a=b,b=s}var t=this.schema.pathType(a);if("nested"==t&&b&&_.isPlainObject(b)&&(!b.constructor||"Object"==r.getFunctionName(b.constructor)))return g||this.setValue(a,null),this.set(b,a,i),this;var u,v,w=a.split(".");if("adhocOrUndefined"==t&&j){for(var x,q=0;q<w.length;++q)if(v=w.slice(0,q+1).join("."),u=this.schema.path(v),u instanceof n){x=!0;break}if(!x){if("throw"==j)throw new Error("Field `"+a+"` is not in schema.");return this}}else{if("virtual"==t)return u=this.schema.virtualpath(a),u.applySetters(b,this),this;u=this.$__path(a)}var y;if(w.length<=1)y=a;else{for(q=0;q<w.length;++q)if(v=w.slice(0,q+1).join("."),this.isDirectModified(v)||null===this.get(v)){y=v;break}y||(y=a)}var z=i?void 0:this.getValue(a);if(!u||void 0===b)return this.$__set(y,a,i,w,u,b,z),this;var A=this,B=this.$__try(function(){b=u.applySetters(b,A,!1,z)});return B&&this.$__set(y,a,i,w,u,b,z),this},c.prototype.$__shouldModify=function(a,b,c,d,e,f,g){return this.isNew?!0:void 0!==f||this.isSelected(b)?void 0===f&&b in this.$__.activePaths.states.default?!1:r.deepEqual(f,g||this.get(b))?!1:!0:!0},c.prototype.$__set=function(a,b,c,d,e,f){var g=this.$__shouldModify.apply(this,arguments);g&&this.markModified(a,f);for(var h=this._doc,i=0,j=d.length;j>i;i++){var k=i+1,l=k===j;l?(h[d[i]]=f,this.adapterHooks.documentSetValue.call(this,this,b,f)):h=h[d[i]]&&"Object"===r.getFunctionName(h[d[i]].constructor)?h[d[i]]:h[d[i]]&&"EmbeddedDocument"===r.getFunctionName(h[d[i]].constructor)?h[d[i]]:h[d[i]]&&Array.isArray(h[d[i]])?h[d[i]]:h[d[i]]={}}},c.prototype.getValue=function(a){return r.getValue(a,this._doc)},c.prototype.setValue=function(a,b){return r.setValue(a,b,this._doc),this},c.prototype.get=function(a,b){var c;b&&(c=this.$__.adhocPaths||(this.$__.adhocPaths={}),c[a]=p.interpretAsType(a,b));for(var d=this.$__path(a)||this.schema.virtualpath(a),e=a.split("."),f=this._doc,g=0,h=e.length;h>g;g++)f=void 0===f||null===f?void 0:f[e[g]];return d&&(f=d.applyGetters(f,this)),this.adapterHooks.documentGetValue.call(this,this,a),f},c.prototype.$__path=function(a){var b=this.$__.adhocPaths,c=b&&b[a];return c?c:this.schema.path(a)},c.prototype.markModified=function(a){this.$__.activePaths.modify(a)},c.prototype.$__try=function(a,b){var c;try{a.call(b),c=!0}catch(d){this.$__error(d),c=!1}return c},c.prototype.modifiedPaths=function(){var a=Object.keys(this.$__.activePaths.states.modify);return a.reduce(function(a,b){var c=b.split(".");return a.concat(c.reduce(function(a,b,d){return a.concat(c.slice(0,d).concat(b).join("."))},[]))},[])},c.prototype.isModified=function(a){return a?!!~this.modifiedPaths().indexOf(a):this.$__.activePaths.some("modify")},c.prototype.isDirectModified=function(a){return a in this.$__.activePaths.states.modify},c.prototype.isInit=function(a){return a in this.$__.activePaths.states.init},c.prototype.isSelected=function(a){if(this.$__.selected){if("_id"===a)return 0!==this.$__.selected._id;var b,c=Object.keys(this.$__.selected),d=c.length,e=!1;if(1===d&&"_id"===c[0])return 0===this.$__.selected._id;for(;d--;)if(b=c[d],"_id"!=b){e=!!this.$__.selected[b];break}if(a in this.$__.selected)return e;d=c.length;for(var f=a+".";d--;)if(b=c[d],"_id"!=b){if(0===b.indexOf(f))return e;if(0===f.indexOf(b+"."))return e}return!e}return!0},c.prototype.validate=function(a){function b(a){f[a]||(f[a]=!0,g++,r.setImmediate(function(){var b=d.schema.path(a);if(!b)return--g||c();var e=d.getValue(a);b.doValidate(e,function(b){b&&d.invalidate(a,b,void 0),--g||c()},d)}))}function c(){var b=d.$__.validationError;d.$__.validationError=void 0,a&&a(b)}var d=this,e=Object.keys(this.$__.activePaths.states.require).filter(function(a){return d.isSelected(a)||d.isModified(a)?!0:!1});if(e=e.concat(Object.keys(this.$__.activePaths.states.init)),e=e.concat(Object.keys(this.$__.activePaths.states.modify)),e=e.concat(Object.keys(this.$__.activePaths.states.default)),0===e.length)return c(),this;var f={},g=0;return e.forEach(b),this},c.prototype.invalidate=function(a,b,c){this.$__.validationError||(this.$__.validationError=new t(this)),b&&"string"!=typeof b||(b=new q(a,b,"user defined",c)),this.$__.validationError!=b&&(this.$__.validationError.errors[a]=b)},c.prototype.$__reset=function(){var a=this;return this.$__.activePaths.map("init","modify",function(b){return a.getValue(b)}).filter(function(a){return a&&a.isStorageDocumentArray&&a.length}).forEach(function(a){for(var b=a.length;b--;){var c=a[b];c&&c.$__reset()}}),this.$__.activePaths.clear("modify"),this.$__.validationError=void 0,this.errors=void 0,this.schema.requiredPaths().forEach(function(b){a.$__.activePaths.require(b)}),this},c.prototype.$__dirty=function(){var a=this,b=this.$__.activePaths.map("modify",function(b){return{path:b,value:a.getValue(b),schema:a.$__path(b)}});b.sort(function(a,b){return a.path<b.path?-1:a.path>b.path?1:0});var c,d,e=[];return b.forEach(function(a){c=a.path+".",e.push(a),d=a}),d=c=null,e},c.prototype.$__setSchema=function(a){this.schema=a,e(this,a.tree,this)},c.prototype.$__getAllSubdocs=function(){function b(a,c){var d=this[c];return d instanceof k&&a.push(d),d instanceof j&&d.forEach(function(c){c&&c._doc&&(c instanceof k&&a.push(c),a=Object.keys(c._doc).reduce(b.bind(c._doc),a))}),a}return j||(j=a("./types/documentarray")),k=k||a("./types/embedded"),Object.keys(this._doc).reduce(b.bind(this),[])},c.prototype.$__presaveValidate=function(){var a=this.$__getArrayPathsToValidate(),b=a.map(function(a){return a.$__presaveValidate()}),c=[this.$__.saveError].concat(b),d=c.filter(function(a){return a})[0];return this.$__.saveError=null,d},c.prototype.$__getArrayPathsToValidate=function(){return j||(j=a("./types/documentarray")),this.$__.activePaths.map("init","modify",function(a){return this.getValue(a)}.bind(this)).filter(function(a){return a&&a instanceof j&&a.length}).reduce(function(a,b){return a.concat(b)},[]).filter(function(a){return a})},c.prototype.$__error=function(a){return this.$__.saveError=a,this},c.prototype.$__delta=function(){for(var a=this.$__dirty(),b={},c=a.length,d=0;c>d;++d){var e=a[d],f=e.value;f=r.clone(f,{depopulate:1}),b[e.path]=f}return b},c.prototype.$__handleSave=function(){var a;this.collection&&(a=this.collection.api);var b=new $.Deferred;if(this.isNew){var c=this.toObject({depopulate:1});if((c||{}).hasOwnProperty("_id")===!1)return b.reject(new Error("document must have an _id before saving")),b;a?a.create(c).always(b.resolve):b.resolve(this),this.$__reset(),this.isNew=!1,this.trigger("isNew",!1),this.$__.inserting=!0}else{this.$__.inserting=!1;var d=this.$__delta();_.isEmpty(d)?(this.$__reset(),b.resolve(this)):(this.$__reset(),a?a(this.id).update(d).always(b.resolve):b.resolve(this)),this.trigger("isNew",!1)}return b},c.prototype.save=function(a){var b=this,c=(new $.Deferred).done(a);if(!this.collection)return c.reject(arguments),console.error("Document.save api handle is not implemented."),c;var d=b.$__presaveValidate();if(d)return c.reject(d),c;var e=new $.Deferred;b.validate(function(a){a?(e.reject(a),c.reject(a)):e.resolve()});var f=b.$__getAllSubdocs(),g=f.map(function(a){return a.save()});g.push(e);var h=$.when.apply($,g);return h.then(this.$__handleSave.bind(this)).then(function(){return c.resolve(b)},function(a){b.$__.inserting&&(b.isNew=!0,b.emit("isNew",!0)),c.reject(a)}),c},c.prototype.toObject=function(a){if(a&&a.depopulate&&this.$__.wasPopulated)return r.clone(this._id,a);var b=a;(!a||"Object"!=r.getFunctionName(a.constructor)||a&&a._useSchemaOptions)&&(a=this.schema.options.toObject?s(this.schema.options.toObject):{}),void 0===a.minimize&&(a.minimize=this.schema.options.minimize),b||(a._useSchemaOptions=!0);var c=r.clone(this._doc,a);if((a.virtuals||a.getters&&!1!==a.virtuals)&&i(this,c,"virtuals",a),a.getters&&(i(this,c,"paths",a),a.minimize&&(c=h(c)||{})),!0===a.transform||this.schema.options.toObject&&a.transform){var d=a.json?this.schema.options.toJSON:this.schema.options.toObject;d&&(a.transform=d.transform)}if("function"==typeof a.transform){var e=a.transform(this,c,a);"undefined"!=typeof e&&(c=e)}return c},c.prototype.toJSON=function(a){return(!a||"Object"!=r.getFunctionName(a.constructor)||(!a||a.json)&&this.schema.options.toJSON)&&(a=this.schema.options.toJSON?r.clone(this.schema.options.toJSON):{}),a.json=!0,this.toObject(a)},c.prototype.equals=function(a){var b=this.get("_id"),c=a.get("_id");return b||c?b&&b.equals?b.equals(c):b===c:v(this,a)},c.prototype.populated=function(a,b,c){if(null==b){if(!this.$__.populated)return void 0;var d=this.$__.populated[a];return d?d.value:void 0}return!0===b?this.$__.populated?this.$__.populated[a]:void 0:(this.$__.populated||(this.$__.populated={}),this.$__.populated[a]={value:b,options:c},b)},c.prototype.$__fullPath=function(a){return a||""},c.prototype.remove=function(){return this.collection?this.collection.remove(this):delete this},c.prototype.empty=function(){for(var a=this,b=this,c=Object.keys(this.schema.paths),d=c.length,e=0;d>e;++e){var f=c[e];if("_id"!=f)for(var g=this.schema.paths[f],h=f.split("."),i=h.length,j=i-1,k=a,l=0;i>l;++l){var m,n=h[l];l===j?(m=g.getDefault(b,!0),k[n]=m||void 0,b.$__.activePaths.default(f)):k=k[n]||(k[n]={})}}},c.ValidationError=t,b.exports=c},{"./error":3,"./events":8,"./internal":10,"./schema":12,"./schema/mixed":18,"./schematype":22,"./types/documentarray":25,"./types/embedded":26,"./types/objectid":28,"./utils":29}],3:[function(a,b){function c(a){this.message=a,this.name="StorageError"}c.prototype=new Error,c.prototype.formatMessage=function(a,b,c,d){if(!a)throw new TypeError("message is required");return a.replace(/{PATH}/,b).replace(/{VALUE}/,String(d||"")).replace(/{TYPE}/,c||"declared type")},b.exports=c,c.messages=a("./error/messages"),c.CastError=a("./error/cast"),c.ValidationError=a("./error/validation"),c.ValidatorError=a("./error/validator")},{"./error/cast":4,"./error/messages":5,"./error/validation":6,"./error/validator":7}],4:[function(a,b){function c(a,b,c){d.call(this,"Cast to "+a+' failed for value "'+b+'" at path "'+c+'"'),this.name="CastError",this.type=a,this.value=b,this.path=c}var d=a("../error.js");c.prototype=Object.create(d.prototype),c.prototype.constructor=c,b.exports=c},{"../error.js":3}],5:[function(a,b){var c=b.exports={};c.general={},c.general.default="Validator failed for path `{PATH}` with value `{VALUE}`",c.general.required="Path `{PATH}` is required.",c.Number={},c.Number.min="Path `{PATH}` ({VALUE}) is less than minimum allowed value ({MIN}).",c.Number.max="Path `{PATH}` ({VALUE}) is more than maximum allowed value ({MAX}).",c.String={},c.String.enum="`{VALUE}` is not a valid enum value for path `{PATH}`.",c.String.match="Path `{PATH}` is invalid ({VALUE})."},{}],6:[function(a,b){function c(a){d.call(this,"Validation failed"),this.name="ValidationError",this.errors=a.errors={}}var d=a("../error.js");c.prototype=Object.create(d.prototype),c.prototype.constructor=c,b.exports=c},{"../error.js":3}],7:[function(a,b){function c(a,b,c,f){b||(b=e.general.default);var g=this.formatMessage(b,a,c,f);d.call(this,g),this.name="ValidatorError",this.path=a,this.type=c,this.value=f}var d=a("../error.js"),e=d.messages;c.prototype.toString=function(){return this.message},c.prototype=Object.create(d.prototype),c.prototype.constructor=c,b.exports=c},{"../error.js":3}],8:[function(a,b){function c(){}c.prototype={on:function(a,b,c){if(!e(this,"on",a,[b,c])||!b)return this;this._events||(this._events={});var d=this._events[a]||(this._events[a]=[]);return d.push({callback:b,context:c,ctx:c||this}),this},once:function(a,b,c){if(!e(this,"once",a,[b,c])||!b)return this;var d=this,f=_.once(function(){d.off(a,f),b.apply(this,arguments)});return f._callback=b,this.on(a,f,c)},off:function(a,b,c){var d,f,g,h,i,j,k,l;if(!this._events||!e(this,"off",a,[b,c]))return this;if(!a&&!b&&!c)return this._events={},this;for(h=a?[a]:_.keys(this._events),i=0,j=h.length;j>i;i++)if(a=h[i],g=this._events[a]){if(this._events[a]=d=[],b||c)for(k=0,l=g.length;l>k;k++)f=g[k],(b&&b!==f.callback&&b!==f.callback._callback||c&&c!==f.context)&&d.push(f);d.length||delete this._events[a]}return this},trigger:function(a){if(!this._events)return this;var b=Array.prototype.slice.call(arguments,1);if(!e(this,"trigger",a,b))return this;var c=this._events[a],d=this._events.all;return c&&f(c,b),d&&f(d,arguments),this},stopListening:function(a,b,c){var d=this._listeningTo;if(!d)return this;var e=!b&&!c;c||"object"!=typeof b||(c=this),a&&((d={})[a._listenId]=a);for(var f in d)a=d[f],a.off(b,c,this),(e||_.isEmpty(a._events))&&delete this._listeningTo[f];return this}};var d=/\s+/,e=function(a,b,c,e){if(!c)return!0;if("object"==typeof c){for(var f in c)a[b].apply(a,[f,c[f]].concat(e));return!1}if(d.test(c)){for(var g=c.split(d),h=0,i=g.length;i>h;h++)a[b].apply(a,[g[h]].concat(e));return!1}return!0},f=function(a,b){var c,d=-1,e=a.length,f=b[0],g=b[1],h=b[2];switch(b.length){case 0:for(;++d<e;)(c=a[d]).callback.call(c.ctx);return;case 1:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f);return;case 2:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g);return;case 3:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g,h);return;default:for(;++d<e;)(c=a[d]).callback.apply(c.ctx,b)}},g={listenTo:"on",listenToOnce:"once"};_.each(g,function(a,b){c[b]=function(b,c,d){var e=this._listeningTo||(this._listeningTo={}),f=b._listenId||(b._listenId=_.uniqueId("l"));return e[f]=b,d||"object"!=typeof c||(d=this),b[a](c,d,this),this}}),b.exports=c},{}],9:[function(a,b){"use strict";function c(){this.collectionNames=[]}var d=a("./collection"),e=a("./schema"),f=a("./schematype"),g=a("./virtualtype"),h=a("./types"),i=a("./document"),j=a("./utils");c.prototype.createCollection=function(a,b,c){if(this[a])return console.info("storage::collection: `"+a+"` already exist"),this[a];if("Schema"!==j.getFunctionName(b.constructor))throw new TypeError("`schema` must be Schema instance");return this.collectionNames.push(a),this[a]=new d(a,b,c)},c.prototype.getCollectionNames=function(){return this.collectionNames},c.prototype.Collection=d,c.prototype.Schema=e,c.prototype.SchemaType=f,c.prototype.SchemaTypes=e.Types,c.prototype.VirtualType=g,c.prototype.Types=h,c.prototype.Document=i,c.prototype.Error=a("./error"),c.prototype.StateMachine=a("./statemachine"),c.prototype.utils=j,c.prototype.ObjectId=h.ObjectId,c.prototype.schemas=e.schemas,c.prototype.setAdapter=function(a){i.prototype.adapterHooks=a},b.exports=new c},{"./collection":1,"./document":2,"./error":3,"./schema":12,"./schematype":22,"./statemachine":23,"./types":27,"./utils":29,"./virtualtype":30}],10:[function(a,b){function c(){this.strictMode=void 0,this.selected=void 0,this.saveError=void 0,this.validationError=void 0,this.adhocPaths=void 0,this.removing=void 0,this.inserting=void 0,this.version=void 0,this.getters={},this._id=void 0,this.populate=void 0,this.populated=void 0,this.wasPopulated=!1,this.scope=void 0,this.activePaths=new e,this.ownerDocument=void 0,this.fullPath=void 0}var d=a("./statemachine"),e=d.ctor("require","modify","init","default");b.exports=c},{"./statemachine":23}],11:[function(a,b,c){function d(a){return a}c.get=function(a,b,e,f){var g;"function"==typeof e&&(e.length<2?(f=e,e=void 0):(g=e,e=void 0)),f||(f=d);var h="string"==typeof a?a.split("."):a;if(!Array.isArray(h))throw new TypeError("Invalid `path`. Must be either string or array");for(var i,j=b,k=0;k<h.length;++k){if(i=h[k],Array.isArray(j)&&!/^\d+$/.test(i)){var l=h.slice(k);return j.map(function(a){return a?c.get(l,a,e||g,f):f(void 0)})}if(j=g?g(j,i):e&&j[e]?j[e][i]:j[i],!j)return f(j)}return f(j)},c.set=function(a,b,e,f,g,h){var i;"function"==typeof f&&(f.length<2?(g=f,f=void 0):(i=f,f=void 0)),g||(g=d);var j="string"==typeof a?a.split("."):a;if(!Array.isArray(j))throw new TypeError("Invalid `path`. Must be either string or array");if(null!=e){for(var k,l=h||/\$/.test(a),m=e,n=0,o=j.length-1;o>n;++n)if(k=j[n],"$"!=k){if(Array.isArray(m)&&!/^\d+$/.test(k)){var p=j.slice(n);if(!l&&Array.isArray(b))for(var q=0;q<m.length&&q<b.length;++q)c.set(p,b[q],m[q],f||i,g,l);else for(var q=0;q<m.length;++q)c.set(p,b,m[q],f||i,g,l);return}if(m=i?i(m,k):f&&m[f]?m[f][k]:m[k],!m)return}else if(n==o-1)break;if(k=j[o],f&&m[f]&&(m=m[f]),Array.isArray(m)&&!/^\d+$/.test(k))if(!l&&Array.isArray(b))for(var r,q=0;q<m.length&&q<b.length;++q)r=m[q],r&&(i?i(r,k,g(b[q])):(r[f]&&(r=r[f]),r[k]=g(b[q])));else for(var q=0;q<m.length;++q)r=m[q],r&&(i?i(r,k,g(b)):(r[f]&&(r=r[f]),r[k]=g(b)));else i?i(m,k,g(b)):m[k]=g(b)}}},{}],12:[function(a,b){function c(a,b,e,f){if(!(this instanceof c))return new c(a,b,e,f);"string"==typeof a?(this.name=a,g[a]=this):(f=e,e=b,b=a,a=void 0),b instanceof c||(f=e,e=b,b=void 0),this.source=e,this.paths={},this.subpaths={},this.virtuals={},this.nested={},this.inherits={},this.callQueue=[],this.methods={},this.statics={},this.tree={},this._requiredpaths=void 0,this.discriminatorMapping=void 0,this.options=this.defaultOptions(f),b instanceof c&&b.discriminator(a,this),e&&this.add(e);var h=!this.paths._id&&!this.options.noId&&this.options._id;h&&this.add({_id:{type:c.ObjectId,auto:!0}});var i=!this.paths.id&&this.options.id;i&&this.virtual("id").get(d)}function d(){return this.$__._id?this.$__._id:this.$__._id=null==this._id?null:String(this._id)}function e(a,b){var c=b.split(/\.(\d+)\.|\.(\d+)$/).filter(Boolean);if(c.length<2)return a.paths[c[0]];var d=a.path(c[0]);if(!d)return d;for(var e,g=c.length-1,h=1;h<c.length;++h){if(e=c[h],h===g&&d&&!d.schema&&!/\D/.test(e)){d=d instanceof f.Array?d.caster:void 0;break}if(/\D/.test(e)){if(!d||!d.schema){d=void 0;break}d=d.schema.path(e)}}return a.subpaths[b]=d}var f,g,h=a("./events"),i=a("./virtualtype"),j=a("./utils");c.prototype=Object.create(h.prototype),c.prototype.constructor=c,c.prototype.paths,c.prototype.tree,c.prototype.defaultOptions=function(a){return a=$.extend({strict:!0,versionKey:"__v",discriminatorKey:"__t",minimize:!0,_id:!0,id:!0},a)},c.prototype.add=function(a,b){b=b||"";for(var c=Object.keys(a),d=0;d<c.length;++d){var e=c[d];if(null==a[e])throw new TypeError("Invalid value for schema path `"+b+e+"`");!_.isPlainObject(a[e])||a[e].constructor&&"Object"!=j.getFunctionName(a[e].constructor)||a[e].type&&!a[e].type.type?this.path(b+e,a[e]):Object.keys(a[e]).length?(this.nested[b+e]=!0,this.add(a[e],b+e+".")):this.path(b+e,a[e])}},c.reserved=Object.create(null);var k=c.reserved;k.on=k.db=k.get=k.set=k.init=k.isNew=k.errors=k.schema=k.options=k.modelName=k.collection=k.toObject=k.domain=k.emit=k._events=k._pres=k._posts=1,c.prototype.path=function(a,b){if(void 0==b)return this.paths[a]?this.paths[a]:this.subpaths[a]?this.subpaths[a]:/\.\d+\.?.*$/.test(a)?e(this,a):void 0;if(k[a])throw new Error("`"+a+"` may not be used as a schema pathname");var d=a.split(/\./),f=d.pop(),g=this.tree;return d.forEach(function(b,c){if(g[b]||(g[b]={}),"object"!=typeof g[b]){var e="Cannot set nested path `"+a+"`. Parent path `"+d.slice(0,c).concat([b]).join(".")+"` already set to type "+g[b].name+".";throw new Error(e)}g=g[b]}),g[f]=j.clone(b),this.paths[a]=c.interpretAsType(a,b),this},c.interpretAsType=function(a,b){var d=j.getFunctionName(b.constructor);"Object"!=d&&(b={type:b});var e=b.type&&!b.type.type?b.type:{};if("Object"==j.getFunctionName(e.constructor)||"mixed"==e)return new f.Mixed(a,b);if(Array.isArray(e)||Array==e||"array"==e){var g=Array==e||"array"==e?b.cast:e[0];if(g instanceof c)return new f.DocumentArray(a,g,b);if("string"==typeof g)g=f[g.charAt(0).toUpperCase()+g.substring(1)];else if(g&&(!g.type||g.type.type)&&"Object"==j.getFunctionName(g.constructor)&&Object.keys(g).length)return new f.DocumentArray(a,new c(g),b);return new f.Array(a,g||f.Mixed,b)}var h="string"==typeof e?e:j.getFunctionName(e);if(h&&(h=h.charAt(0).toUpperCase()+h.substring(1)),void 0==f[h])throw new TypeError("Undefined type at `"+a+"`\n  Did you try nesting Schemas? You can only nest using refs or arrays.");return new f[h](a,b)},c.prototype.eachPath=function(a){for(var b=Object.keys(this.paths),c=b.length,d=0;c>d;++d)a(b[d],this.paths[b[d]]);return this},c.prototype.requiredPaths=function(){if(this._requiredpaths)return this._requiredpaths;for(var a=Object.keys(this.paths),b=a.length,c=[];b--;){var d=a[b];this.paths[d].isRequired&&c.push(d)}return this._requiredpaths=c},c.prototype.pathType=function(a){return a in this.paths?"real":a in this.virtuals?"virtual":a in this.nested?"nested":a in this.subpaths?"real":/\.\d+\.|\.\d+$/.test(a)&&e(this,a)?"real":"adhocOrUndefined"},c.prototype.queue=function(a,b){return this.callQueue.push([a,b]),this},c.prototype.pre=function(){return this.queue("pre",arguments)},c.prototype.post=function(){return this.queue("on",arguments)},c.prototype.plugin=function(a,b){return a(this,b),this},c.prototype.method=function(a,b){if("string"!=typeof a)for(var c in a)this.methods[c]=a[c];else this.methods[a]=b;return this},c.prototype.static=function(a,b){if("string"!=typeof a)for(var c in a)this.statics[c]=a[c];else this.statics[a]=b;return this},c.prototype.set=function(a,b){return 1===arguments.length?this.options[a]:(this.options[a]=b,this)},c.prototype.get=function(a){return this.options[a]},c.prototype.virtual=function(a,b){var c=this.virtuals,d=a.split(".");return c[a]=d.reduce(function(c,e,f){return c[e]||(c[e]=f===d.length-1?new i(b,a):{}),c[e]},this.tree)},c.prototype.virtualpath=function(a){return this.virtuals[a]},c.discriminators,c.prototype.discriminator=function(a,b){if(!(b instanceof c))throw new Error("You must pass a valid discriminator Schema");if(this.discriminatorMapping&&!this.discriminatorMapping.isRoot)throw new Error('Discriminator "'+a+'" can only be a discriminator of the root model');var d=this.options.discriminatorKey;if(b.path(d))throw new Error('Discriminator "'+a+'" cannot have field with name "'+d+'"');if(function(b,c){j.merge(b,c);var e={};e[d]={type:String,"default":a},b.add(e),b.discriminatorMapping={key:d,value:a,isRoot:!1},c.options.collection&&(b.options.collection=c.options.collection),function(a,b){if(a=j.clone(a),b=j.clone(b),delete a.toJSON,delete a.toObject,delete b.toJSON,delete b.toObject,!j.deepEqual(a,b))throw new Error("Discriminator options are not customizable (except toJSON & toObject)")}(b.options,c.options);var f=b.options.toJSON,g=b.options.toObject;b.options=j.clone(c.options),f&&(b.options.toJSON=f),g&&(b.options.toObject=g),b.callQueue=c.callQueue.concat(b.callQueue),b._requiredpaths=void 0}(b,this),this.discriminators||(this.discriminators={}),this.discriminatorMapping||(this.discriminatorMapping={key:d,value:null,isRoot:!0}),this.discriminators[a])throw new Error('Discriminator with name "'+a+'" already exists');this.discriminators[a]=b},b.exports=c,window.Schema=c,c.Types=a("./schema/index"),c.schemas=g={},f=c.Types;c.ObjectId=f.ObjectId},{"./events":8,"./schema/index":17,"./utils":29,"./virtualtype":30}],13:[function(a,b){function c(b,c,f){if(c){var k={};"Object"===j.getFunctionName(c.constructor)&&(c.type?(k=_.clone(c),delete k.type,c=c.type):c=i);var l="string"==typeof c?c:j.getFunctionName(c),m=l in g?g[l]:c;this.casterConstructor=m,this.caster=new m(null,k),d||(d=a("../types/embedded")),this.caster instanceof d||(this.caster.path=b)}e.call(this,b,f);var n,o,p=this;this.defaultValue&&(n=this.defaultValue,o="function"==typeof n),this.default(function(){var a=o?n():n||[];return new h(a,p.path,this)})}var d,e=a("../schematype"),f=e.CastError,g={Boolean:a("./boolean"),Date:a("./date"),Number:a("./number"),String:a("./string"),ObjectId:a("./objectid")},h=a("../types/array"),i=a("./mixed"),j=a("../utils");c.prototype=Object.create(e.prototype),c.prototype.constructor=c,c.prototype.checkRequired=function(a){return!(!a||!a.length)},c.prototype.applyGetters=function(a,b){return this.caster.options&&this.caster.options.ref?a:e.prototype.applyGetters.call(this,a,b)},c.prototype.cast=function(a,b,c){if(Array.isArray(a)){if(a.isStorageArray||(a=new h(a,this.path,b)),this.caster)try{for(var d=0,e=a.length;e>d;d++)a[d]=this.caster.cast(a[d],b,c)}catch(g){throw new f(g.type,a,this.path)}return a}return this.cast([a],b,c)},b.exports=c},{"../schematype":22,"../types/array":24,"../types/embedded":26,"../utils":29,"./boolean":14,"./date":15,"./mixed":18,"./number":19,"./objectid":20,"./string":21}],14:[function(a,b){function c(a,b){d.call(this,a,b)}var d=a("../schematype");c.prototype=Object.create(d.prototype),c.prototype.constructor=c,c.prototype.checkRequired=function(a){return a===!0||a===!1},c.prototype.cast=function(a){return null===a?a:"0"===a?!1:"true"===a?!0:"false"===a?!1:!!a},b.exports=c},{"../schematype":22}],15:[function(a,b){function c(a,b){d.call(this,a,b)}var d=a("../schematype"),e=d.CastError;c.prototype=Object.create(d.prototype),c.prototype.constructor=c,c.prototype.checkRequired=function(a){return a instanceof Date},c.prototype.cast=function(a){if(null===a||""===a)return null;if(a instanceof Date)return a;var b;if(a instanceof Number||"number"==typeof a||String(a)==Number(a)?b=new Date(Number(a)):a.toString&&(b=new Date(a.toString())),"Invalid Date"!=b.toString())return b;throw new e("date",a,this.path)
},b.exports=c},{"../schematype":22}],16:[function(a,b){function c(a,b,c){function d(){h.apply(this,arguments)}d.prototype=Object.create(h.prototype),d.prototype.constructor=d,d.prototype.$__setSchema(b);for(var e in b.methods)d.prototype[e]=b.methods[e];for(var e in b.statics)d[e]=b.statics[e];d.options=c,this.schema=b,f.call(this,a,d,c),this.schema=b;var i=this.path,j=this.defaultValue;this.default(function(){var a=j.call(this);return Array.isArray(a)||(a=[a]),new g(a,i,this)})}function d(a,b,c){if(!c||!b)return void 0;for(var d,e,f=a.path+".",g=Object.keys(b),h=g.length,i={};h--;)e=g[h],0===e.indexOf(f)&&(d||(d=!0),i[e.substring(f.length)]=b[e]);return d&&i||void 0}{var e=a("../schematype"),f=a("./array"),g=a("../types/documentarray"),h=a("../types/embedded");a("../document")}c.prototype=Object.create(f.prototype),c.prototype.constructor=c,c.prototype.doValidate=function(a,b,c){var d=this;e.prototype.doValidate.call(this,a,function(c){if(c)return b(c);var e,f=a&&a.length;if(!f)return b();for(var g=0,h=f;h>g;++g){var i=a[g];i?!function(a){i.validate(function(c){return c&&!e?(c.key=d.key+"."+a+"."+c.key,b(e=c)):void(--f||b())})}(g):--f||b()}},c)},c.prototype.cast=function(a,b,c,e){var f,i,j;if(!Array.isArray(a))return this.cast([a],b,c,e);if(!a.isStorageDocumentArray&&(a=new g(a,this.path,b),e&&e._handlers))for(var k in e._handlers)b.off(k,e._handlers[k]);for(j=a.length;j--;)if(!(a[j]instanceof h)&&a[j])if(c)f||(f=d(this,b.$__.selected,c)),i=new this.casterConstructor(null,a,!0,f),a[j]=i.init(a[j]);else{try{i=e.id(a[j]._id)}catch(l){}e&&i?i.set(a[j]):i=new this.casterConstructor(a[j],a),a[j]=i}return a},b.exports=c},{"../document":2,"../schematype":22,"../types/documentarray":25,"../types/embedded":26,"./array":13}],17:[function(a,b,c){c.String=a("./string"),c.Number=a("./number"),c.Boolean=a("./boolean"),c.DocumentArray=a("./documentarray"),c.Array=a("./array"),c.Date=a("./date"),c.ObjectId=a("./objectid"),c.Mixed=a("./mixed"),c.Oid=c.ObjectId,c.Object=c.Mixed,c.Bool=c.Boolean},{"./array":13,"./boolean":14,"./date":15,"./documentarray":16,"./mixed":18,"./number":19,"./objectid":20,"./string":21}],18:[function(a,b){function c(a,b){if(b&&b.default){var c=b.default;Array.isArray(c)&&0===c.length?b.default=Array:!b.shared&&_.isPlainObject(c)&&0===Object.keys(c).length&&(b.default=function(){return{}})}d.call(this,a,b)}var d=a("../schematype");c.prototype=Object.create(d.prototype),c.prototype.constructor=c,c.prototype.checkRequired=function(a){return void 0!==a&&null!==a},c.prototype.cast=function(a){return a},b.exports=c},{"../schematype":22}],19:[function(a,b){function c(a,b){d.call(this,a,b,"Number")}var d=a("../schematype"),e=d.CastError,f=a("../error").messages;c.prototype=Object.create(d.prototype),c.prototype.constructor=c,c.prototype.checkRequired=function(a){return d._isRef(this,a)?null!=a:"number"==typeof a||a instanceof Number},c.prototype.min=function(a,b){if(this.minValidator&&(this.validators=this.validators.filter(function(a){return a[0]!=this.minValidator},this)),null!=a){var c=b||f.Number.min;c=c.replace(/{MIN}/,a),this.validators.push([this.minValidator=function(b){return null===b||b>=a},c,"min"])}return this},c.prototype.max=function(a,b){if(this.maxValidator&&(this.validators=this.validators.filter(function(a){return a[0]!=this.maxValidator},this)),null!=a){var c=b||f.Number.max;c=c.replace(/{MAX}/,a),this.validators.push([this.maxValidator=function(b){return null===b||a>=b},c,"max"])}return this},c.prototype.cast=function(a){var b=a&&a._id?a._id:a;if(!isNaN(b)){if(null===b)return b;if(""===b)return null;if("string"==typeof b&&(b=Number(b)),b instanceof Number)return b;if("number"==typeof b)return b;if(b.toString&&!Array.isArray(b)&&b.toString()==Number(b))return new Number(b)}throw new e("number",a,this.path)},b.exports=c},{"../error":3,"../schematype":22}],20:[function(a,b){function c(a,b){g.call(this,a,b,"ObjectId")}function d(){return new i}function e(a){return this.$__._id=null,a}{var f,g=a("../schematype"),h=g.CastError,i=a("../types/objectid");a("../utils")}c.prototype=Object.create(g.prototype),c.prototype.constructor=c,c.prototype.auto=function(a){return a&&(this.default(d),this.set(e)),this},c.prototype.checkRequired=function(a){return g._isRef(this,a)?null!=a:a instanceof i},c.prototype.cast=function(b){if(g._isRef(this,b)){if(null==b)return b;if(f||(f=a("./../document")),b instanceof f)return b.$__.wasPopulated=!0,b;if(b instanceof i)return b;if(!_.isPlainObject(b))throw new h("ObjectId",b,this.path);var c=this.options.ref;if(!c)throw new TypeError("При ссылке (ref) на документ нужно указывать схему, по которой этот документ создавать");if(!storage.schemas[c])throw new TypeError('При ссылке (ref) на документ нужно указывать название схемы на которую ссылаемся при её создании ( new Schema("name", schemaObject) )');var d=new f(b,void 0,storage.schemas[c]);return d.$__.wasPopulated=!0,d}if(null===b)return b;if(b instanceof i)return b;if(b._id&&b._id instanceof i)return b._id;if(b.toString)try{return new i(b.toString())}catch(e){throw new h("ObjectId",b,this.path)}throw new h("ObjectId",b,this.path)},b.exports=c},{"../schematype":22,"../types/objectid":28,"../utils":29,"./../document":2}],21:[function(a,b){function c(a,b){this.enumValues=[],this.regExp=null,d.call(this,a,b,"String")}var d=a("../schematype"),e=d.CastError,f=a("../error").messages;c.prototype=Object.create(d.prototype),c.prototype.constructor=c,c.prototype.enum=function(){if(this.enumValidator&&(this.validators=this.validators.filter(function(a){return a[0]!=this.enumValidator},this),this.enumValidator=!1),void 0===arguments[0]||!1===arguments[0])return this;var a,b;_.isPlainObject(arguments[0])?(a=arguments[0].values,b=arguments[0].message):(a=arguments,b=f.String.enum);for(var c=0;c<a.length;c++)void 0!==a[c]&&this.enumValues.push(this.cast(a[c]));var d=this.enumValues;return this.enumValidator=function(a){return void 0===a||~d.indexOf(a)},this.validators.push([this.enumValidator,b,"enum"]),this},c.prototype.lowercase=function(){return this.set(function(a,b){return"string"!=typeof a&&(a=b.cast(a)),a?a.toLowerCase():a})},c.prototype.uppercase=function(){return this.set(function(a,b){return"string"!=typeof a&&(a=b.cast(a)),a?a.toUpperCase():a})},c.prototype.trim=function(){return this.set(function(a,b){return"string"!=typeof a&&(a=b.cast(a)),a?a.trim():a})},c.prototype.match=function(a,b){function c(b){return null!=b&&""!==b?a.test(b):!0}var d=b||f.String.match;return this.validators.push([c,d,"regexp"]),this},c.prototype.checkRequired=function(a,b){return d._isRef(this,a,b,!0)?null!=a:(a instanceof String||"string"==typeof a)&&a.length},c.prototype.cast=function(a){if(null===a)return a;if("undefined"!=typeof a){if(a._id&&"string"==typeof a._id)return a._id;if(a.toString)return a.toString()}throw new e("string",a,this.path)},b.exports=c},{"../error":3,"../schematype":22}],22:[function(a,b){function c(a,b,c){this.path=a,this.instance=c,this.validators=[],this.setters=[],this.getters=[],this.options=b;for(var d in b)if(this[d]&&"function"==typeof this[d]){var e=Array.isArray(b[d])?b[d]:[b[d]];this[d].apply(this,e)}}var d=a("./error"),e=a("./utils"),f=d.messages,g=d.CastError,h=d.ValidatorError;c.prototype.default=function(a){return 1===arguments.length?(this.defaultValue="function"==typeof a?a:this.cast(a),this):(arguments.length>1&&(this.defaultValue=_.toArray(arguments)),this.defaultValue)},c.prototype.set=function(a){if("function"!=typeof a)throw new TypeError("A setter must be a function.");return this.setters.push(a),this},c.prototype.get=function(a){if("function"!=typeof a)throw new TypeError("A getter must be a function.");return this.getters.push(a),this},c.prototype.validate=function(a,b,c){if("function"==typeof a||a&&"RegExp"===e.getFunctionName(a.constructor))return b||(b=f.general.default),c||(c="user defined"),this.validators.push([a,b,c]),this;for(var d,g=arguments.length;g--;){if(d=arguments[g],!d||"Object"!=e.getFunctionName(d.constructor)){var h="Invalid validator. Received ("+typeof d+") "+d+". See http://mongoosejs.com/docs/api.html#schematype_SchemaType-validate";throw new Error(h)}this.validate(d.validator,d.msg,d.type)}return this},c.prototype.required=function(a,b){if(!1===a)return this.validators=this.validators.filter(function(a){return a[0]!=this.requiredValidator},this),this.isRequired=!1,this;var c=this;this.isRequired=!0,this.requiredValidator=function(a){return void 0!==this&&"isSelected"in this&&!this.isSelected(c.path)&&!this.isModified(c.path)?!0:c.checkRequired(a,this)},"string"==typeof a&&(b=a,a=void 0);var d=b||f.general.required;return this.validators.push([this.requiredValidator,d,"required"]),this},c.prototype.getDefault=function(a,b){var c="function"==typeof this.defaultValue?this.defaultValue.call(a):this.defaultValue;return null!==c&&void 0!==c?this.cast(c,a,b):c},c.prototype.applySetters=function(a,b,d,e){if(c._isRef(this,a))return d?a:this.cast(a,b,d,e);var f=a,g=this.setters,h=g.length,i=this.caster;if(Array.isArray(f)&&i&&i.setters)for(var j=0;j<f.length;j++)f[j]=i.applySetters(f[j],b,d,e);if(!h)return null===f||void 0===f?f:this.cast(f,b,d,e);for(;h--;)f=g[h].call(b,f,this);return null===f||void 0===f?f:f=this.cast(f,b,d,e)},c.prototype.applyGetters=function(a,b){if(c._isRef(this,a))return a;var d=a,e=this.getters,f=e.length;if(!f)return d;for(;f--;)d=e[f].call(b,d,this);return d},c.prototype.doValidate=function(a,b,c){function d(a,c,d,i){e||(void 0===a||a?--g||b(null):b(e=new h(f,c,d,i)))}var e=!1,f=this.path,g=this.validators.length;return g?void this.validators.forEach(function(b){var e=b[0],f=b[1],g=b[2];e instanceof RegExp?d(e.test(a),f,g,a):"function"==typeof e&&(2===e.length?e.call(c,a,function(b){d(b,f,g,a)}):d(e.call(c,a),f,g,a))}):b(null)},c._isRef=function(a,b){var c=a.options&&a.options.ref;if(c){if(null==b)return!0;if(_.isObject(b))return!0}return!1},b.exports=c,c.CastError=g,c.ValidatorError=h},{"./error":3,"./utils":29}],23:[function(a,b){var c=b.exports=function(){this.paths={},this.states={}};c.ctor=function(){var a=_.toArray(arguments),b=function(){c.apply(this,arguments),this.stateNames=a;for(var b,d=a.length;d--;)b=a[d],this.states[b]={}};return b.prototype=Object.create(c.prototype),b.prototype.constructor=b,a.forEach(function(a){b.prototype[a]=function(b){this._changeState(b,a)}}),b},c.prototype._changeState=function(a,b){var c=this.states[this.paths[a]];c&&delete c[a],this.paths[a]=b,this.states[b][a]=!0},c.prototype.clear=function(a){for(var b,c=Object.keys(this.states[a]),d=c.length;d--;)b=c[d],delete this.states[a][b],delete this.paths[b]},c.prototype.some=function(){var a=this,b=arguments.length?arguments:this.stateNames;return Array.prototype.some.call(b,function(b){return Object.keys(a.states[b]).length})},c.prototype._iter=function(a){return function(){var b=arguments.length,c=_.toArray(arguments).slice(0,b-1),d=arguments[b-1];c.length||(c=this.stateNames);var e=this,f=c.reduce(function(a,b){return a.concat(Object.keys(e.states[b]))},[]);return f[a](function(a,b,c){return d(a,b,c)})}},c.prototype.forEach=function(){return this.forEach=this._iter("forEach"),this.forEach.apply(this,arguments)},c.prototype.map=function(){return this.map=this._iter("map"),this.map.apply(this,arguments)}},{}],24:[function(a,b){function c(a,b,d){var e=[];return e.push.apply(e,a),_.mixin(e,c.mixin),e.validators=[],e._path=b,e.isStorageArray=!0,d&&(e._parent=d,e._schema=d.schema.path(b)),e}{var d=a("./embedded"),e=a("../document"),f=a("./objectid");a("../utils")}c.mixin={_parent:void 0,_cast:function(a){var b=this._owner,c=!1;if(this._parent&&(b||(b=this._owner=this._parent.ownerDocument?this._parent.ownerDocument():this._parent),c=b.populated(this._path,!0)),c&&null!=a){var d=c.options.model;return(a instanceof f||!_.isObject(a))&&(a={_id:a}),a=new d(a),this._schema.caster.cast(a,this._parent,!0)}return this._schema.caster.cast(a,this._parent,!1)},_markModified:function(a,b){var c,d=this._parent;return d&&(c=this._path,arguments.length&&(c=null!=b?c+"."+this.indexOf(a)+"."+b:c+"."+a),d.markModified(c)),this},push:function(){var a=[].map.call(arguments,this._cast,this),b=[].push.apply(this,a);return this._markModified(),b},pop:function(){var a=[].pop.call(this);return this._markModified(),a},shift:function(){var a=[].shift.call(this);return this._markModified(),a},pull:function(){for(var a,b=[].map.call(arguments,this._cast,this),c=this._parent.get(this._path),e=c.length;e--;)a=c[e],a instanceof d?b.some(function(b){return b.equals(a)})&&[].splice.call(c,e,1):~c.indexOf.call(b,a)&&[].splice.call(c,e,1);return this._markModified(),this},splice:function(){var a,b,c;if(arguments.length){for(b=[],c=0;c<arguments.length;++c)b[c]=2>c?arguments[c]:this._cast(arguments[c]);a=[].splice.apply(this,b),this._markModified()}return a},unshift:function(){var a=[].map.call(arguments,this._cast,this);return[].unshift.apply(this,a),this._markModified(),this.length},sort:function(){var a=[].sort.apply(this,arguments);return this._markModified(),a},addToSet:function(){var a=[].map.call(arguments,this._cast,this),b=[],c=a[0]instanceof d?"doc":a[0]instanceof Date?"date":"";return a.forEach(function(a){var d;switch(c){case"doc":d=this.some(function(b){return b.equals(a)});break;case"date":var e=+a;d=this.some(function(a){return+a===e});break;default:d=~this.indexOf(a)}d||([].push.call(this,a),this._markModified(),[].push.call(b,a))},this),b},set:function(a,b){return this[a]=this._cast(b),this._markModified(a),this},toObject:function(a){return a&&a.depopulate?this.map(function(b){return b instanceof e?b.toObject(a):b}):this.slice()},indexOf:function(a){a instanceof f&&(a=a.toString());for(var b=0,c=this.length;c>b;++b)if(a==this[b])return b;return-1}},c.mixin.remove=c.mixin.pull,b.exports=c},{"../document":2,"../utils":29,"./embedded":26,"./objectid":28}],25:[function(a,b){function c(a,b,d){var e=[];return e.push.apply(e,a),_.mixin(e,c.mixin),e.validators=[],e._path=b,e.isStorageArray=!0,e.isStorageDocumentArray=!0,d&&(e._parent=d,e._schema=d.schema.path(b),e._handlers={isNew:e.notify("isNew"),save:e.notify("save")},d.on("save",e._handlers.save),d.on("isNew",e._handlers.isNew)),e}var d=a("./array"),e=a("./objectid"),f=a("../schema/objectid"),g=(a("../utils"),a("../document"));c.mixin=Object.create(d.mixin),c.mixin._cast=function(a){return a instanceof this._schema.casterConstructor?(a.__parent&&a.__parentArray||(a.__parent=this._parent,a.__parentArray=this),a):((a instanceof e||!_.isObject(a))&&(a={_id:a}),new this._schema.casterConstructor(a,this))},c.mixin.id=function(a){var b,c,d;try{var h=f.prototype.cast.call({},a);h&&(b=String(h))}catch(i){b=null}for(var j=0,k=this.length;k>j;j++)if(d=this[j].get("_id"),d instanceof g){if(c||(c=String(a)),c==d._id)return this[j]}else if(d instanceof e){if(b==d)return this[j]}else if(c||(c=String(a)),c==d)return this[j];return null},c.mixin.toObject=function(a){return this.map(function(b){return b&&b.toObject(a)||null})},c.mixin.create=function(a){return new this._schema.casterConstructor(a)},c.mixin.notify=function(a){var b=this;return function(c){for(var d=b.length;d--;)b[d]&&b[d].trigger(a,c)}},b.exports=c},{"../document":2,"../schema/objectid":20,"../utils":29,"./array":24,"./objectid":28}],26:[function(a,b){function c(a,b){b?(this.__parentArray=b,this.__parent=b._parent):(this.__parentArray=void 0,this.__parent=void 0),d.call(this,a,void 0);var c=this;this.on("isNew",function(a){c.isNew=a})}var d=a("../document");c.prototype=Object.create(d.prototype),c.prototype.constructor=c,c.prototype.markModified=function(a){this.__parentArray&&(this.$__.activePaths.modify(a),this.isNew?this.__parentArray._markModified():this.__parentArray._markModified(this,a))},c.prototype.save=function(a){var b=$.Deferred().done(a);return b.resolve(),b},c.prototype.remove=function(a){if(!this.__parentArray)return this;var b;if(!this.willRemove){if(b=this._doc._id,!b)throw new Error("For your own good, Mongoose does not know how to remove an EmbeddedDocument that has no _id");this.__parentArray.pull({_id:b}),this.willRemove=!0}return a&&a(null),this},c.prototype.update=function(){throw new Error("The #update method is not available on EmbeddedDocuments")},c.prototype.invalidate=function(a,b,c,d){if(!this.__parent){var e="Unable to invalidate a subdocument that has not been added to an array.";throw new Error(e)}var f=this.__parentArray.indexOf(this),g=this.__parentArray._path,h=[g,f,a].join(".");return 2<arguments.length?this.__parent.invalidate(h,b,c):this.__parent.invalidate(h,b),d&&(this.$__.validationError=this.ownerDocument().$__.validationError),!0},c.prototype.ownerDocument=function(){if(this.$__.ownerDocument)return this.$__.ownerDocument;var a=this.__parent;if(!a)return this;for(;a.__parent;)a=a.__parent;return this.$__.ownerDocument=a},c.prototype.$__fullPath=function(a){if(!this.$__.fullPath){var b=this;if(!b.__parent)return a;for(var c=[];b.__parent;)c.unshift(b.__parentArray._path),b=b.__parent;this.$__.fullPath=c.join("."),this.$__.ownerDocument||(this.$__.ownerDocument=b)}return a?this.$__.fullPath+"."+a:this.$__.fullPath},c.prototype.parent=function(){return this.__parent},c.prototype.parentArray=function(){return this.__parentArray},b.exports=c},{"../document":2}],27:[function(a,b,c){c.Array=a("./array"),c.Embedded=a("./embedded"),c.DocumentArray=a("./documentarray"),c.ObjectId=a("./objectid")},{"./array":24,"./documentarray":25,"./embedded":26,"./objectid":28}],28:[function(a,b){function c(a){if(!(this instanceof c))return new c(a);if(null!=a&&"string"!=typeof a&&24!=a.length)throw new Error("Argument passed in must be a string of 24 hex characters");if(null==a)this.id=this.generate();else{if(!d.test(a))throw new Error("Value passed in is not a valid 24 character hex string");this.id=a}}var d=new RegExp("^[0-9a-fA-F]{24}$");c.prototype.CHARS="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),c.prototype.generate=function(){for(var a,b=this.CHARS,c=new Array(36),d=0,e=0;24>e;e++)2>=d&&(d=33554432+16777216*Math.random()|0),a=15&d,d>>=4,c[e]=b[19==e?3&a|8:a];return c.join("").toLowerCase()},c.prototype.toHexString=function(){return this.id},c.prototype.toString=function(){return this.toHexString()},c.prototype.toJSON=function(){return this.toHexString()},c.prototype.equals=function(a){var b=a instanceof c||a.toHexString?a.id:new c(a).id;return this.id===b},b.exports=c},{}],29:[function(a,b,c){(function(b,d){function e(a){return"object"==typeof a&&"[object RegExp]"==o.call(a)}function f(a){if(!e(a))throw new TypeError("Not a RegExp");var b=[];return a.global&&b.push("g"),a.multiline&&b.push("m"),a.ignoreCase&&b.push("i"),new RegExp(a.source,b.join(""))}function g(a,b){var c,d,e,f,g,h=b&&b.retainKeyOrder,i=b&&b.minimize,j={};if(h)for(f in a)e=p(a[f],b),i&&"undefined"==typeof e||(c||(c=!0),j[f]=e);else for(d=Object.keys(a),g=d.length;g--;)f=d[g],e=p(a[f],b),i&&"undefined"==typeof e||(c||(c=!0),j[f]=e);return i?c&&j:j}function h(a,b){for(var c=[],d=0,e=a.length;e>d;d++)c.push(p(a[d],b));return c}function i(a){return a.name?a.name:(a.toString().trim().match(r)||[])[1]}var j,k=a("./types/objectid"),l=a("./mpath");c.pluralization=[[/(m)an$/gi,"$1en"],[/(pe)rson$/gi,"$1ople"],[/(child)$/gi,"$1ren"],[/^(ox)$/gi,"$1en"],[/(ax|test)is$/gi,"$1es"],[/(octop|vir)us$/gi,"$1i"],[/(alias|status)$/gi,"$1es"],[/(bu)s$/gi,"$1ses"],[/(buffal|tomat|potat)o$/gi,"$1oes"],[/([ti])um$/gi,"$1a"],[/sis$/gi,"ses"],[/(?:([^f])fe|([lr])f)$/gi,"$1$2ves"],[/(hive)$/gi,"$1s"],[/([^aeiouy]|qu)y$/gi,"$1ies"],[/(x|ch|ss|sh)$/gi,"$1es"],[/(matr|vert|ind)ix|ex$/gi,"$1ices"],[/([m|l])ouse$/gi,"$1ice"],[/(kn|w|l)ife$/gi,"$1ives"],[/(quiz)$/gi,"$1zes"],[/s$/gi,"s"],[/([^a-z])$/,"$1"],[/$/gi,"s"]];var m=c.pluralization;c.uncountables=["advice","energy","excretion","digestion","cooperation","health","justice","labour","machinery","equipment","information","pollution","sewage","paper","money","species","series","rain","rice","fish","sheep","moose","deer","news","expertise","status","media"];var n=c.uncountables;c.pluralize=function(a){var b;return!~n.indexOf(a.toLowerCase())&&(b=m.filter(function(b){return a.match(b[0])}),b[0])?a.replace(b[0][0],b[0][1]):a},c.deepEqual=function(a,b){return q(a)&&(a=a.toObject()),q(b)&&(b=b.toObject()),_.isEqual(a,b)};var o=Object.prototype.toString;c.clone=function(a,b){if(void 0===a||null===a)return a;if(_.isArray(a))return h(a,b);if(q(a))return b&&b.json&&"function"==typeof a.toJSON?a.toJSON(b):a.toObject(b);if(a.constructor)switch(i(a.constructor)){case"Object":return g(a,b);case"Date":return new a.constructor(+a);case"RegExp":return f(a)}return a instanceof k?new k(a.id):!a.constructor&&_.isObject(a)?g(a,b):a.valueOf?a.valueOf():void 0};var p=c.clone;c.merge=function s(a,b){for(var c,d=Object.keys(b),e=d.length;e--;)c=d[e],"undefined"==typeof a[c]?a[c]=b[c]:_.isObject(b[c])&&s(a[c],b[c])},c.random=function(){return Math.random().toString().substr(3)},c.isStorageObject=function(b){return j||(j=a("./document")),b instanceof j||b&&b.isStorageArray};var q=c.isStorageObject;c.getValue=function(a,b,c){return l.get(a,b,"_doc",c)},c.setValue=function(a,b,c,d){l.set(a,b,c,"_doc",d)};var r=/^function\s*([^\s(]+)/;c.getFunctionName=i,c.setImmediate=function(){function a(a){if(a.data==f){c=c.next;var b=c.func;delete c.func,b()}}if("object"==typeof d&&b.nextTick)return b.nextTick;if(window.setImmediate)return window.setImmediate;var c={},e=c,f=Math.random();return window.addEventListener?window.addEventListener("message",a,!1):window.attachEvent("onmessage",a),window.postMessage?function(a){e=e.next={func:a},window.postMessage(f,"*")}:function(a){setTimeout(a,0)}}()}).call(this,a("_process"),"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./document":2,"./mpath":11,"./types/objectid":28,_process:31}],30:[function(a,b){function c(a,b){this.path=b,this.getters=[],this.setters=[],this.options=a||{}}c.prototype.get=function(a){return this.getters.push(a),this},c.prototype.set=function(a){return this.setters.push(a),this},c.prototype.applyGetters=function(a,b){for(var c=a,d=this.getters.length-1;d>=0;d--)c=this.getters[d].call(b,c,this);return c},c.prototype.applySetters=function(a,b){for(var c=a,d=this.setters.length-1;d>=0;d--)c=this.setters[d].call(b,c,this);return c},b.exports=c},{}],31:[function(a,b){function c(){}var d=b.exports={};d.nextTick=function(){var a="undefined"!=typeof window&&window.setImmediate,b="undefined"!=typeof window&&window.postMessage&&window.addEventListener;if(a)return function(a){return window.setImmediate(a)};if(b){var c=[];return window.addEventListener("message",function(a){var b=a.source;if((b===window||null===b)&&"process-tick"===a.data&&(a.stopPropagation(),c.length>0)){var d=c.shift();d()}},!0),function(a){c.push(a),window.postMessage("process-tick","*")}}return function(a){setTimeout(a,0)}}(),d.title="browser",d.browser=!0,d.env={},d.argv=[],d.on=c,d.addListener=c,d.once=c,d.off=c,d.removeListener=c,d.removeAllListeners=c,d.emit=c,d.binding=function(){throw new Error("process.binding is not supported")},d.cwd=function(){return"/"},d.chdir=function(){throw new Error("process.chdir is not supported")}},{}]},{},[9])(9)});