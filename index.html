<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Storage API v0.0.1</title><link href="http://fonts.googleapis.com/css?family=Anonymous+Pro:400,700|Droid+Sans+Mono|Open+Sans:400,700|Linden+Hill|Quattrocento:400,700|News+Cycle:400,700|Antic+Slab|Cabin+Condensed:400,700" rel="stylesheet" type="text/css"><link href="docs/css/default.css" rel="stylesheet" type="text/css"><link href="docs/css/api.css" rel="stylesheet" type="text/css"></head><body class="api"><a id="forkbanner" href="http://github.com/archangel-irk/storage"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"></a><div id="links"><div id="header"><h1><a href="../index.html"><div class="storage">Storage</div></a></h1></div><hr><div class="doclinks"><div class="file"><a href="#index-js" class="section">index.js</a><ul><li><a href="#index_Storage-Collection">Collection</a></li><li><a href="#index_Storage-Document">Document</a></li><li><a href="#index_Storage-Error">Error</a></li><li><a href="#index_Storage-Schema">Schema</a></li><li><a href="#index_Storage-SchemaType">SchemaType</a></li><li><a href="#index_Storage">Storage</a></li><li><a href="#index_Storage-VirtualType">VirtualType</a></li><li><a href="#index_Storage-createCollection">createCollection</a></li><li><a href="#index_Storage-getCollectionNames">getCollectionNames</a></li><li><a href="#index_Storage-SchemaTypes">SchemaTypes</a></li><li><a href="#index_Storage-Types">Types</a></li><li><a href="#index_Storage-version">version</a></li></ul></div><div class="file"><a href="#binary-js" class="section">binary.js</a><ul><li><a href="#binary_Binary">Binary</a></li><li class="private"><a href="#binary_convertArraytoUtf8BinaryString">convertArraytoUtf8BinaryString</a></li><li><a href="#binary_Binary-length">length</a></li><li><a href="#binary_Binary-put">put</a></li><li><a href="#binary_Binary-read">read</a></li><li class="private"><a href="#binary_Binary-toJSON">toJSON</a></li><li class="private"><a href="#binary_Binary-toString">toString</a></li><li><a href="#binary_Binary-value">value</a></li><li><a href="#binary_Binary-write">write</a></li><li class="private"><a href="#binary_writeStringToArray">writeStringToArray</a></li><li><a href="#binary_Binary.SUBTYPE_BYTE_ARRAY">SUBTYPE_BYTE_ARRAY</a></li><li><a href="#binary_Binary.SUBTYPE_DEFAULT">SUBTYPE_DEFAULT</a></li><li><a href="#binary_Binary.SUBTYPE_FUNCTION">SUBTYPE_FUNCTION</a></li><li><a href="#binary_Binary.SUBTYPE_MD5">SUBTYPE_MD5</a></li><li><a href="#binary_Binary.SUBTYPE_USER_DEFINED">SUBTYPE_USER_DEFINED</a></li><li><a href="#binary_Binary.SUBTYPE_UUID">SUBTYPE_UUID</a></li><li><a href="#binary_Binary.SUBTYPE_UUID_OLD">SUBTYPE_UUID_OLD</a></li><li><a href="#binary_module.exports">exports</a></li></ul></div><div class="file"><a href="#binaryparser-js" class="section">binaryparser.js</a><ul><li><a href="#binaryparser_BinaryParserBuffer">BinaryParserBuffer</a></li><li><a href="#binaryparser_">chr</a></li><li><a href="#binaryparser_BinaryParser.Buffer">Buffer</a></li></ul></div><div class="file"><a href="#document-js" class="section">document.js</a><ul><li><a href="#document_Document">Document</a></li><li class="private"><a href="#document_Document-%24__buildDoc">$__buildDoc</a></li><li class="private"><a href="#document_Document-init">init</a></li><li><a href="#document_Document-set">set</a></li><li class="private"><a href="#document_Document-%24__shouldModify">$__shouldModify</a></li><li class="private"><a href="#document_Document-%24__set">$__set</a></li><li class="private"><a href="#document_Document-getValue">getValue</a></li><li class="private"><a href="#document_Document-setValue">setValue</a></li><li><a href="#document_Document-get">get</a></li><li class="private"><a href="#document_Document-%24__path">$__path</a></li><li><a href="#document_Document-markModified">markModified</a></li><li class="private"><a href="#document_Document-%24__try">$__try</a></li><li><a href="#document_Document-modifiedPaths">modifiedPaths</a></li><li><a href="#document_Document-isModified">isModified</a></li><li><a href="#document_Document-isDirectModified">isDirectModified</a></li><li><a href="#document_Document-isInit">isInit</a></li><li><a href="#document_Document-isSelected">isSelected</a></li><li><a href="#document_Document-validate">validate</a></li><li><a href="#document_Document-invalidate">invalidate</a></li><li class="private"><a href="#document_Document-%24__reset">$__reset</a></li><li class="private"><a href="#document_Document-%24__dirty">$__dirty</a></li><li class="private"><a href="#document_Document-%24__setSchema">$__setSchema</a></li><li class="private"><a href="#document_Document-%24__getAllSubdocs">$__getAllSubdocs</a></li><li class="private"><a href="#document_Document-%24__presaveValidate">$__presaveValidate</a></li><li class="private"><a href="#document_Document-%24__getArrayPathsToValidate">$__getArrayPathsToValidate</a></li><li class="private"><a href="#document_Document-%24__error">$__error</a></li><li class="private"><a href="#document_Document-%24__delta">$__delta</a></li><li><a href="#document_Document-save">save</a></li><li><a href="#document_Document-toObject">toObject</a></li><li><a href="#document_Document-toJSON">toJSON</a></li><li><a href="#document_Document-equals">equals</a></li><li><a href="#document_Document-populated">populated</a></li><li class="private"><a href="#document_Document-%24__fullPath">$__fullPath</a></li><li><a href="#document_Document-remove">remove</a></li><li><a href="#document_Document-empty">empty</a></li><li><a href="#document_Document-errors">errors</a></li><li><a href="#document_Document-id">id</a></li><li><a href="#document_Document-isNew">isNew</a></li><li><a href="#document_Document-schema">schema</a></li></ul></div><div class="file private"><a href="#error-cast-js" class="section">error/cast.js</a><ul><li class="private"><a href="#error_cast_CastError">CastError</a></li></ul></div><div class="file"><a href="#error-messages-js" class="section">error/messages.js</a><ul><li><a href="#error_messages_StorageError-msg">msg</a></li></ul></div><div class="file private"><a href="#error-validation-js" class="section">error/validation.js</a><ul><li class="private"><a href="#error_validation_ValidationError">ValidationError</a></li></ul></div><div class="file private"><a href="#error-validator-js" class="section">error/validator.js</a><ul><li class="private"><a href="#error_validator_ValidatorError">ValidatorError</a></li></ul></div><div class="file"><a href="#error-js" class="section">error.js</a><ul><li><a href="#error_StorageError">StorageError</a></li><li><a href="#error_StorageError.messages">messages</a></li></ul></div><div class="file"><a href="#events-js" class="section">events.js</a><ul><li><a href="#events_Events">Events</a></li><li><a href="#events_eventsApi">eventsApi</a></li><li><a href="#events_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-off">off</a></li><li><a href="#events_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-on">on</a></li><li><a href="#events_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-once">once</a></li><li><a href="#events_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-stopListening">stopListening</a></li><li><a href="#events_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-trigger">trigger</a></li><li><a href="#events_triggerEvents">triggerEvents</a></li></ul></div><div class="file"><a href="#mpath-js" class="section">mpath.js</a><ul><li><a href="#mpath_exports.get">get</a></li><li><a href="#mpath_exports.set">set</a></li></ul></div><div class="file private"><a href="#schema-array-js" class="section">schema/array.js</a><ul><li class="private"><a href="#schema_array_SchemaArray">SchemaArray</a></li><li class="private"><a href="#schema_array_SchemaArray-applyGetters">applyGetters</a></li><li class="private"><a href="#schema_array_SchemaArray-cast">cast</a></li><li class="private"><a href="#schema_array_SchemaArray-checkRequired">checkRequired</a></li></ul></div><div class="file private"><a href="#schema-boolean-js" class="section">schema/boolean.js</a><ul><li class="private"><a href="#schema_boolean_BooleanSchema">BooleanSchema</a></li><li class="private"><a href="#schema_boolean_BooleanSchema-cast">cast</a></li><li class="private"><a href="#schema_boolean_BooleanSchema-checkRequired">checkRequired</a></li></ul></div><div class="file private"><a href="#schema-buffer-js" class="section">schema/buffer.js</a><ul><li class="private"><a href="#schema_buffer_SchemaBuffer">SchemaBuffer</a></li><li class="private"><a href="#schema_buffer_SchemaBuffer-cast">cast</a></li><li class="private"><a href="#schema_buffer_SchemaBuffer-checkRequired">checkRequired</a></li></ul></div><div class="file private"><a href="#schema-date-js" class="section">schema/date.js</a><ul><li class="private"><a href="#schema_date_DateSchema">DateSchema</a></li><li class="private"><a href="#schema_date_DateSchema-cast">cast</a></li><li class="private"><a href="#schema_date_DateSchema-checkRequired">checkRequired</a></li></ul></div><div class="file private"><a href="#schema-documentarray-js" class="section">schema/documentarray.js</a><ul><li class="private"><a href="#schema_documentarray_DocumentArray">DocumentArray</a></li><li class="private"><a href="#schema_documentarray_DocumentArray-cast">cast</a></li><li class="private"><a href="#schema_documentarray_DocumentArray-doValidate">doValidate</a></li></ul></div><div class="file private"><a href="#schema-mixed-js" class="section">schema/mixed.js</a><ul><li class="private"><a href="#schema_mixed_Mixed">Mixed</a></li><li class="private"><a href="#schema_mixed_Mixed-cast">cast</a></li><li class="private"><a href="#schema_mixed_Mixed-checkRequired">checkRequired</a></li></ul></div><div class="file"><a href="#schema-number-js" class="section">schema/number.js</a><ul><li class="private"><a href="#schema_number_NumberSchema">NumberSchema</a></li><li class="private"><a href="#schema_number_NumberSchema-cast">cast</a></li><li class="private"><a href="#schema_number_NumberSchema-checkRequired">checkRequired</a></li><li><a href="#schema_number_NumberSchema-max">max</a></li><li><a href="#schema_number_NumberSchema-min">min</a></li></ul></div><div class="file"><a href="#schema-objectid-js" class="section">schema/objectid.js</a><ul><li class="private"><a href="#schema_objectid_ObjectId">ObjectId</a></li><li><a href="#schema_objectid_ObjectId-auto">auto</a></li><li class="private"><a href="#schema_objectid_ObjectId-cast">cast</a></li><li class="private"><a href="#schema_objectid_ObjectId-checkRequired">checkRequired</a></li></ul></div><div class="file"><a href="#schema-string-js" class="section">schema/string.js</a><ul><li class="private"><a href="#schema_string_StringSchema">StringSchema</a></li><li class="private"><a href="#schema_string_StringSchema-cast">cast</a></li><li class="private"><a href="#schema_string_StringSchema-checkRequired">checkRequired</a></li><li><a href="#schema_string_StringSchema-enum">enum</a></li><li><a href="#schema_string_StringSchema-lowercase">lowercase</a></li><li><a href="#schema_string_StringSchema-match">match</a></li><li><a href="#schema_string_StringSchema-trim">trim</a></li><li><a href="#schema_string_StringSchema-uppercase">uppercase</a></li></ul></div><div class="file"><a href="#schema-js" class="section">schema.js</a><ul><li><a href="#schema_Schema">Schema</a></li><li><a href="#schema_Schema-add">add</a></li><li class="private"><a href="#schema_Schema-defaultOptions">defaultOptions</a></li><li><a href="#schema_Schema-discriminator">discriminator</a></li><li><a href="#schema_Schema-eachPath">eachPath</a></li><li><a href="#schema_Schema-get">get</a></li><li><a href="#schema_Schema-method">method</a></li><li><a href="#schema_Schema-path">path</a></li><li><a href="#schema_Schema-pathType">pathType</a></li><li><a href="#schema_Schema-plugin">plugin</a></li><li><a href="#schema_Schema-post">post</a></li><li><a href="#schema_Schema-pre">pre</a></li><li class="private"><a href="#schema_Schema-queue">queue</a></li><li><a href="#schema_Schema-requiredPaths">requiredPaths</a></li><li><a href="#schema_Schema-set">set</a></li><li><a href="#schema_Schema-static">static</a></li><li><a href="#schema_Schema-virtual">virtual</a></li><li><a href="#schema_Schema-virtualpath">virtualpath</a></li><li><a href="#schema_Schema.Types">Types</a></li><li class="private"><a href="#schema_Schema.interpretAsType">interpretAsType</a></li><li><a href="#schema_Schema.reserved">reserved</a></li><li><a href="#schema_Schema-discriminators">discriminators</a></li><li class="private"><a href="#schema_Schema-paths">paths</a></li><li class="private"><a href="#schema_Schema-tree">tree</a></li></ul></div><div class="file"><a href="#schematype-js" class="section">schematype.js</a><ul><li><a href="#schematype_SchemaType">SchemaType</a></li><li><a href="#schematype_SchemaType-default">default</a></li><li><a href="#schematype_SchemaType-get">get</a></li><li><a href="#schematype_SchemaType-set">set</a></li><li><a href="#schematype_SchemaType-validate">validate</a></li></ul></div><div class="file"><a href="#types-array-js" class="section">types/array.js</a><ul><li class="private"><a href="#types_array_StorageArray">StorageArray</a></li><li class="private"><a href="#types_array_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-_cast">_cast</a></li><li class="private"><a href="#types_array_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-_markModified">_markModified</a></li><li><a href="#types_array_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-addToSet">addToSet</a></li><li><a href="#types_array_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-indexOf">indexOf</a></li><li><a href="#types_array_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-pop">pop</a></li><li><a href="#types_array_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-pull">pull</a></li><li><a href="#types_array_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-push">push</a></li><li><a href="#types_array_StorageArray-remove">remove</a></li><li><a href="#types_array_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-set">set</a></li><li><a href="#types_array_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-shift">shift</a></li><li><a href="#types_array_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-sort">sort</a></li><li><a href="#types_array_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-splice">splice</a></li><li><a href="#types_array_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-toObject">toObject</a></li><li><a href="#types_array_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-unshift">unshift</a></li><li class="private"><a href="#types_array_StorageArray-_parent">_parent</a></li></ul></div><div class="file"><a href="#types-buffer-js" class="section">types/buffer.js</a><ul><li class="private"><a href="#types_buffer_StorageBuffer">StorageBuffer</a></li><li class="private"><a href="#types_buffer_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-_markModified">_markModified</a></li><li><a href="#types_buffer_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-copy">copy</a></li><li><a href="#types_buffer_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-write">write</a></li><li><a href="#types_buffer_StorageBuffer.mixin.equals">equals</a></li><li><a href="#types_buffer_StorageBuffer.mixin.subtype">subtype</a></li><li><a href="#types_buffer_StorageBuffer.mixin.toObject">toObject</a></li><li class="private"><a href="#types_buffer_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-_parent">_parent</a></li><li class="private"><a href="#types_buffer_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-_subtype">_subtype</a></li></ul></div><div class="file"><a href="#types-documentarray-js" class="section">types/documentarray.js</a><ul><li class="private"><a href="#types_documentarray_StorageDocumentArray">StorageDocumentArray</a></li><li class="private"><a href="#types_documentarray_StorageDocumentArray.mixin._cast">_cast</a></li><li><a href="#types_documentarray_StorageDocumentArray.mixin.create">create</a></li><li><a href="#types_documentarray_StorageDocumentArray.mixin.id">id</a></li><li class="private"><a href="#types_documentarray_StorageDocumentArray.mixin.notify">notify</a></li><li><a href="#types_documentarray_StorageDocumentArray.mixin.toObject">toObject</a></li></ul></div><div class="file"><a href="#types-embedded-js" class="section">types/embedded.js</a><ul><li class="private"><a href="#types_embedded_EmbeddedDocument-%24__fullPath">$__fullPath</a></li><li class="private"><a href="#types_embedded_EmbeddedDocument">EmbeddedDocument</a></li><li><a href="#types_embedded_EmbeddedDocument-invalidate">invalidate</a></li><li><a href="#types_embedded_EmbeddedDocument-markModified">markModified</a></li><li><a href="#types_embedded_EmbeddedDocument-ownerDocument">ownerDocument</a></li><li><a href="#types_embedded_EmbeddedDocument-parent">parent</a></li><li><a href="#types_embedded_EmbeddedDocument-parentArray">parentArray</a></li><li><a href="#types_embedded_EmbeddedDocument-remove">remove</a></li><li class="private"><a href="#types_embedded_EmbeddedDocument-save">save</a></li><li class="private"><a href="#types_embedded_EmbeddedDocument-update">update</a></li></ul></div><div class="file"><a href="#types-objectid-js" class="section">types/objectid.js</a><ul><li><a href="#types_objectid_">BinaryParser</a></li><li><a href="#types_objectid_">MACHINE_ID</a></li><li><a href="#types_objectid_ObjectId-equals">equals</a></li><li><a href="#types_objectid_ObjectId-generate">generate</a></li><li><a href="#types_objectid_ObjectId-getInc">getInc</a></li><li><a href="#types_objectid_ObjectId-getTimestamp">getTimestamp</a></li><li><a href="#types_objectid_ObjectId-get_inc">get_inc</a></li><li><a href="#types_objectid_">machine3Bytes</a></li><li><a href="#types_objectid_ObjectId-toHexString">toHexString</a></li><li><a href="#types_objectid_ObjectId-toJSON">toJSON</a></li><li><a href="#types_objectid_ObjectId-toString">toString</a></li><li><a href="#types_objectid_ObjectId.createFromHexString">createFromHexString</a></li><li><a href="#types_objectid_ObjectId.createFromTime">createFromTime</a></li><li><a href="#types_objectid_ObjectId.createPk">createPk</a></li><li><a href="#types_objectid_module.exports">exports</a></li><li><a href="#types_objectid_ObjectId.index">index</a></li><li><a href="#types_objectid_ObjectId.isValid">isValid</a></li><li><a href="#types_objectid_ObjectId-ObjectId">ObjectId</a></li></ul></div><div class="file"><a href="#utils-js" class="section">utils.js</a><ul><li><a href="#utils_exports.pluralization">pluralization</a></li><li><a href="#utils_exports.uncountables">uncountables</a></li></ul></div><div class="file"><a href="#virtualtype-js" class="section">virtualtype.js</a><ul><li><a href="#virtualtype_VirtualType">VirtualType</a></li><li><a href="#virtualtype_VirtualType-applyGetters">applyGetters</a></li><li><a href="#virtualtype_VirtualType-applySetters">applySetters</a></li><li><a href="#virtualtype_VirtualType-get">get</a></li><li><a href="#virtualtype_VirtualType-set">set</a></li></ul></div><div class="file"><a href="#collection-js" class="section">collection.js</a><ul><li><a href="#collection_Collection">Collection</a></li><li><a href="#collection_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-add">add</a></li><li><a href="#collection_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-find">find</a></li><li><a href="#collection_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-findById">findById</a></li><li><a href="#collection_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-findByIdAndRemove">findByIdAndRemove</a></li><li><a href="#collection_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-findByIdAndUpdate">findByIdAndUpdate</a></li><li><a href="#collection_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-findOne">findOne</a></li><li><a href="#collection_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-findOneAndRemove">findOneAndRemove</a></li><li><a href="#collection_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-findOneAndUpdate">findOneAndUpdate</a></li><li><a href="#collection_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-remove">remove</a></li><li><a href="#collection_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-storageHasMutated">storageHasMutated</a></li><li><a href="#collection_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-update">update</a></li></ul></div></div></div><div id="content"><div class="controls"><label><input type="checkbox">private</label></div><ul><li class="module"><a href="https://github.com/archangel-irk/storage/blob/0.0.1/lib/index.js" id="index-js">index.js</a><div class="item method public"><h3 id="index_Storage-Collection"><a href="#index_Storage-Collection">Storage#Collection()</a></h3><p>The Storage Collection constructor</p><div class="description"></div><hr></div><div class="item method public"><h3 id="index_Storage-Document"><a href="#index_Storage-Document">Storage#Document()</a></h3><p>The Storage <a href="#document-js">Document</a> constructor.</p><div class="description"></div><hr></div><div class="item method public"><h3 id="index_Storage-Error"><a href="#index_Storage-Error">Storage#Error()</a></h3><p>The <a href="#error_StorageError">StorageError</a> constructor.</p><div class="description"></div><hr></div><div class="item method public"><h3 id="index_Storage-Schema"><a href="#index_Storage-Schema">Storage#Schema()</a></h3><p>The Storage <a href="#schema_Schema">Schema</a> constructor</p><div class="description"><h4>Example:</h4>
<pre><code><span class="hljs-keyword">var</span> Schema = storage.Schema;
<span class="hljs-keyword">var</span> CatSchema = <span class="hljs-keyword">new</span> Schema(..);</code></pre></div><hr></div><div class="item method public"><h3 id="index_Storage-SchemaType"><a href="#index_Storage-SchemaType">Storage#SchemaType()</a></h3><p>The Storage <a href="#schematype_SchemaType">SchemaType</a> constructor</p><div class="description"></div><hr></div><div class="item method public"><h3 id="index_Storage"><a href="#index_Storage">Storage()</a></h3><p>Storage constructor.</p><div class="description"><p>The exports object of the <code>storage</code> module is an instance of this class.<br />Most apps will only use this one instance.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Storage</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">this</span>.collectionNames = [];
}</code></pre></div><hr></div><div class="item method public"><h3 id="index_Storage-VirtualType"><a href="#index_Storage-VirtualType">Storage#VirtualType()</a></h3><p>The Storage <a href="#virtualtype_VirtualType">VirtualType</a> constructor</p><div class="description"></div><hr></div><div class="item method public"><h3 id="index_Storage-createCollection"><a href="#index_Storage-createCollection">Storage#createCollection(<code>name</code>, <code>schema</code>, <code>[api]</code>)</a></h3><p>Create a collection and get it</p><div class="params"><h4>Parameters:</h4><ul><li><code>name</code><span class="types"> &lt;<a href="#string">string</a>&gt; </span><span></span></li><li><code>schema</code><span class="types"> &lt;<a href="#storage.Schema">storage.Schema</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/undefined">undefined</a>&gt; </span><span></span></li><li><code>[api]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>- ссылка на апи ресурс</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Storage.prototype.createCollection = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( name, schema, api )</span></span>{
  <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">this</span>[ name ] ){
    <span class="hljs-built_in">console</span>.info(<span class="hljs-string">'storage::collection: `'</span> + name + <span class="hljs-string">'` already exist'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>[ name ];
  }

  <span class="hljs-keyword">if</span> ( <span class="hljs-string">'Schema'</span> !== utils.getFunctionName( schema.constructor ) ){
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">TypeError</span>(<span class="hljs-string">'`schema` must be Schema instance'</span>);
  }

  <span class="hljs-keyword">this</span>.collectionNames.push( name );

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>[ name ] = <span class="hljs-keyword">new</span> Collection( name, schema, api );
};</code></pre></div><hr></div><div class="item method public"><h3 id="index_Storage-getCollectionNames"><a href="#index_Storage-getCollectionNames">Storage#getCollectionNames()</a></h3><p>To obtain the names of the collections in an array</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Storage.prototype.getCollectionNames = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.collectionNames;
};</code></pre></div><hr></div><div class="item property public"><h3 id="index_Storage-SchemaTypes"><a href="#index_Storage-SchemaTypes">Storage#<span>SchemaTypes</span></a></h3><p>The various Storage SchemaTypes.</p><h4>Note:</h4>
<p><em>Alias of storage.Schema.Types for backwards compatibility.</em></p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Storage.prototype.SchemaTypes = Schema.Types;</code></pre></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#schema_Schema.Types" title="Schema.SchemaTypes">Schema.SchemaTypes</a></li></ul></div><hr></div><div class="item property public"><h3 id="index_Storage-Types"><a href="#index_Storage-Types">Storage#<span>Types</span></a></h3><p>The various Storage Types.</p><h4>Example:</h4>
<pre><code><span class="hljs-keyword">var</span> array = storage.Types.Array;</code></pre><h4>Types:</h4>
<ul>
<li><a href="#types-objectid-js">ObjectId</a></li>
<li><a href="#types-buffer-js">Buffer</a></li>
<li><a href="#types-embedded-js">SubDocument</a></li>
<li><a href="#types-array-js">Array</a></li>
<li><a href="#types-documentarray-js">DocumentArray</a></li>
</ul>
<p>Using this exposed access to the <code>ObjectId</code> type, we can construct ids on demand.</p><pre><code><span class="hljs-keyword">var</span> ObjectId = storage.Types.ObjectId;
<span class="hljs-keyword">var</span> id1 = <span class="hljs-keyword">new</span> ObjectId;</code></pre><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Storage.prototype.Types = Types;</code></pre></div><hr></div><div class="item property public"><h3 id="index_Storage-version"><a href="#index_Storage-version">Storage#<span>version</span></a></h3><p>The Storage version</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Storage.prototype.version = pkg.version;</code></pre></div><hr></div></li><li class="module"><a href="https://github.com/archangel-irk/storage/blob/0.0.1/lib/binary.js" id="binary-js">binary.js</a><div class="item method public"><h3 id="binary_Binary"><a href="#binary_Binary">Binary(<code>buffer</code>, <code>[subType]</code>)</a></h3><p>A class representation of the BSON Binary type.</p><div class="params"><h4>Parameters:</h4><ul><li><code>buffer</code><span class="types"> &lt;<a href="http://nodejs.org/api/buffer.html">Buffer</a>&gt; </span><span>a buffer object containing the binary data.</span></li><li><code>[subType]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span>the option binary type.</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#Grid">Grid</a>&gt; </span><span></span></li></ul></div><div class="description"><p>Sub types</p><ul>
<li><strong>BSON.BSON_BINARY_SUBTYPE_DEFAULT</strong>, default BSON type.</li>
<li><strong>BSON.BSON_BINARY_SUBTYPE_FUNCTION</strong>, BSON function type.</li>
<li><strong>BSON.BSON_BINARY_SUBTYPE_BYTE_ARRAY</strong>, BSON byte array type.</li>
<li><strong>BSON.BSON_BINARY_SUBTYPE_UUID</strong>, BSON uuid type.</li>
<li><strong>BSON.BSON_BINARY_SUBTYPE_MD5</strong>, BSON md5 type.</li>
<li><strong>BSON.BSON_BINARY_SUBTYPE_USER_DEFINED</strong>, BSON user defined type.</li>
</ul>
</div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Binary</span><span class="hljs-params">(buffer, subType)</span> </span>{
  <span class="hljs-keyword">if</span>(!(<span class="hljs-keyword">this</span> <span class="hljs-keyword">instanceof</span> Binary)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Binary(buffer, subType);

  <span class="hljs-keyword">this</span>._bsontype = <span class="hljs-string">'Binary'</span>;

  <span class="hljs-keyword">if</span>(buffer <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Number</span>) {
    <span class="hljs-keyword">this</span>.sub_type = buffer;
    <span class="hljs-keyword">this</span>.position = <span class="hljs-number">0</span>;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">this</span>.sub_type = subType == <span class="hljs-literal">null</span> ? BSON_BINARY_SUBTYPE_DEFAULT : subType;
    <span class="hljs-keyword">this</span>.position = <span class="hljs-number">0</span>;
  }

  <span class="hljs-keyword">if</span>(buffer != <span class="hljs-literal">null</span> &amp;&amp; !(buffer <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Number</span>)) {
    <span class="hljs-comment">// Only accept Buffer, Uint8Array or Arrays</span>
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> buffer == <span class="hljs-string">'string'</span>) {
      <span class="hljs-comment">// Different ways of writing the length of the string for the different types</span>
      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> Buffer != <span class="hljs-string">'undefined'</span>) {
        <span class="hljs-keyword">this</span>.buffer = <span class="hljs-keyword">new</span> Buffer(buffer);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">Uint8Array</span> != <span class="hljs-string">'undefined'</span> || (<span class="hljs-built_in">Object</span>.prototype.toString.call(buffer) == <span class="hljs-string">'[object Array]'</span>)) {
        <span class="hljs-keyword">this</span>.buffer = writeStringToArray(buffer);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"only String, Buffer, Uint8Array or Array accepted"</span>);
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">this</span>.buffer = buffer;
    }
    <span class="hljs-keyword">this</span>.position = buffer.length;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> Buffer != <span class="hljs-string">'undefined'</span>) {
      <span class="hljs-keyword">this</span>.buffer =  <span class="hljs-keyword">new</span> Buffer(Binary.BUFFER_SIZE);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">Uint8Array</span> != <span class="hljs-string">'undefined'</span>){
      <span class="hljs-keyword">this</span>.buffer = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">ArrayBuffer</span>(Binary.BUFFER_SIZE));
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">this</span>.buffer = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(Binary.BUFFER_SIZE);
    }
    <span class="hljs-comment">// Set position to start of buffer</span>
    <span class="hljs-keyword">this</span>.position = <span class="hljs-number">0</span>;
  }
}</code></pre></div><hr></div><div class="item method private"><h3 id="binary_convertArraytoUtf8BinaryString"><a href="#binary_convertArraytoUtf8BinaryString">convertArraytoUtf8BinaryString()</a></h3><p>Convert Array ot Uint8Array to Binary String</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="hljs-keyword">var</span> convertArraytoUtf8BinaryString = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(byteArray, startIndex, endIndex)</span> </span>{
  <span class="hljs-keyword">var</span> result = <span class="hljs-string">""</span>;
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = startIndex; i &lt; endIndex; i++) {
    result = result + <span class="hljs-built_in">String</span>.fromCharCode(byteArray[i]);
  }
  <span class="hljs-keyword">return</span> result;
};

Binary.BUFFER_SIZE = <span class="hljs-number">256</span>;</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="binary_Binary-length"><a href="#binary_Binary-length">Binary#length()</a></h3><p>Length.</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span>the length of the binary.</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Binary.prototype.length = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">length</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.position;
};</code></pre></div><hr></div><div class="item method public"><h3 id="binary_Binary-put"><a href="#binary_Binary-put">Binary#put(<code>byte_value</code>)</a></h3><p>Updates this binary with byte_value.</p><div class="params"><h4>Parameters:</h4><ul><li><code>byte_value</code><span class="types"> &lt;<a href="#Character">Character</a>&gt; </span><span>a single byte we wish to write.</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Binary.prototype.put = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">put</span><span class="hljs-params">(byte_value)</span> </span>{
  <span class="hljs-comment">// If it's a string and a has more than one character throw an error</span>
  <span class="hljs-keyword">if</span>(byte_value[<span class="hljs-string">'length'</span>] != <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-keyword">typeof</span> byte_value != <span class="hljs-string">'number'</span> &amp;&amp; byte_value.length != <span class="hljs-number">1</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"only accepts single character String, Uint8Array or Array"</span>);
  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> byte_value != <span class="hljs-string">'number'</span> &amp;&amp; byte_value &lt; <span class="hljs-number">0</span> || byte_value &gt; <span class="hljs-number">255</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"only accepts number in a valid unsigned byte range 0-255"</span>);

  <span class="hljs-comment">// Decode the byte value once</span>
  <span class="hljs-keyword">var</span> decoded_byte = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> byte_value == <span class="hljs-string">'string'</span>) {
    decoded_byte = byte_value.charCodeAt(<span class="hljs-number">0</span>);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(byte_value[<span class="hljs-string">'length'</span>] != <span class="hljs-literal">null</span>) {
    decoded_byte = byte_value[<span class="hljs-number">0</span>];
  } <span class="hljs-keyword">else</span> {
    decoded_byte = byte_value;
  }

  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.buffer.length &gt; <span class="hljs-keyword">this</span>.position) {
    <span class="hljs-keyword">this</span>.buffer[<span class="hljs-keyword">this</span>.position++] = decoded_byte;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> Buffer != <span class="hljs-string">'undefined'</span> &amp;&amp; Buffer.isBuffer(<span class="hljs-keyword">this</span>.buffer)) {
      <span class="hljs-comment">// Create additional overflow buffer</span>
      <span class="hljs-keyword">var</span> buffer = <span class="hljs-keyword">new</span> Buffer(Binary.BUFFER_SIZE + <span class="hljs-keyword">this</span>.buffer.length);
      <span class="hljs-comment">// Combine the two buffers together</span>
      <span class="hljs-keyword">this</span>.buffer.copy(buffer, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">this</span>.buffer.length);
      <span class="hljs-keyword">this</span>.buffer = buffer;
      <span class="hljs-keyword">this</span>.buffer[<span class="hljs-keyword">this</span>.position++] = decoded_byte;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">var</span> buffer = <span class="hljs-literal">null</span>;
      <span class="hljs-comment">// Create a new buffer (typed or normal array)</span>
      <span class="hljs-keyword">if</span>(<span class="hljs-built_in">Object</span>.prototype.toString.call(<span class="hljs-keyword">this</span>.buffer) == <span class="hljs-string">'[object Uint8Array]'</span>) {
        buffer = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">ArrayBuffer</span>(Binary.BUFFER_SIZE + <span class="hljs-keyword">this</span>.buffer.length));
      } <span class="hljs-keyword">else</span> {
        buffer = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(Binary.BUFFER_SIZE + <span class="hljs-keyword">this</span>.buffer.length);
      }

      <span class="hljs-comment">// We need to copy all the content to the new array</span>
      <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.buffer.length; i++) {
        buffer[i] = <span class="hljs-keyword">this</span>.buffer[i];
      }

      <span class="hljs-comment">// Reassign the buffer</span>
      <span class="hljs-keyword">this</span>.buffer = buffer;
      <span class="hljs-comment">// Write the byte</span>
      <span class="hljs-keyword">this</span>.buffer[<span class="hljs-keyword">this</span>.position++] = decoded_byte;
    }
  }
};</code></pre></div><hr></div><div class="item method public"><h3 id="binary_Binary-read"><a href="#binary_Binary-read">Binary#read(<code>position</code>, <code>length</code>)</a></h3><p>Reads <strong>length</strong> bytes starting at <strong>position</strong>.</p><div class="params"><h4>Parameters:</h4><ul><li><code>position</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span>read from the given position in the Binary.</span></li><li><code>length</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span>the number of bytes to read.</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="http://nodejs.org/api/buffer.html">Buffer</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Binary.prototype.read = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read</span><span class="hljs-params">(position, length)</span> </span>{
  length = length &amp;&amp; length &gt; <span class="hljs-number">0</span>
    ? length
    : <span class="hljs-keyword">this</span>.position;

  <span class="hljs-comment">// Let's return the data based on the type we have</span>
  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.buffer[<span class="hljs-string">'slice'</span>]) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.buffer.slice(position, position + length);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// Create a buffer to keep the result</span>
    <span class="hljs-keyword">var</span> buffer = <span class="hljs-keyword">typeof</span> <span class="hljs-built_in">Uint8Array</span> != <span class="hljs-string">'undefined'</span> ? <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">ArrayBuffer</span>(length)) : <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(length);
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; length; i++) {
      buffer[i] = <span class="hljs-keyword">this</span>.buffer[position++];
    }
  }
  <span class="hljs-comment">// Return the buffer</span>
  <span class="hljs-keyword">return</span> buffer;
};</code></pre></div><hr></div><div class="item method private"><h3 id="binary_Binary-toJSON"><a href="#binary_Binary-toJSON">Binary#toJSON()</a></h3><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Binary.prototype.toJSON = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.buffer != <span class="hljs-literal">null</span> ? <span class="hljs-keyword">this</span>.buffer.toString(<span class="hljs-string">'base64'</span>) : <span class="hljs-string">''</span>;
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="binary_Binary-toString"><a href="#binary_Binary-toString">Binary#toString()</a></h3><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Binary.prototype.toString = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(format)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.buffer != <span class="hljs-literal">null</span> ? <span class="hljs-keyword">this</span>.buffer.slice(<span class="hljs-number">0</span>, <span class="hljs-keyword">this</span>.position).toString(format) : <span class="hljs-string">''</span>;
};

<span class="hljs-comment">// Binary default subtype</span>
<span class="hljs-keyword">var</span> BSON_BINARY_SUBTYPE_DEFAULT = <span class="hljs-number">0</span>;</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="binary_Binary-value"><a href="#binary_Binary-value">Binary#value()</a></h3><p>Returns the value of this binary as a string.</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Binary.prototype.value = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">value</span><span class="hljs-params">(asRaw)</span> </span>{
  asRaw = asRaw == <span class="hljs-literal">null</span> ? <span class="hljs-literal">false</span> : asRaw;

  <span class="hljs-comment">// Optimize to serialize for the situation where the data == size of buffer</span>
  <span class="hljs-keyword">if</span>(asRaw &amp;&amp; <span class="hljs-keyword">typeof</span> Buffer != <span class="hljs-string">'undefined'</span> &amp;&amp; Buffer.isBuffer(<span class="hljs-keyword">this</span>.buffer) &amp;&amp; <span class="hljs-keyword">this</span>.buffer.length == <span class="hljs-keyword">this</span>.position)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.buffer;

  <span class="hljs-comment">// If it's a node.js buffer object</span>
  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> Buffer != <span class="hljs-string">'undefined'</span> &amp;&amp; Buffer.isBuffer(<span class="hljs-keyword">this</span>.buffer)) {
    <span class="hljs-keyword">return</span> asRaw ? <span class="hljs-keyword">this</span>.buffer.slice(<span class="hljs-number">0</span>, <span class="hljs-keyword">this</span>.position) : <span class="hljs-keyword">this</span>.buffer.toString(<span class="hljs-string">'binary'</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">this</span>.position);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">if</span>(asRaw) {
      <span class="hljs-comment">// we support the slice command use it</span>
      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.buffer[<span class="hljs-string">'slice'</span>] != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.buffer.slice(<span class="hljs-number">0</span>, <span class="hljs-keyword">this</span>.position);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// Create a new buffer to copy content to</span>
        <span class="hljs-keyword">var</span> newBuffer = <span class="hljs-built_in">Object</span>.prototype.toString.call(<span class="hljs-keyword">this</span>.buffer) == <span class="hljs-string">'[object Uint8Array]'</span> ? <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">ArrayBuffer</span>(<span class="hljs-keyword">this</span>.position)) : <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(<span class="hljs-keyword">this</span>.position);
        <span class="hljs-comment">// Copy content</span>
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.position; i++) {
          newBuffer[i] = <span class="hljs-keyword">this</span>.buffer[i];
        }
        <span class="hljs-comment">// Return the buffer</span>
        <span class="hljs-keyword">return</span> newBuffer;
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> convertArraytoUtf8BinaryString(<span class="hljs-keyword">this</span>.buffer, <span class="hljs-number">0</span>, <span class="hljs-keyword">this</span>.position);
    }
  }
};</code></pre></div><hr></div><div class="item method public"><h3 id="binary_Binary-write"><a href="#binary_Binary-write">Binary#write(<code>string</code>, <code>offset</code>)</a></h3><p>Writes a buffer or string to the binary.</p><div class="params"><h4>Parameters:</h4><ul><li><code>string</code><span class="types"> &lt;<a href="http://nodejs.org/api/buffer.html">Buffer</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>a string or buffer to be written to the Binary BSON object.</span></li><li><code>offset</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span>specify the binary of where to write the content.</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Binary.prototype.write = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">write</span><span class="hljs-params">(string, offset)</span> </span>{
  offset = <span class="hljs-keyword">typeof</span> offset == <span class="hljs-string">'number'</span> ? offset : <span class="hljs-keyword">this</span>.position;

  <span class="hljs-comment">// If the buffer is to small let's extend the buffer</span>
  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.buffer.length &lt; offset + string.length) {
    <span class="hljs-keyword">var</span> buffer = <span class="hljs-literal">null</span>;
    <span class="hljs-comment">// If we are in node.js</span>
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> Buffer != <span class="hljs-string">'undefined'</span> &amp;&amp; Buffer.isBuffer(<span class="hljs-keyword">this</span>.buffer)) {
      buffer = <span class="hljs-keyword">new</span> Buffer(<span class="hljs-keyword">this</span>.buffer.length + string.length);
      <span class="hljs-keyword">this</span>.buffer.copy(buffer, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">this</span>.buffer.length);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-built_in">Object</span>.prototype.toString.call(<span class="hljs-keyword">this</span>.buffer) == <span class="hljs-string">'[object Uint8Array]'</span>) {
      <span class="hljs-comment">// Create a new buffer</span>
      buffer = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">ArrayBuffer</span>(<span class="hljs-keyword">this</span>.buffer.length + string.length))
      <span class="hljs-comment">// Copy the content</span>
      <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.position; i++) {
        buffer[i] = <span class="hljs-keyword">this</span>.buffer[i];
      }
    }

    <span class="hljs-comment">// Assign the new buffer</span>
    <span class="hljs-keyword">this</span>.buffer = buffer;
  }

  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> Buffer != <span class="hljs-string">'undefined'</span> &amp;&amp; Buffer.isBuffer(string) &amp;&amp; Buffer.isBuffer(<span class="hljs-keyword">this</span>.buffer)) {
    string.copy(<span class="hljs-keyword">this</span>.buffer, offset, <span class="hljs-number">0</span>, string.length);
    <span class="hljs-keyword">this</span>.position = (offset + string.length) &gt; <span class="hljs-keyword">this</span>.position ? (offset + string.length) : <span class="hljs-keyword">this</span>.position;
    <span class="hljs-comment">// offset = string.length</span>
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> Buffer != <span class="hljs-string">'undefined'</span> &amp;&amp; <span class="hljs-keyword">typeof</span> string == <span class="hljs-string">'string'</span> &amp;&amp; Buffer.isBuffer(<span class="hljs-keyword">this</span>.buffer)) {
    <span class="hljs-keyword">this</span>.buffer.write(string, <span class="hljs-string">'binary'</span>, offset);
    <span class="hljs-keyword">this</span>.position = (offset + string.length) &gt; <span class="hljs-keyword">this</span>.position ? (offset + string.length) : <span class="hljs-keyword">this</span>.position;
    <span class="hljs-comment">// offset = string.length;</span>
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-built_in">Object</span>.prototype.toString.call(string) == <span class="hljs-string">'[object Uint8Array]'</span>
    || <span class="hljs-built_in">Object</span>.prototype.toString.call(string) == <span class="hljs-string">'[object Array]'</span> &amp;&amp; <span class="hljs-keyword">typeof</span> string != <span class="hljs-string">'string'</span>) {
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; string.length; i++) {
      <span class="hljs-keyword">this</span>.buffer[offset++] = string[i];
    }

    <span class="hljs-keyword">this</span>.position = offset &gt; <span class="hljs-keyword">this</span>.position ? offset : <span class="hljs-keyword">this</span>.position;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> string == <span class="hljs-string">'string'</span>) {
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; string.length; i++) {
      <span class="hljs-keyword">this</span>.buffer[offset++] = string.charCodeAt(i);
    }

    <span class="hljs-keyword">this</span>.position = offset &gt; <span class="hljs-keyword">this</span>.position ? offset : <span class="hljs-keyword">this</span>.position;
  }
};</code></pre></div><hr></div><div class="item method private"><h3 id="binary_writeStringToArray"><a href="#binary_writeStringToArray">writeStringToArray()</a></h3><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="hljs-keyword">var</span> writeStringToArray = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> </span>{
  <span class="hljs-comment">// Create a buffer</span>
  <span class="hljs-keyword">var</span> buffer = <span class="hljs-keyword">typeof</span> <span class="hljs-built_in">Uint8Array</span> != <span class="hljs-string">'undefined'</span> ? <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">ArrayBuffer</span>(data.length)) : <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(data.length);
  <span class="hljs-comment">// Write the content to the buffer</span>
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; data.length; i++) {
    buffer[i] = data.charCodeAt(i);
  }
  <span class="hljs-comment">// Write the string to the buffer</span>
  <span class="hljs-keyword">return</span> buffer;
};</code></pre></div><hr class="private"></div><div class="item static public"><h3 id="binary_Binary.SUBTYPE_BYTE_ARRAY"><a href="#binary_Binary.SUBTYPE_BYTE_ARRAY">Binary.SUBTYPE_BYTE_ARRAY</a></h3><p>Byte Array BSON type</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Binary.SUBTYPE_BYTE_ARRAY = <span class="hljs-number">2</span>;</code></pre></div><hr></div><div class="item static public"><h3 id="binary_Binary.SUBTYPE_DEFAULT"><a href="#binary_Binary.SUBTYPE_DEFAULT">Binary.SUBTYPE_DEFAULT</a></h3><p>Default BSON type</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Binary.SUBTYPE_DEFAULT = <span class="hljs-number">0</span>;</code></pre></div><hr></div><div class="item static public"><h3 id="binary_Binary.SUBTYPE_FUNCTION"><a href="#binary_Binary.SUBTYPE_FUNCTION">Binary.SUBTYPE_FUNCTION</a></h3><p>Function BSON type</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Binary.SUBTYPE_FUNCTION = <span class="hljs-number">1</span>;</code></pre></div><hr></div><div class="item static public"><h3 id="binary_Binary.SUBTYPE_MD5"><a href="#binary_Binary.SUBTYPE_MD5">Binary.SUBTYPE_MD5</a></h3><p>MD5 BSON type</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Binary.SUBTYPE_MD5 = <span class="hljs-number">5</span>;</code></pre></div><hr></div><div class="item static public"><h3 id="binary_Binary.SUBTYPE_USER_DEFINED"><a href="#binary_Binary.SUBTYPE_USER_DEFINED">Binary.SUBTYPE_USER_DEFINED</a></h3><p>User BSON type</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Binary.SUBTYPE_USER_DEFINED = <span class="hljs-number">128</span>;</code></pre></div><hr></div><div class="item static public"><h3 id="binary_Binary.SUBTYPE_UUID"><a href="#binary_Binary.SUBTYPE_UUID">Binary.SUBTYPE_UUID</a></h3><p>UUID BSON type</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Binary.SUBTYPE_UUID = <span class="hljs-number">4</span>;</code></pre></div><hr></div><div class="item static public"><h3 id="binary_Binary.SUBTYPE_UUID_OLD"><a href="#binary_Binary.SUBTYPE_UUID_OLD">Binary.SUBTYPE_UUID_OLD</a></h3><p>OLD UUID BSON type</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Binary.SUBTYPE_UUID_OLD = <span class="hljs-number">3</span>;</code></pre></div><hr></div><div class="item static public"><h3 id="binary_module.exports"><a href="#binary_module.exports">module.exports</a></h3><p>Expose.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="hljs-built_in">module</span>.exports = Binary;
<span class="hljs-built_in">module</span>.exports.Binary = Binary;</code></pre></div><hr></div></li><li class="module"><a href="https://github.com/archangel-irk/storage/blob/0.0.1/lib/binaryparser.js" id="binaryparser-js">binaryparser.js</a><div class="item method public"><h3 id="binaryparser_BinaryParserBuffer"><a href="#binaryparser_BinaryParserBuffer">BinaryParserBuffer()</a></h3><p>BinaryParser buffer constructor.</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">BinaryParserBuffer</span> <span class="hljs-params">(bigEndian, buffer)</span> </span>{
  <span class="hljs-keyword">this</span>.bigEndian = bigEndian || <span class="hljs-number">0</span>;
  <span class="hljs-keyword">this</span>.buffer = [];
  <span class="hljs-keyword">this</span>.setBuffer(buffer);
}

BinaryParserBuffer.prototype.setBuffer = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setBuffer</span> <span class="hljs-params">(data)</span> </span>{
  <span class="hljs-keyword">var</span> l, i, b;

	<span class="hljs-keyword">if</span> (data) {
    i = l = data.length;
    b = <span class="hljs-keyword">this</span>.buffer = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(l);
		<span class="hljs-keyword">for</span> (; i; b[l - i] = data.charCodeAt(--i));
		<span class="hljs-keyword">this</span>.bigEndian &amp;&amp; b.reverse();
	}
};

BinaryParserBuffer.prototype.hasNeededBits = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hasNeededBits</span> <span class="hljs-params">(neededBits)</span> </span>{
	<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.buffer.length &gt;= -(-neededBits &gt;&gt; <span class="hljs-number">3</span>);
};

BinaryParserBuffer.prototype.checkBuffer = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkBuffer</span> <span class="hljs-params">(neededBits)</span> </span>{
	<span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.hasNeededBits(neededBits)) {
		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"checkBuffer::missing bytes"</span>);
  }
};

BinaryParserBuffer.prototype.readBits = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readBits</span> <span class="hljs-params">(start, length)</span> </span>{
	<span class="hljs-comment">//shl fix: Henri Torgemane ~1996 (compressed by Jonas Raoni)</span>

	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">shl</span> <span class="hljs-params">(a, b)</span> </span>{
		<span class="hljs-keyword">for</span> (; b--; a = ((a %= <span class="hljs-number">0x7fffffff</span> + <span class="hljs-number">1</span>) &amp; <span class="hljs-number">0x40000000</span>) == <span class="hljs-number">0x40000000</span> ? a * <span class="hljs-number">2</span> : (a - <span class="hljs-number">0x40000000</span>) * <span class="hljs-number">2</span> + <span class="hljs-number">0x7fffffff</span> + <span class="hljs-number">1</span>);
		<span class="hljs-keyword">return</span> a;
	}

	<span class="hljs-keyword">if</span> (start &lt; <span class="hljs-number">0</span> || length &lt;= <span class="hljs-number">0</span>) {
		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
  }

	<span class="hljs-keyword">this</span>.checkBuffer(start + length);

  <span class="hljs-keyword">var</span> offsetLeft
    , offsetRight = start % <span class="hljs-number">8</span>
    , curByte = <span class="hljs-keyword">this</span>.buffer.length - ( start &gt;&gt; <span class="hljs-number">3</span> ) - <span class="hljs-number">1</span>
    , lastByte = <span class="hljs-keyword">this</span>.buffer.length + ( -( start + length ) &gt;&gt; <span class="hljs-number">3</span> )
    , diff = curByte - lastByte
    , sum = ((<span class="hljs-keyword">this</span>.buffer[ curByte ] &gt;&gt; offsetRight) &amp; ((<span class="hljs-number">1</span> &lt;&lt; (diff ? <span class="hljs-number">8</span> - offsetRight : length)) - <span class="hljs-number">1</span>)) + (diff &amp;&amp; (offsetLeft = (start + length) % <span class="hljs-number">8</span>) ? (<span class="hljs-keyword">this</span>.buffer[lastByte++] &amp; ((<span class="hljs-number">1</span> &lt;&lt; offsetLeft) - <span class="hljs-number">1</span>)) &lt;&lt; (diff-- <span class="xml"><span class="hljs-tag">&lt;&lt; <span class="hljs-attribute">3</span>) <span class="hljs-attribute">-</span> <span class="hljs-attribute">offsetRight</span> <span class="hljs-attribute">:</span> <span class="hljs-attribute">0</span>);

	<span class="hljs-attribute">for</span>(; <span class="hljs-attribute">diff</span>; <span class="hljs-attribute">sum</span> += <span class="hljs-attribute">shl</span>(<span class="hljs-attribute">this.buffer</span>[<span class="hljs-attribute">lastByte</span>++], (<span class="hljs-attribute">diff--</span> &lt;&lt; <span class="hljs-attribute">3</span>) <span class="hljs-attribute">-</span> <span class="hljs-attribute">offsetRight</span>));

	<span class="hljs-attribute">return</span> <span class="hljs-attribute">sum</span>;
};</span></span></code></pre></div><hr></div><div class="item method public"><h3 id="binaryparser_"><a href="#binaryparser_">()</a></h3><p>Binary Parser.<br />Jonas Raoni Soares Silva<br /><a href="http://jsfromhell.com/classes/binary-parser">http://jsfromhell.com/classes/binary-parser</a> [v1.0]</p><div class="see"><h4>See:</h4><ul class="see"><li><a href="https://github.com/mongodb/js-bson/blob/master/lib/bson/binary_parser.js">https://github.com/mongodb/js-bson/blob/master/lib/bson/binary_parser.js</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="hljs-keyword">var</span> chr = <span class="hljs-built_in">String</span>.fromCharCode;

<span class="hljs-keyword">var</span> maxBits = [];
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">64</span>; i++) {
	maxBits[i] = <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">2</span>, i);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">BinaryParser</span> <span class="hljs-params">(bigEndian, allowExceptions)</span> </span>{
  <span class="hljs-keyword">if</span>(!(<span class="hljs-keyword">this</span> <span class="hljs-keyword">instanceof</span> BinaryParser)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> BinaryParser(bigEndian, allowExceptions);
  
	<span class="hljs-keyword">this</span>.bigEndian = bigEndian;
	<span class="hljs-keyword">this</span>.allowExceptions = allowExceptions;
}

BinaryParser.warn = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">warn</span> <span class="hljs-params">(msg)</span> </span>{
	<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.allowExceptions) {
		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(msg);
  }

	<span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
};

BinaryParser.decodeInt = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">decodeInt</span> <span class="hljs-params">(data, bits, signed, forceBigEndian)</span> </span>{
  <span class="hljs-keyword">var</span> b = <span class="hljs-keyword">new</span> <span class="hljs-keyword">this</span>.Buffer(<span class="hljs-keyword">this</span>.bigEndian || forceBigEndian, data)
      , x = b.readBits(<span class="hljs-number">0</span>, bits)
      , max = maxBits[bits]; <span class="hljs-comment">//max = Math.pow( 2, bits );</span>
  
  <span class="hljs-keyword">return</span> signed &amp;&amp; x &gt;= max / <span class="hljs-number">2</span>
      ? x - max
      : x;
};

BinaryParser.encodeInt = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">encodeInt</span> <span class="hljs-params">(data, bits, signed, forceBigEndian)</span> </span>{
	<span class="hljs-keyword">var</span> max = maxBits[bits];

  <span class="hljs-keyword">if</span> (data &gt;= max || data &lt; -(max / <span class="hljs-number">2</span>)) {
    <span class="hljs-keyword">this</span>.warn(<span class="hljs-string">"encodeInt::overflow"</span>);
    data = <span class="hljs-number">0</span>;
  }

	<span class="hljs-keyword">if</span> (data &lt; <span class="hljs-number">0</span>) {
    data += max;
  }

	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> r = []; data; r[r.length] = <span class="hljs-built_in">String</span>.fromCharCode(data % <span class="hljs-number">256</span>), data = <span class="hljs-built_in">Math</span>.floor(data / <span class="hljs-number">256</span>));

	<span class="hljs-keyword">for</span> (bits = -(-bits &gt;&gt; <span class="hljs-number">3</span>) - r.length; bits--; r[r.length] = <span class="hljs-string">"\0"</span>);

  <span class="hljs-keyword">return</span> ((<span class="hljs-keyword">this</span>.bigEndian || forceBigEndian) ? r.reverse() : r).join(<span class="hljs-string">""</span>);
};

BinaryParser.toSmall    = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( data )</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.decodeInt( data,  <span class="hljs-number">8</span>, <span class="hljs-literal">true</span>  ); };
BinaryParser.fromSmall  = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( data )</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.encodeInt( data,  <span class="hljs-number">8</span>, <span class="hljs-literal">true</span>  ); };
BinaryParser.toByte     = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( data )</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.decodeInt( data,  <span class="hljs-number">8</span>, <span class="hljs-literal">false</span> ); };
BinaryParser.fromByte   = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( data )</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.encodeInt( data,  <span class="hljs-number">8</span>, <span class="hljs-literal">false</span> ); };
BinaryParser.toShort    = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( data )</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.decodeInt( data, <span class="hljs-number">16</span>, <span class="hljs-literal">true</span>  ); };
BinaryParser.fromShort  = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( data )</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.encodeInt( data, <span class="hljs-number">16</span>, <span class="hljs-literal">true</span>  ); };
BinaryParser.toWord     = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( data )</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.decodeInt( data, <span class="hljs-number">16</span>, <span class="hljs-literal">false</span> ); };
BinaryParser.fromWord   = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( data )</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.encodeInt( data, <span class="hljs-number">16</span>, <span class="hljs-literal">false</span> ); };
BinaryParser.toInt      = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( data )</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.decodeInt( data, <span class="hljs-number">32</span>, <span class="hljs-literal">true</span>  ); };
BinaryParser.fromInt    = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( data )</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.encodeInt( data, <span class="hljs-number">32</span>, <span class="hljs-literal">true</span>  ); };
BinaryParser.toLong     = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( data )</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.decodeInt( data, <span class="hljs-number">64</span>, <span class="hljs-literal">true</span>  ); };
BinaryParser.fromLong   = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( data )</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.encodeInt( data, <span class="hljs-number">64</span>, <span class="hljs-literal">true</span>  ); };
BinaryParser.toDWord    = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( data )</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.decodeInt( data, <span class="hljs-number">32</span>, <span class="hljs-literal">false</span> ); };
BinaryParser.fromDWord  = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( data )</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.encodeInt( data, <span class="hljs-number">32</span>, <span class="hljs-literal">false</span> ); };
BinaryParser.toQWord    = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( data )</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.decodeInt( data, <span class="hljs-number">64</span>, <span class="hljs-literal">true</span> ); };
BinaryParser.fromQWord  = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( data )</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.encodeInt( data, <span class="hljs-number">64</span>, <span class="hljs-literal">true</span> ); };</code></pre></div><hr></div><div class="item static public"><h3 id="binaryparser_BinaryParser.Buffer"><a href="#binaryparser_BinaryParser.Buffer">BinaryParser.Buffer</a></h3><p>Expose.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">BinaryParser.Buffer = BinaryParserBuffer;

exports.BinaryParser = BinaryParser;</code></pre></div><hr></div></li><li class="module"><a href="https://github.com/archangel-irk/storage/blob/0.0.1/lib/document.js" id="document-js">document.js</a><div class="item method public"><h3 id="document_Document"><a href="#document_Document">Document(<code>data</code>, <code>[collectionName]</code>, <code>schema</code>, <code>[fields]</code>, <code>[init]</code>)</a></h3><p>Конструктор документа.</p><div class="params"><h4>Parameters:</h4><ul><li><code>data</code><span class="types"> &lt;<a href="#object">object</a>&gt; </span><span>- значения, которые нужно установить</span></li><li><code>[collectionName]</code><span class="types"> &lt;<a href="#string">string</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/undefined">undefined</a>&gt; </span><span>- коллекция в которой будет находится документ</span></li><li><code>schema</code><span class="types"> &lt;<a href="#schema_Schema">Schema</a>&gt; </span><span>- схема по которой будет создан документ</span></li><li><code>[fields]</code><span class="types"> &lt;<a href="#object">object</a>&gt; </span><span>- выбранные поля в документе (не реализовано)</span></li><li><code>[init]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span>- hydrate document - наполнить документ данными (используется в api-client)</span></li></ul></div><div class="description"></div><hr></div><div class="item method private"><h3 id="document_Document-%24__buildDoc"><a href="#document_Document-%24__buildDoc">Document#$__buildDoc(<code>obj</code>, <code>[skipId]</code>)</a></h3><p>Builds the default doc structure</p><div class="params"><h4>Parameters:</h4><ul><li><code>obj</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[skipId]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="description"></div><hr class="private"></div><div class="item method private"><h3 id="document_Document-init"><a href="#document_Document-init">Document#init(<code>data</code>)</a></h3><p>Initializes the document without setters or marking anything modified.</p><div class="params"><h4>Parameters:</h4><ul><li><code>data</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>document returned by server</span></li></ul></div><div class="description"><p>Called internally after a document is returned from server.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.init = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( data )</span> </span>{
  <span class="hljs-keyword">this</span>.isNew = <span class="hljs-literal">false</span>;

  <span class="hljs-comment">//todo: сдесь всё изменится, смотреть коммент метода this.populated</span>
  <span class="hljs-comment">// handle docs with populated paths</span></code></pre></div><hr class="private"></div><div class="item method public"><h3 id="document_Document-set"><a href="#document_Document-set">Document#set(<code>path</code>, <code>val</code>, <code>[type]</code>, <code>[options]</code>)</a></h3><p>Sets the value of a path, or many paths.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>path or object of key/vals to set</span></li><li><code>val</code><span class="types"> &lt;<a href="#schema_mixed_Mixed">Mixed</a>&gt; </span><span>the value to set</span></li><li><code>[type]</code><span class="types"> &lt;<a href="#schema_Schema">Schema</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>, <a href="#etc..">etc..</a>&gt; </span><span>optionally specify a type for &quot;on-the-fly&quot; attributes</span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>optionally specify options that modify the behavior of the set</span></li></ul></div><div class="description"><h4>Example:</h4>
<pre><code><span class="hljs-comment">// path, value</span>
doc.set(path, value)

<span class="hljs-comment">// object</span>
doc.set({
    path  : value
  , path2 : {
       path  : value
    }
})

<span class="hljs-comment">// only-the-fly cast to number</span>
doc.set(path, value, <span class="hljs-built_in">Number</span>)

<span class="hljs-comment">// only-the-fly cast to string</span>
doc.set(path, value, <span class="hljs-built_in">String</span>)

<span class="hljs-comment">// changing strict mode behavior</span>
doc.set(path, value, { strict: <span class="hljs-literal">false</span> });</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.set = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(path, val, type, options)</span> </span>{
  <span class="hljs-keyword">if</span> (type &amp;&amp; <span class="hljs-string">'Object'</span> == utils.getFunctionName(type.constructor)) {
    options = type;
    type = <span class="hljs-literal">undefined</span>;
  }

  <span class="hljs-keyword">var</span> merge = options &amp;&amp; options.merge
    , adhoc = type &amp;&amp; <span class="hljs-literal">true</span> !== type
    , constructing = <span class="hljs-literal">true</span> === type
    , adhocs;

  <span class="hljs-keyword">var</span> strict = options &amp;&amp; <span class="hljs-string">'strict'</span> <span class="hljs-keyword">in</span> options
    ? options.strict
    : <span class="hljs-keyword">this</span>.$__.strictMode;

  <span class="hljs-keyword">if</span> (adhoc) {
    adhocs = <span class="hljs-keyword">this</span>.$__.adhocPaths || (<span class="hljs-keyword">this</span>.$__.adhocPaths = {});
    adhocs[path] = Schema.interpretAsType(path, type);
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-string">'string'</span> !== <span class="hljs-keyword">typeof</span> path) {
    <span class="hljs-comment">// new Document({ key: val })</span>

    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> === path || <span class="hljs-literal">undefined</span> === path) {
      <span class="hljs-keyword">var</span> _temp = path;
      path = val;
      val = _temp;

    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">var</span> prefix = val
        ? val + <span class="hljs-string">'.'</span>
        : <span class="hljs-string">''</span>;

      <span class="hljs-keyword">if</span> (path <span class="hljs-keyword">instanceof</span> Document) path = path._doc;

      <span class="hljs-keyword">var</span> keys = <span class="hljs-built_in">Object</span>.keys(path)
        , i = keys.length
        , pathtype
        , key;


      <span class="hljs-keyword">while</span> (i--) {
        key = keys[i];
        pathtype = <span class="hljs-keyword">this</span>.schema.pathType(prefix + key);
        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != path[key]
            <span class="hljs-comment">// need to know if plain object - no Buffer, ObjectId, ref, etc</span>
            &amp;&amp; _.isPlainObject(path[key])
            &amp;&amp; ( !path[key].constructor || <span class="hljs-string">'Object'</span> == utils.getFunctionName(path[key].constructor) )
            &amp;&amp; <span class="hljs-string">'virtual'</span> != pathtype
            &amp;&amp; !( <span class="hljs-keyword">this</span>.$__path( prefix + key ) <span class="hljs-keyword">instanceof</span> MixedSchema )
            &amp;&amp; !( <span class="hljs-keyword">this</span>.schema.paths[key] &amp;&amp; <span class="hljs-keyword">this</span>.schema.paths[key].options.ref )
          ){

          <span class="hljs-keyword">this</span>.set(path[key], prefix + key, constructing);

        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (strict) {
          <span class="hljs-keyword">if</span> (<span class="hljs-string">'real'</span> === pathtype || <span class="hljs-string">'virtual'</span> === pathtype) {
            <span class="hljs-keyword">this</span>.set(prefix + key, path[key], constructing);

          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">'throw'</span> == strict) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Field `"</span> + key + <span class="hljs-string">"` is not in schema."</span>);
          }

        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-literal">undefined</span> !== path[key]) {
          <span class="hljs-keyword">this</span>.set(prefix + key, path[key], constructing);
        }
      }

      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    }
  }

  <span class="hljs-comment">// ensure _strict is honored for obj props</span>
  <span class="hljs-comment">// docschema = new Schema({ path: { nest: 'string' }})</span>
  <span class="hljs-comment">// doc.set('path', obj);</span>
  <span class="hljs-keyword">var</span> pathType = <span class="hljs-keyword">this</span>.schema.pathType(path);
  <span class="hljs-keyword">if</span> (<span class="hljs-string">'nested'</span> == pathType &amp;&amp; val &amp;&amp; _.isPlainObject(val) &amp;&amp;
      (!val.constructor || <span class="hljs-string">'Object'</span> == utils.getFunctionName(val.constructor))) {
    <span class="hljs-keyword">if</span> (!merge) <span class="hljs-keyword">this</span>.setValue(path, <span class="hljs-literal">null</span>);
    <span class="hljs-keyword">this</span>.set(val, path, constructing);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  }

  <span class="hljs-keyword">var</span> schema;
  <span class="hljs-keyword">var</span> parts = path.split(<span class="hljs-string">'.'</span>);
  <span class="hljs-keyword">var</span> subpath;

  <span class="hljs-keyword">if</span> (<span class="hljs-string">'adhocOrUndefined'</span> == pathType &amp;&amp; strict) {

    <span class="hljs-comment">// check for roots that are Mixed types</span>
    <span class="hljs-keyword">var</span> mixed;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; parts.length; ++i) {
      subpath = parts.slice(<span class="hljs-number">0</span>, i+<span class="hljs-number">1</span>).join(<span class="hljs-string">'.'</span>);
      schema = <span class="hljs-keyword">this</span>.schema.path(subpath);
      <span class="hljs-keyword">if</span> (schema <span class="hljs-keyword">instanceof</span> MixedSchema) {
        <span class="hljs-comment">// allow changes to sub paths of mixed types</span>
        mixed = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">break</span>;
      }
    }

    <span class="hljs-keyword">if</span> (!mixed) {
      <span class="hljs-keyword">if</span> (<span class="hljs-string">'throw'</span> == strict) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Field `"</span> + path + <span class="hljs-string">"` is not in schema."</span>);
      }
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    }

  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">'virtual'</span> == pathType) {
    schema = <span class="hljs-keyword">this</span>.schema.virtualpath(path);
    schema.applySetters(val, <span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  } <span class="hljs-keyword">else</span> {
    schema = <span class="hljs-keyword">this</span>.$__path(path);
  }

  <span class="hljs-keyword">var</span> pathToMark;

  <span class="hljs-comment">// When using the $set operator the path to the field must already exist.</span>
  <span class="hljs-comment">// Else mongodb throws: "LEFT_SUBFIELD only supports Object"</span>

  <span class="hljs-keyword">if</span> (parts.length &lt;= <span class="hljs-number">1</span>) {
    pathToMark = path;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt; parts.length; ++i ) {
      subpath = parts.slice(<span class="hljs-number">0</span>, i + <span class="hljs-number">1</span>).join(<span class="hljs-string">'.'</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isDirectModified(subpath) <span class="hljs-comment">// earlier prefixes that are already</span>
                                         <span class="hljs-comment">// marked as dirty have precedence</span>
          || <span class="hljs-keyword">this</span>.get(subpath) === <span class="hljs-literal">null</span>) {
        pathToMark = subpath;
        <span class="hljs-keyword">break</span>;
      }
    }

    <span class="hljs-keyword">if</span> (!pathToMark) pathToMark = path;
  }

  <span class="hljs-comment">// if this doc is being constructed we should not trigger getters</span>
  <span class="hljs-keyword">var</span> priorVal = constructing
    ? <span class="hljs-literal">undefined</span>
    : <span class="hljs-keyword">this</span>.getValue(path);

  <span class="hljs-keyword">if</span> (!schema || <span class="hljs-literal">undefined</span> === val) {
    <span class="hljs-keyword">this</span>.$__set(pathToMark, path, constructing, parts, schema, val, priorVal);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  }

  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">var</span> shouldSet = <span class="hljs-keyword">this</span>.$__try(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
    val = schema.applySetters(val, self, <span class="hljs-literal">false</span>, priorVal);
  });

  <span class="hljs-keyword">if</span> (shouldSet) {
    <span class="hljs-keyword">this</span>.$__set(pathToMark, path, constructing, parts, schema, val, priorVal);
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</code></pre></div><hr></div><div class="item method private"><h3 id="document_Document-%24__shouldModify"><a href="#document_Document-%24__shouldModify">Document#$__shouldModify()</a></h3><p>Determine if we should mark this change as modified.</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="description"></div><hr class="private"></div><div class="item method private"><h3 id="document_Document-%24__set"><a href="#document_Document-%24__set">Document#$__set()</a></h3><p>Handles the actual setting of the value and marking the path modified if appropriate.</p><div class="description"></div><hr class="private"></div><div class="item method private"><h3 id="document_Document-getValue"><a href="#document_Document-getValue">Document#getValue(<code>path</code>)</a></h3><p>Gets a raw value from a path (no getters)</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.getValue = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(path)</span> </span>{
  <span class="hljs-keyword">return</span> utils.getValue(path, <span class="hljs-keyword">this</span>._doc);
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="document_Document-setValue"><a href="#document_Document-setValue">Document#setValue(<code>path</code>, <code>value</code>)</a></h3><p>Sets a raw value for a path (no casting, setters, transformations)</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.setValue = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(path, value)</span> </span>{
  utils.setValue(path, value, <span class="hljs-keyword">this</span>._doc);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="document_Document-get"><a href="#document_Document-get">Document#get(<code>path</code>, <code>[type]</code>)</a></h3><p>Returns the value of a path.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>[type]</code><span class="types"> &lt;<a href="#schema_Schema">Schema</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span>optionally specify a type for on-the-fly attributes</span></li></ul></div><div class="description"><h4>Example</h4>
<pre><code><span class="hljs-comment">// path</span>
doc.get(&amp;#<span class="hljs-number">39</span>;age&amp;#<span class="hljs-number">39</span>;) <span class="hljs-comment">// 47</span>

<span class="hljs-comment">// dynamic casting to a string</span>
doc.get(&amp;#<span class="hljs-number">39</span>;age&amp;#<span class="hljs-number">39</span>;, <span class="hljs-built_in">String</span>) <span class="hljs-comment">// &amp;quot;47&amp;quot;</span></code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.get = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(path, type)</span> </span>{
  <span class="hljs-keyword">var</span> adhocs;
  <span class="hljs-keyword">if</span> (type) {
    adhocs = <span class="hljs-keyword">this</span>.$__.adhocPaths || (<span class="hljs-keyword">this</span>.$__.adhocPaths = {});
    adhocs[path] = Schema.interpretAsType(path, type);
  }

  <span class="hljs-keyword">var</span> schema = <span class="hljs-keyword">this</span>.$__path(path) || <span class="hljs-keyword">this</span>.schema.virtualpath(path)
    , pieces = path.split(<span class="hljs-string">'.'</span>)
    , obj = <span class="hljs-keyword">this</span>._doc;

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = pieces.length; i &lt; l; i++) {
    obj = <span class="hljs-literal">undefined</span> === obj || <span class="hljs-literal">null</span> === obj
      ? <span class="hljs-literal">undefined</span>
      : obj[pieces[i]];
  }

  <span class="hljs-keyword">if</span> (schema) {
    obj = schema.applyGetters(obj, <span class="hljs-keyword">this</span>);
  }

  <span class="hljs-keyword">this</span>.adapterHooks.documentGetValue.call( <span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>, path );

  <span class="hljs-keyword">return</span> obj;
};</code></pre></div><hr></div><div class="item method private"><h3 id="document_Document-%24__path"><a href="#document_Document-%24__path">Document#$__path(<code>path</code>)</a></h3><p>Returns the schematype for the given <code>path</code>.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="description"></div><hr class="private"></div><div class="item method public"><h3 id="document_Document-markModified"><a href="#document_Document-markModified">Document#markModified(<code>path</code>)</a></h3><p>Marks the path as having pending changes to write to the db.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>the path to mark modified</span></li></ul></div><div class="description"><p><em>Very helpful when using <a href="./schematypes.html#mixed">Mixed</a> types.</em></p><h4>Example:</h4>
<pre><code>doc.mixed.type = &amp;#<span class="hljs-number">39</span>;changed&amp;#<span class="hljs-number">39</span>;;
doc.markModified(&amp;#<span class="hljs-number">39</span>;mixed.type&amp;#<span class="hljs-number">39</span>;);
doc.save() <span class="hljs-comment">// changes to mixed.type are now persisted</span></code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.markModified = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(path)</span> </span>{
  <span class="hljs-keyword">this</span>.$__.activePaths.modify(path);
};</code></pre></div><hr></div><div class="item method private"><h3 id="document_Document-%24__try"><a href="#document_Document-%24__try">Document#$__try(<code>fn</code>, <code>[scope]</code>)</a></h3><p>Catches errors that occur during execution of <code>fn</code> and stores them to later be passed when <code>save()</code> is executed.</p><div class="params"><h4>Parameters:</h4><ul><li><code>fn</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>function to execute</span></li><li><code>[scope]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>the scope with which to call fn</span></li></ul></div><div class="description"></div><hr class="private"></div><div class="item method public"><h3 id="document_Document-modifiedPaths"><a href="#document_Document-modifiedPaths">Document#modifiedPaths()</a></h3><p>Returns the list of paths that have been modified.</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.modifiedPaths = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> directModifiedPaths = <span class="hljs-built_in">Object</span>.keys(<span class="hljs-keyword">this</span>.$__.activePaths.states.modify);

  <span class="hljs-keyword">return</span> directModifiedPaths.reduce(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(list, path)</span> </span>{
    <span class="hljs-keyword">var</span> parts = path.split(<span class="hljs-string">'.'</span>);
    <span class="hljs-keyword">return</span> list.concat(parts.reduce(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(chains, part, i)</span> </span>{
      <span class="hljs-keyword">return</span> chains.concat(parts.slice(<span class="hljs-number">0</span>, i).concat(part).join(<span class="hljs-string">'.'</span>));
    }, []));
  }, []);
};</code></pre></div><hr></div><div class="item method public"><h3 id="document_Document-isModified"><a href="#document_Document-isModified">Document#isModified(<code>[path]</code>)</a></h3><p>Returns true if this document was modified, else false.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[path]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>optional</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="description"><p>If <code>path</code> is given, checks if a path or any full path containing <code>path</code> as part of its path chain has been modified.</p><h4>Example</h4>
<pre><code>doc.set(&amp;#<span class="hljs-number">39</span>;documents<span class="hljs-number">.0</span>.title&amp;#<span class="hljs-number">39</span>;, &amp;#<span class="hljs-number">39</span>;changed&amp;#<span class="hljs-number">39</span>;);
doc.isModified()                    <span class="hljs-comment">// true</span>
doc.isModified(&amp;#<span class="hljs-number">39</span>;documents&amp;#<span class="hljs-number">39</span>;)         <span class="hljs-comment">// true</span>
doc.isModified(&amp;#<span class="hljs-number">39</span>;documents<span class="hljs-number">.0</span>.title&amp;#<span class="hljs-number">39</span>;) <span class="hljs-comment">// true</span>
doc.isDirectModified(&amp;#<span class="hljs-number">39</span>;documents&amp;#<span class="hljs-number">39</span>;)   <span class="hljs-comment">// false</span></code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.isModified = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(path)</span> </span>{
  <span class="hljs-keyword">return</span> path
    ? !!~<span class="hljs-keyword">this</span>.modifiedPaths().indexOf(path)
    : <span class="hljs-keyword">this</span>.$__.activePaths.some(<span class="hljs-string">'modify'</span>);
};</code></pre></div><hr></div><div class="item method public"><h3 id="document_Document-isDirectModified"><a href="#document_Document-isDirectModified">Document#isDirectModified(<code>path</code>)</a></h3><p>Returns true if <code>path</code> was directly set and modified, else false.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="description"><h4>Example</h4>
<pre><code>doc.set(&amp;#<span class="hljs-number">39</span>;documents<span class="hljs-number">.0</span>.title&amp;#<span class="hljs-number">39</span>;, &amp;#<span class="hljs-number">39</span>;changed&amp;#<span class="hljs-number">39</span>;);
doc.isDirectModified(&amp;#<span class="hljs-number">39</span>;documents<span class="hljs-number">.0</span>.title&amp;#<span class="hljs-number">39</span>;) <span class="hljs-comment">// true</span>
doc.isDirectModified(&amp;#<span class="hljs-number">39</span>;documents&amp;#<span class="hljs-number">39</span>;) <span class="hljs-comment">// false</span></code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.isDirectModified = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(path)</span> </span>{
  <span class="hljs-keyword">return</span> (path <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.$__.activePaths.states.modify);
};</code></pre></div><hr></div><div class="item method public"><h3 id="document_Document-isInit"><a href="#document_Document-isInit">Document#isInit(<code>path</code>)</a></h3><p>Checks if <code>path</code> was initialized.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.isInit = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(path)</span> </span>{
  <span class="hljs-keyword">return</span> (path <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.$__.activePaths.states.init);
};</code></pre></div><hr></div><div class="item method public"><h3 id="document_Document-isSelected"><a href="#document_Document-isSelected">Document#isSelected(<code>path</code>)</a></h3><p>Checks if <code>path</code> was selected in the source query which initialized this document.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="description"><h4>Example</h4>
<pre><code>Thing.findOne().select(&amp;#<span class="hljs-number">39</span>;name&amp;#<span class="hljs-number">39</span>;).exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc)</span> </span>{
   doc.isSelected(&amp;#<span class="hljs-number">39</span>;name&amp;#<span class="hljs-number">39</span>;) <span class="hljs-comment">// true</span>
   doc.isSelected(&amp;#<span class="hljs-number">39</span>;age&amp;#<span class="hljs-number">39</span>;)  <span class="hljs-comment">// false</span>
})</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.isSelected = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isSelected</span> <span class="hljs-params">(path)</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.$__.selected) {

    <span class="hljs-keyword">if</span> (<span class="hljs-string">'_id'</span> === path) {
      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span> !== <span class="hljs-keyword">this</span>.$__.selected._id;
    }

    <span class="hljs-keyword">var</span> paths = <span class="hljs-built_in">Object</span>.keys(<span class="hljs-keyword">this</span>.$__.selected)
      , i = paths.length
      , inclusive = <span class="hljs-literal">false</span>
      , cur;

    <span class="hljs-keyword">if</span> (<span class="hljs-number">1</span> === i &amp;&amp; <span class="hljs-string">'_id'</span> === paths[<span class="hljs-number">0</span>]) {
      <span class="hljs-comment">// only _id was selected.</span>
      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span> === <span class="hljs-keyword">this</span>.$__.selected._id;
    }

    <span class="hljs-keyword">while</span> (i--) {
      cur = paths[i];
      <span class="hljs-keyword">if</span> (<span class="hljs-string">'_id'</span> == cur) <span class="hljs-keyword">continue</span>;
      inclusive = !! <span class="hljs-keyword">this</span>.$__.selected[cur];
      <span class="hljs-keyword">break</span>;
    }

    <span class="hljs-keyword">if</span> (path <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.$__.selected) {
      <span class="hljs-keyword">return</span> inclusive;
    }

    i = paths.length;
    <span class="hljs-keyword">var</span> pathDot = path + <span class="hljs-string">'.'</span>;

    <span class="hljs-keyword">while</span> (i--) {
      cur = paths[i];
      <span class="hljs-keyword">if</span> (<span class="hljs-string">'_id'</span> == cur) <span class="hljs-keyword">continue</span>;

      <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> === cur.indexOf(pathDot)) {
        <span class="hljs-keyword">return</span> inclusive;
      }

      <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> === pathDot.indexOf(cur + <span class="hljs-string">'.'</span>)) {
        <span class="hljs-keyword">return</span> inclusive;
      }
    }

    <span class="hljs-keyword">return</span> ! inclusive;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
};</code></pre></div><hr></div><div class="item method public"><h3 id="document_Document-validate"><a href="#document_Document-validate">Document#validate(<code>cb</code>)</a></h3><p>Executes registered validation rules for this document.</p><div class="params"><h4>Parameters:</h4><ul><li><code>cb</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>called after validation completes, passing an error if one occurred</span></li></ul></div><div class="description"><h4>Note:</h4>
<p>This method is called <code>pre</code> save and if a validation rule is violated, <a href="#model_Model-save">save</a> is aborted and the error is returned to your <code>callback</code>.</p><h4>Example:</h4>
<pre><code>doc.validate(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
  <span class="hljs-keyword">if</span> (err) handleError(err);
  <span class="hljs-keyword">else</span> <span class="hljs-comment">// validation passed</span>
});</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.validate = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;

  <span class="hljs-comment">// only validate required fields when necessary</span>
  <span class="hljs-keyword">var</span> paths = <span class="hljs-built_in">Object</span>.keys(<span class="hljs-keyword">this</span>.$__.activePaths.states.require).filter(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(path)</span> </span>{
    <span class="hljs-keyword">if</span> (!self.isSelected(path) &amp;&amp; !self.isModified(path)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  });

  paths = paths.concat(<span class="hljs-built_in">Object</span>.keys(<span class="hljs-keyword">this</span>.$__.activePaths.states.init));
  paths = paths.concat(<span class="hljs-built_in">Object</span>.keys(<span class="hljs-keyword">this</span>.$__.activePaths.states.modify));
  paths = paths.concat(<span class="hljs-built_in">Object</span>.keys(<span class="hljs-keyword">this</span>.$__.activePaths.states.default));

  <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> === paths.length) {
    complete();
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  }

  <span class="hljs-keyword">var</span> validating = {}
    , total = <span class="hljs-number">0</span>;

  paths.forEach(validatePath);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">validatePath</span> <span class="hljs-params">(path)</span> </span>{
    <span class="hljs-keyword">if</span> (validating[path]) <span class="hljs-keyword">return</span>;

    validating[path] = <span class="hljs-literal">true</span>;
    total++;

    utils.setImmediate(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
      <span class="hljs-keyword">var</span> p = self.schema.path(path);
      <span class="hljs-keyword">if</span> (!p) <span class="hljs-keyword">return</span> --total || complete();

      <span class="hljs-keyword">var</span> val = self.getValue(path);
      p.doValidate(val, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
        <span class="hljs-keyword">if</span> (err) {
          self.invalidate(
              path
            , err
            , <span class="hljs-literal">undefined</span>
            <span class="hljs-comment">//, true // embedded docs</span>
            );
        }
        --total || complete();
      }, self);
    });
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">complete</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> err = self.$__.validationError;
    self.$__.validationError = <span class="hljs-literal">undefined</span>;
    cb &amp;&amp; cb(err);
  }
};</code></pre></div><hr></div><div class="item method public"><h3 id="document_Document-invalidate"><a href="#document_Document-invalidate">Document#invalidate(<code>path</code>, <code>errorMsg</code>, <code>value</code>)</a></h3><p>Marks a path as invalid, causing validation to fail.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>the field to invalidate</span></li><li><code>errorMsg</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Error">Error</a>&gt; </span><span>the error which states the reason `path` was invalid</span></li><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>, T&gt; </span><span>optional invalid value</span></li></ul></div><div class="description"><p>The <code>errorMsg</code> argument will become the message of the <code>ValidationError</code>.</p><p>The <code>value</code> argument (if passed) will be available through the <code>ValidationError.value</code> property.</p><pre><code>doc.invalidate(&amp;#<span class="hljs-number">39</span>;size&amp;#<span class="hljs-number">39</span>;, &amp;#<span class="hljs-number">39</span>;must be less than <span class="hljs-number">20</span>&amp;#<span class="hljs-number">39</span>;, <span class="hljs-number">14</span>);

doc.validate(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
  <span class="hljs-built_in">console</span>.log(err)
  <span class="hljs-comment">// prints</span>
  { message: &amp;#<span class="hljs-number">39</span>;Validation failed&amp;#<span class="hljs-number">39</span>;,
    name: &amp;#<span class="hljs-number">39</span>;ValidationError&amp;#<span class="hljs-number">39</span>;,
    errors:
     { size:
        { message: &amp;#<span class="hljs-number">39</span>;must be less than <span class="hljs-number">20</span>&amp;#<span class="hljs-number">39</span>;,
          name: &amp;#<span class="hljs-number">39</span>;ValidatorError&amp;#<span class="hljs-number">39</span>;,
          path: &amp;#<span class="hljs-number">39</span>;size&amp;#<span class="hljs-number">39</span>;,
          type: &amp;#<span class="hljs-number">39</span>;user defined&amp;#<span class="hljs-number">39</span>;,
          value: <span class="hljs-number">14</span> } } }
})</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.invalidate = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(path, errorMsg, value)</span> </span>{
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.$__.validationError) {
    <span class="hljs-keyword">this</span>.$__.validationError = <span class="hljs-keyword">new</span> ValidationError(<span class="hljs-keyword">this</span>);
  }

  <span class="hljs-keyword">if</span> (!errorMsg || <span class="hljs-string">'string'</span> === <span class="hljs-keyword">typeof</span> errorMsg) {
    errorMsg = <span class="hljs-keyword">new</span> ValidatorError(path, errorMsg, <span class="hljs-string">'user defined'</span>, value);
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.$__.validationError == errorMsg) <span class="hljs-keyword">return</span>;

  <span class="hljs-keyword">this</span>.$__.validationError.errors[path] = errorMsg;
};</code></pre></div><hr></div><div class="item method private"><h3 id="document_Document-%24__reset"><a href="#document_Document-%24__reset">Document#$__reset()</a></h3><p>Resets the internal modified state of this document.</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#document_Document">Document</a>&gt; </span><span></span></li></ul></div><div class="description"></div><hr class="private"></div><div class="item method private"><h3 id="document_Document-%24__dirty"><a href="#document_Document-%24__dirty">Document#$__dirty()</a></h3><p>Returns this documents dirty paths / vals.</p><div class="description"></div><hr class="private"></div><div class="item method private"><h3 id="document_Document-%24__setSchema"><a href="#document_Document-%24__setSchema">Document#$__setSchema(<code>schema</code>)</a></h3><p>Assigns/compiles <code>schema</code> into this documents prototype.</p><div class="params"><h4>Parameters:</h4><ul><li><code>schema</code><span class="types"> &lt;<a href="#schema_Schema">Schema</a>&gt; </span><span></span></li></ul></div><div class="description"></div><hr class="private"></div><div class="item method private"><h3 id="document_Document-%24__getAllSubdocs"><a href="#document_Document-%24__getAllSubdocs">Document#$__getAllSubdocs()</a></h3><p>Get all subdocs (by bfs)</p><div class="description"></div><hr class="private"></div><div class="item method private"><h3 id="document_Document-%24__presaveValidate"><a href="#document_Document-%24__presaveValidate">Document#$__presaveValidate()</a></h3><p>Handle generic save stuff.<br />to solve #1446 use use hierarchy instead of hooks</p><div class="description"></div><hr class="private"></div><div class="item method private"><h3 id="document_Document-%24__getArrayPathsToValidate"><a href="#document_Document-%24__getArrayPathsToValidate">Document#$__getArrayPathsToValidate()</a></h3><p>Get active path that were changed and are arrays</p><div class="description"></div><hr class="private"></div><div class="item method private"><h3 id="document_Document-%24__error"><a href="#document_Document-%24__error">Document#$__error(<code>err</code>)</a></h3><p>Registers an error</p><div class="params"><h4>Parameters:</h4><ul><li><code>err</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Error">Error</a>&gt; </span><span></span></li></ul></div><div class="description"></div><hr class="private"></div><div class="item method private"><h3 id="document_Document-%24__delta"><a href="#document_Document-%24__delta">Document#$__delta()</a></h3><p>Produces a special query document of the modified properties used in updates.</p><div class="description"></div><hr class="private"></div><div class="item method public"><h3 id="document_Document-save"><a href="#document_Document-save">Document#save(<code>product,</code>)</a></h3><div class="params"><h4>Parameters:</h4><ul><li><code>product,</code><span class="types"> &lt;<a href="#function(err">function(err</a>, <a href="#"></a>&gt; </span><span>Number)} [done] optional callback</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span>Promise</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://mongoosejs.com/docs/middleware.html" title="middleware">middleware</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.save = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( done )</span> </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">var</span> finalPromise = <span class="hljs-keyword">new</span> $.Deferred().done( done );

  <span class="hljs-comment">// Сохранять документ можно только если он находится в коллекции</span>
  <span class="hljs-keyword">if</span> ( !<span class="hljs-keyword">this</span>.collection ){
    finalPromise.reject( <span class="hljs-built_in">arguments</span> );
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Document.save api handle is not implemented.'</span>);
    <span class="hljs-keyword">return</span> finalPromise;
  }

  <span class="hljs-comment">// Check for preSave errors (точо знаю, что она проверяет ошибки в массивах (CastError))</span>
  <span class="hljs-keyword">var</span> preSaveErr = self.$__presaveValidate();
  <span class="hljs-keyword">if</span> ( preSaveErr ) {
    finalPromise.reject( preSaveErr );
    <span class="hljs-keyword">return</span> finalPromise;
  }

  <span class="hljs-comment">// Validate</span>
  <span class="hljs-keyword">var</span> p0 = <span class="hljs-keyword">new</span> $.Deferred();
  self.validate(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( err )</span></span>{
    <span class="hljs-keyword">if</span> ( err ){
      p0.reject( err );
      finalPromise.reject( err );
    } <span class="hljs-keyword">else</span> {
      p0.resolve();
    }
  });

  <span class="hljs-comment">// Сначала надо сохранить все поддокументы и сделать resolve!!!</span>
  <span class="hljs-comment">// Call save hooks on subdocs</span>
  <span class="hljs-keyword">var</span> subDocs = self.$__getAllSubdocs();
  <span class="hljs-keyword">var</span> whenCond = subDocs.map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{<span class="hljs-keyword">return</span> d.save();});
  whenCond.push( p0 );

  <span class="hljs-comment">// Так мы передаём массив promise условий</span>
  <span class="hljs-keyword">var</span> p1 = $.when.apply( $, whenCond );

  <span class="hljs-comment">// Handle save and results</span>
  p1
    .then( <span class="hljs-keyword">this</span>.$__handleSave.bind( <span class="hljs-keyword">this</span> ) )
    .then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
      <span class="hljs-keyword">return</span> finalPromise.resolve( self );
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( err )</span> </span>{
      <span class="hljs-comment">// If the initial insert fails provide a second chance.</span>
      <span class="hljs-comment">// (If we did this all the time we would break updates)</span>
      <span class="hljs-keyword">if</span> (self.$__.inserting) {
        self.isNew = <span class="hljs-literal">true</span>;
        self.emit(<span class="hljs-string">'isNew'</span>, <span class="hljs-literal">true</span>);
      }
      finalPromise.reject( err );
    });

  <span class="hljs-keyword">return</span> finalPromise;
};</code></pre></div><hr></div><div class="item method public"><h3 id="document_Document-toObject"><a href="#document_Document-toObject">Document#toObject(<code>[options]</code>)</a></h3><p>Converts this document into a plain javascript object, ready for storage in MongoDB.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>js object</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://mongodb.github.com/node-mongodb-native/api-bson-generated/binary.html" title="mongodb.Binary">mongodb.Binary</a></li></ul></div><div class="description"><p>Buffers are converted to instances of <a href="http://mongodb.github.com/node-mongodb-native/api-bson-generated/binary.html">mongodb.Binary</a> for proper storage.</p><h4>Options:</h4>
<ul>
<li><code>getters</code> apply all getters (path and virtual getters)</li>
<li><code>virtuals</code> apply virtual getters (can override <code>getters</code> option)</li>
<li><code>minimize</code> remove empty objects (defaults to true)</li>
<li><code>transform</code> a transform function to apply to the resulting document before returning</li>
</ul>
<h4>Getters/Virtuals</h4>
<p>Example of only applying path getters</p><pre><code>doc.toObject({ getters: <span class="hljs-literal">true</span>, virtuals: <span class="hljs-literal">false</span> })</code></pre><p>Example of only applying virtual getters</p><pre><code>doc.toObject({ virtuals: <span class="hljs-literal">true</span> })</code></pre><p>Example of applying both path and virtual getters</p><pre><code>doc.toObject({ getters: <span class="hljs-literal">true</span> })</code></pre><p>To apply these options to every document of your schema by default, set your <a href="#schema_Schema">schemas</a> <code>toObject</code> option to the same argument.</p><pre><code>schema.set(&amp;#<span class="hljs-number">39</span>;toObject&amp;#<span class="hljs-number">39</span>;, { virtuals: <span class="hljs-literal">true</span> })</code></pre><h4>Transform</h4>
<p>We may need to perform a transformation of the resulting object based on some criteria, say to remove some sensitive information or return a custom object. In this case we set the optional <code>transform</code> function.</p><p>Transform functions receive three arguments</p><pre><code><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc, ret, options)</span> </span>{}</code></pre><ul>
<li><code>doc</code> The mongoose document which is being converted</li>
<li><code>ret</code> The plain object representation which has been converted</li>
<li><code>options</code> The options in use (either schema options or the options passed inline)</li>
</ul>
<h4>Example</h4>
<pre><code><span class="hljs-comment">// specify the transform schema option</span>
<span class="hljs-keyword">if</span> (!schema.options.toObject) schema.options.toObject = {};
schema.options.toObject.transform = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc, ret, options)</span> </span>{
  <span class="hljs-comment">// remove the _id of every document before returning the result</span>
  <span class="hljs-keyword">delete</span> ret._id;
}

<span class="hljs-comment">// without the transformation in the schema</span>
doc.toObject(); <span class="hljs-comment">// { _id: &amp;#39;anId&amp;#39;, name: &amp;#39;Wreck-it Ralph&amp;#39; }</span>

<span class="hljs-comment">// with the transformation</span>
doc.toObject(); <span class="hljs-comment">// { name: &amp;#39;Wreck-it Ralph&amp;#39; }</span></code></pre><p>With transformations we can do a lot more than remove properties. We can even return completely new customized objects:</p><pre><code><span class="hljs-keyword">if</span> (!schema.options.toObject) schema.options.toObject = {};
schema.options.toObject.transform = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc, ret, options)</span> </span>{
  <span class="hljs-keyword">return</span> { movie: ret.name }
}

<span class="hljs-comment">// without the transformation in the schema</span>
doc.toObject(); <span class="hljs-comment">// { _id: &amp;#39;anId&amp;#39;, name: &amp;#39;Wreck-it Ralph&amp;#39; }</span>

<span class="hljs-comment">// with the transformation</span>
doc.toObject(); <span class="hljs-comment">// { movie: &amp;#39;Wreck-it Ralph&amp;#39; }</span></code></pre><p><em>Note: if a transform function returns <code>undefined</code>, the return value will be ignored.</em></p><p>Transformations may also be applied inline, overridding any transform set in the options:</p><pre><code><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">xform</span> <span class="hljs-params">(doc, ret, options)</span> </span>{
  <span class="hljs-keyword">return</span> { inline: ret.name, custom: <span class="hljs-literal">true</span> }
}

<span class="hljs-comment">// pass the transform as an inline option</span>
doc.toObject({ transform: xform }); <span class="hljs-comment">// { inline: &amp;#39;Wreck-it Ralph&amp;#39;, custom: true }</span></code></pre><p><em>Note: if you call <code>toObject</code> and pass any options, the transform declared in your schema options will <strong>not</strong> be applied. To force its application pass <code>transform: true</code></em></p><pre><code><span class="hljs-keyword">if</span> (!schema.options.toObject) schema.options.toObject = {};
schema.options.toObject.hide = &amp;#<span class="hljs-number">39</span>;_id&amp;#<span class="hljs-number">39</span>;;
schema.options.toObject.transform = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc, ret, options)</span> </span>{
  <span class="hljs-keyword">if</span> (options.hide) {
    options.hide.split(&amp;#<span class="hljs-number">39</span>; &amp;#<span class="hljs-number">39</span>;).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(prop)</span> </span>{
      <span class="hljs-keyword">delete</span> ret[prop];
    });
  }
}

<span class="hljs-keyword">var</span> doc = <span class="hljs-keyword">new</span> Doc({ _id: &amp;#<span class="hljs-number">39</span>;anId&amp;#<span class="hljs-number">39</span>;, secret: <span class="hljs-number">47</span>, name: &amp;#<span class="hljs-number">39</span>;Wreck-it Ralph&amp;#<span class="hljs-number">39</span>; });
doc.toObject();                                        <span class="hljs-comment">// { secret: 47, name: &amp;#39;Wreck-it Ralph&amp;#39; }</span>
doc.toObject({ hide: &amp;#<span class="hljs-number">39</span>;secret _id&amp;#<span class="hljs-number">39</span>; });                  <span class="hljs-comment">// { _id: &amp;#39;anId&amp;#39;, secret: 47, name: &amp;#39;Wreck-it Ralph&amp;#39; }</span>
doc.toObject({ hide: &amp;#<span class="hljs-number">39</span>;secret _id&amp;#<span class="hljs-number">39</span>;, transform: <span class="hljs-literal">true</span> }); <span class="hljs-comment">// { name: &amp;#39;Wreck-it Ralph&amp;#39; }</span></code></pre><p>Transforms are applied to the document <em>and each of its sub-documents</em>. To determine whether or not you are currently operating on a sub-document you might use the following guard:</p><pre><code><span class="hljs-keyword">if</span> (&amp;#<span class="hljs-number">39</span>;<span class="hljs-function"><span class="hljs-keyword">function</span>&amp;#39; == <span class="hljs-title">typeof</span> <span class="hljs-title">doc</span>.<span class="hljs-title">ownerDocument</span>) </span>{
  <span class="hljs-comment">// working with a sub doc</span>
}</code></pre><p>Transforms, like all of these options, are also available for <code>toJSON</code>.</p><p>See <a href="/docs/guide.html#toObject">schema options</a> for some more details.</p><p><em>During save, no custom options are applied to the document before being sent to the database.</em></p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.toObject = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> </span>{
  <span class="hljs-keyword">if</span> (options &amp;&amp; options.depopulate &amp;&amp; <span class="hljs-keyword">this</span>.$__.wasPopulated) {
    <span class="hljs-comment">// populated paths that we set to a document</span>
    <span class="hljs-keyword">return</span> utils.clone(<span class="hljs-keyword">this</span>._id, options);
  }

  <span class="hljs-comment">// When internally saving this document we always pass options,</span>
  <span class="hljs-comment">// bypassing the custom schema options.</span>
  <span class="hljs-keyword">var</span> optionsParameter = options;
  <span class="hljs-keyword">if</span> (!(options &amp;&amp; <span class="hljs-string">'Object'</span> == utils.getFunctionName(options.constructor)) ||
    (options &amp;&amp; options._useSchemaOptions)) {
    options = <span class="hljs-keyword">this</span>.schema.options.toObject
      ? clone(<span class="hljs-keyword">this</span>.schema.options.toObject)
      : {};
  }

  <span class="hljs-keyword">if</span> ( options.minimize === <span class="hljs-literal">undefined</span> ){
    options.minimize = <span class="hljs-keyword">this</span>.schema.options.minimize;
  }

  <span class="hljs-keyword">if</span> (!optionsParameter) {
    options._useSchemaOptions = <span class="hljs-literal">true</span>;
  }

  <span class="hljs-keyword">var</span> ret = utils.clone(<span class="hljs-keyword">this</span>._doc, options);

  <span class="hljs-keyword">if</span> (options.virtuals || options.getters &amp;&amp; <span class="hljs-literal">false</span> !== options.virtuals) {
    applyGetters(<span class="hljs-keyword">this</span>, ret, <span class="hljs-string">'virtuals'</span>, options);
  }

  <span class="hljs-keyword">if</span> (options.getters) {
    applyGetters(<span class="hljs-keyword">this</span>, ret, <span class="hljs-string">'paths'</span>, options);
    <span class="hljs-comment">// applyGetters for paths will add nested empty objects;</span>
    <span class="hljs-comment">// if minimize is set, we need to remove them.</span>
    <span class="hljs-keyword">if</span> (options.minimize) {
      ret = minimize(ret) || {};
    }
  }

  <span class="hljs-comment">// In the case where a subdocument has its own transform function, we need to</span>
  <span class="hljs-comment">// check and see if the parent has a transform (options.transform) and if the</span>
  <span class="hljs-comment">// child schema has a transform (this.schema.options.toObject) In this case,</span>
  <span class="hljs-comment">// we need to adjust options.transform to be the child schema's transform and</span>
  <span class="hljs-comment">// not the parent schema's</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">true</span> === options.transform ||
      (<span class="hljs-keyword">this</span>.schema.options.toObject &amp;&amp; options.transform)) {
    <span class="hljs-keyword">var</span> opts = options.json
      ? <span class="hljs-keyword">this</span>.schema.options.toJSON
      : <span class="hljs-keyword">this</span>.schema.options.toObject;
    <span class="hljs-keyword">if</span> (opts) {
      options.transform = opts.transform;
    }
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-string">'function'</span> == <span class="hljs-keyword">typeof</span> options.transform) {
    <span class="hljs-keyword">var</span> xformed = options.transform(<span class="hljs-keyword">this</span>, ret, options);
    <span class="hljs-keyword">if</span> (<span class="hljs-string">'undefined'</span> != <span class="hljs-keyword">typeof</span> xformed) ret = xformed;
  }

  <span class="hljs-keyword">return</span> ret;
};</code></pre></div><hr></div><div class="item method public"><h3 id="document_Document-toJSON"><a href="#document_Document-toJSON">Document#toJSON(<code>options</code>)</a></h3><p>The return value of this method is used in calls to JSON.stringify(doc).</p><div class="params"><h4>Parameters:</h4><ul><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#document_Document-toObject" title="Document#toObject">Document#toObject</a></li></ul></div><div class="description"><p>This method accepts the same options as <a href="#document_Document-toObject">Document#toObject</a>. To apply the options to every document of your schema by default, set your <a href="#schema_Schema">schemas</a> <code>toJSON</code> option to the same argument.</p><pre><code>schema.set(&amp;#<span class="hljs-number">39</span>;toJSON&amp;#<span class="hljs-number">39</span>;, { virtuals: <span class="hljs-literal">true</span> })</code></pre><p>See <a href="/docs/guide.html#toJSON">schema options</a> for details.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.toJSON = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> </span>{
  <span class="hljs-comment">// check for object type since an array of documents</span>
  <span class="hljs-comment">// being stringified passes array indexes instead</span>
  <span class="hljs-comment">// of options objects. JSON.stringify([doc, doc])</span>
  <span class="hljs-comment">// The second check here is to make sure that populated documents (or</span>
  <span class="hljs-comment">// subdocuments) use their own options for `.toJSON()` instead of their</span>
  <span class="hljs-comment">// parent's</span>
  <span class="hljs-keyword">if</span> (!(options &amp;&amp; <span class="hljs-string">'Object'</span> == utils.getFunctionName(options.constructor))
      || ((!options || options.json) &amp;&amp; <span class="hljs-keyword">this</span>.schema.options.toJSON)) {

    options = <span class="hljs-keyword">this</span>.schema.options.toJSON
      ? utils.clone(<span class="hljs-keyword">this</span>.schema.options.toJSON)
      : {};
  }
  options.json = <span class="hljs-literal">true</span>;

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.toObject(options);
};</code></pre></div><hr></div><div class="item method public"><h3 id="document_Document-equals"><a href="#document_Document-equals">Document#equals(<code>doc</code>)</a></h3><p>Returns true if the Document stores the same data as doc.</p><div class="params"><h4>Parameters:</h4><ul><li><code>doc</code><span class="types"> &lt;<a href="#document_Document">Document</a>&gt; </span><span>a document to compare</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="description"><p>Documents are considered equal when they have matching <code>_id</code>s, unless neither<br />document has an <code>_id</code>, in which case this function falls back to using<br /><code>deepEqual()</code>.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.equals = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{
  <span class="hljs-keyword">var</span> tid = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'_id'</span>);
  <span class="hljs-keyword">var</span> docid = doc.get(<span class="hljs-string">'_id'</span>);
  <span class="hljs-keyword">if</span> (!tid &amp;&amp; !docid) {
    <span class="hljs-keyword">return</span> deepEqual(<span class="hljs-keyword">this</span>, doc);
  }
  <span class="hljs-keyword">return</span> tid &amp;&amp; tid.equals
    ? tid.equals(docid)
    : tid === docid;
};</code></pre></div><hr></div><div class="item method public"><h3 id="document_Document-populated"><a href="#document_Document-populated">Document#populated(<code>path</code>)</a></h3><p>Gets _id(s) used during population of the given <code>path</code>.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>, <a href="#types_objectid_ObjectId">ObjectId</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>, <a href="http://nodejs.org/api/buffer.html">Buffer</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/undefined">undefined</a>&gt; </span><span></span></li></ul></div><div class="description"><h4>Example:</h4>
<pre><code>Model.findOne().populate(&amp;#<span class="hljs-number">39</span>;author&amp;#<span class="hljs-number">39</span>;).exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc)</span> </span>{
  <span class="hljs-built_in">console</span>.log(doc.author.name)         <span class="hljs-comment">// Dr.Seuss</span>
  <span class="hljs-built_in">console</span>.log(doc.populated(&amp;#<span class="hljs-number">39</span>;author&amp;#<span class="hljs-number">39</span>;)) <span class="hljs-comment">// &amp;#39;5144cf8050f071d979c118a7&amp;#39;</span>
})</code></pre><p>If the path was not populated, undefined is returned.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.populated = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(path, val, options)</span> </span>{
  <span class="hljs-comment">// val and options are internal</span>

  <span class="hljs-comment">//TODO: доделать эту проверку, она должна опираться не на $__.populated, а на то, что наш объект имеет родителя</span>
  <span class="hljs-comment">// и потом уже выставлять свойство populated == true</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == val) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.$__.populated) <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
    <span class="hljs-keyword">var</span> v = <span class="hljs-keyword">this</span>.$__.populated[path];
    <span class="hljs-keyword">if</span> (v) <span class="hljs-keyword">return</span> v.value;
    <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
  }

  <span class="hljs-comment">// internal</span>

  <span class="hljs-keyword">if</span> (<span class="hljs-literal">true</span> === val) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.$__.populated) <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.$__.populated[path];
  }

  <span class="hljs-keyword">this</span>.$__.populated || (<span class="hljs-keyword">this</span>.$__.populated = {});
  <span class="hljs-keyword">this</span>.$__.populated[path] = { value: val, options: options };
  <span class="hljs-keyword">return</span> val;
};</code></pre></div><hr></div><div class="item method private"><h3 id="document_Document-%24__fullPath"><a href="#document_Document-%24__fullPath">Document#$__fullPath(<code>[path]</code>)</a></h3><p>Returns the full path to this document.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[path]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="description"></div><hr class="private"></div><div class="item method public"><h3 id="document_Document-remove"><a href="#document_Document-remove">Document#remove()</a></h3><p>Удалить документ и вернуть коллекцию.</p><div class="see"><h4>See:</h4><ul class="see"><li><a href="Collection.remove" title="Collection.remove">Collection.remove</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.remove = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
  <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">this</span>.collection ){
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.collection.remove( <span class="hljs-keyword">this</span> );
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>;
};</code></pre></div><hr></div><div class="item method public"><h3 id="document_Document-empty"><a href="#document_Document-empty">Document#empty()</a></h3><p>Очищает документ (выставляет значение по умолчанию или undefined)</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.empty = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
  <span class="hljs-keyword">var</span> doc = <span class="hljs-keyword">this</span>
    , self = <span class="hljs-keyword">this</span>
    , paths = <span class="hljs-built_in">Object</span>.keys( <span class="hljs-keyword">this</span>.schema.paths )
    , plen = paths.length
    , ii = <span class="hljs-number">0</span>;

  <span class="hljs-keyword">for</span> ( ; ii &lt; plen; ++ii ) {
    <span class="hljs-keyword">var</span> p = paths[ii];

    <span class="hljs-keyword">if</span> ( <span class="hljs-string">'_id'</span> == p ) <span class="hljs-keyword">continue</span>;

    <span class="hljs-keyword">var</span> type = <span class="hljs-keyword">this</span>.schema.paths[ p ]
      , path = p.split(<span class="hljs-string">'.'</span>)
      , len = path.length
      , last = len - <span class="hljs-number">1</span>
      , doc_ = doc
      , i = <span class="hljs-number">0</span>;

    <span class="hljs-keyword">for</span> ( ; i &lt; len; ++i ) {
      <span class="hljs-keyword">var</span> piece = path[ i ]
        , defaultVal;

      <span class="hljs-keyword">if</span> ( i === last ) {
        defaultVal = type.getDefault( self, <span class="hljs-literal">true</span> );

        doc_[ piece ] = defaultVal || <span class="hljs-literal">undefined</span>;
        self.$__.activePaths.default( p );
      } <span class="hljs-keyword">else</span> {
        doc_ = doc_[ piece ] || ( doc_[ piece ] = {} );
      }
    }
  }
};</code></pre></div><hr></div><div class="item property public"><h3 id="document_Document-errors"><a href="#document_Document-errors">Document#<span>errors</span></a></h3><p>Hash containing current validation errors.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.errors;

Document.prototype.adapterHooks = {
  documentDefineProperty: $.noop,
  documentSetInitialValue: $.noop,
  documentGetValue: $.noop,
  documentSetValue: $.noop
};</code></pre></div><hr></div><div class="item property public"><h3 id="document_Document-id"><a href="#document_Document-id">Document#<span>id</span></a></h3><p>The string version of this documents _id.</p><h4>Note:</h4>
<p>This getter exists on all documents by default. The getter can be disabled by setting the <code>id</code> <a href="/docs/guide.html#id">option</a> of its <code>Schema</code> to false at construction time.</p><pre><code><span class="hljs-keyword">new</span> Schema({ name: <span class="hljs-built_in">String</span> }, { id: <span class="hljs-literal">false</span> });</code></pre><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.id;</code></pre></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="/docs/guide.html#options" title="Schema options">Schema options</a></li></ul></div><hr></div><div class="item property public"><h3 id="document_Document-isNew"><a href="#document_Document-isNew">Document#<span>isNew</span></a></h3><p>Boolean flag specifying if the document is new.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.isNew;</code></pre></div><hr></div><div class="item property public"><h3 id="document_Document-schema"><a href="#document_Document-schema">Document#<span>schema</span></a></h3><p>The documents schema.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.schema;</code></pre></div><hr></div></li><li class="module private"><a href="https://github.com/archangel-irk/storage/blob/0.0.1/lib/error/cast.js" id="error-cast-js">error/cast.js</a><div class="item method private"><h3 id="error_cast_CastError"><a href="#error_cast_CastError">CastError(<code>type</code>, <code>value</code>, <code>path</code>)</a></h3><p>Casting Error constructor.</p><div class="params"><h4>Parameters:</h4><ul><li><code>type</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="#StorageError">StorageError</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">CastError</span> <span class="hljs-params">(type, value, path)</span> </span>{
  StorageError.call(<span class="hljs-keyword">this</span>, <span class="hljs-string">'Cast to '</span> + type + <span class="hljs-string">' failed for value "'</span> + value + <span class="hljs-string">'" at path "'</span> + path + <span class="hljs-string">'"'</span>);
  <span class="hljs-keyword">this</span>.name = <span class="hljs-string">'CastError'</span>;
  <span class="hljs-keyword">this</span>.type = type;
  <span class="hljs-keyword">this</span>.value = value;
  <span class="hljs-keyword">this</span>.path = path;
}</code></pre></div><hr class="private"></div></li><li class="module"><a href="https://github.com/archangel-irk/storage/blob/0.0.1/lib/error/messages.js" id="error-messages-js">error/messages.js</a><div class="item property public"><h3 id="error_messages_StorageError-msg"><a href="#error_messages_StorageError-msg">StorageError#<span>msg</span></a></h3><p>The default built-in validator error messages. These may be customized.</p><pre><code><span class="hljs-comment">// customize within each schema or globally like so</span>
<span class="hljs-keyword">var</span> mongoose = <span class="hljs-built_in">require</span>(&amp;#<span class="hljs-number">39</span>;mongoose&amp;#<span class="hljs-number">39</span>;);
mongoose.Error.messages.String.enum  = &amp;quot;Your custom message <span class="hljs-keyword">for</span> {PATH}.&amp;quot;;</code></pre><p>As you might have noticed, error messages support basic templating</p><ul>
<li><code>{PATH}</code> is replaced with the invalid document path</li>
<li><code>{VALUE}</code> is replaced with the invalid value</li>
<li><code>{TYPE}</code> is replaced with the validator type such as &quot;regexp&quot;, &quot;min&quot;, or &quot;user defined&quot;</li>
<li><code>{MIN}</code> is replaced with the declared min value for the Number.min validator</li>
<li><code>{MAX}</code> is replaced with the declared max value for the Number.max validator</li>
</ul>
<p>Click the &quot;show code&quot; link below to see all defaults.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="hljs-keyword">var</span> msg = <span class="hljs-built_in">module</span>.exports = {};

msg.general = {};
msg.general.default = <span class="hljs-string">"Validator failed for path `{PATH}` with value `{VALUE}`"</span>;
msg.general.required = <span class="hljs-string">"Path `{PATH}` is required."</span>;

msg.Number = {};
msg.Number.min = <span class="hljs-string">"Path `{PATH}` ({VALUE}) is less than minimum allowed value ({MIN})."</span>;
msg.Number.max = <span class="hljs-string">"Path `{PATH}` ({VALUE}) is more than maximum allowed value ({MAX})."</span>;

msg.String = {};
msg.String.enum = <span class="hljs-string">"`{VALUE}` is not a valid enum value for path `{PATH}`."</span>;
msg.String.match = <span class="hljs-string">"Path `{PATH}` is invalid ({VALUE})."</span>;</code></pre></div><hr></div></li><li class="module private"><a href="https://github.com/archangel-irk/storage/blob/0.0.1/lib/error/validation.js" id="error-validation-js">error/validation.js</a><div class="item method private"><h3 id="error_validation_ValidationError"><a href="#error_validation_ValidationError">ValidationError(<code>instance</code>)</a></h3><p>Document Validation Error</p><div class="params"><h4>Parameters:</h4><ul><li><code>instance</code><span class="types"> &lt;<a href="#document_Document">Document</a>&gt; </span><span></span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="#StorageError">StorageError</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ValidationError</span> <span class="hljs-params">(instance)</span> </span>{
  StorageError.call(<span class="hljs-keyword">this</span>, <span class="hljs-string">"Validation failed"</span>);
  <span class="hljs-keyword">this</span>.name = <span class="hljs-string">'ValidationError'</span>;
  <span class="hljs-keyword">this</span>.errors = instance.errors = {};
}</code></pre></div><hr class="private"></div></li><li class="module private"><a href="https://github.com/archangel-irk/storage/blob/0.0.1/lib/error/validator.js" id="error-validator-js">error/validator.js</a><div class="item method private"><h3 id="error_validator_ValidatorError"><a href="#error_validator_ValidatorError">ValidatorError(<code>path</code>, <code>msg</code>, <code>val</code>)</a></h3><p>Schema validator error</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>msg</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>, T&gt; </span><span></span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="#StorageError">StorageError</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ValidatorError</span> <span class="hljs-params">(path, msg, type, val)</span> </span>{
  <span class="hljs-keyword">if</span> (!msg) msg = errorMessages.general.default;
  <span class="hljs-keyword">var</span> message = <span class="hljs-keyword">this</span>.formatMessage(msg, path, type, val);
  StorageError.call(<span class="hljs-keyword">this</span>, message);
  <span class="hljs-keyword">this</span>.name = <span class="hljs-string">'ValidatorError'</span>;
  <span class="hljs-keyword">this</span>.path = path;
  <span class="hljs-keyword">this</span>.type = type;
  <span class="hljs-keyword">this</span>.value = val;
}</code></pre></div><hr class="private"></div></li><li class="module"><a href="https://github.com/archangel-irk/storage/blob/0.0.1/lib/error.js" id="error-js">error.js</a><div class="item method public"><h3 id="error_StorageError"><a href="#error_StorageError">StorageError(<code>msg</code>)</a></h3><p>StorageError constructor</p><div class="params"><h4>Parameters:</h4><ul><li><code>msg</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>- Error message</span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="http://stackoverflow.com/questions/783818/how-do-i-create-a-custom-error-in-javascript" title="Error https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Error">Error https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Error</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">StorageError</span> <span class="hljs-params">( msg )</span> </span>{
  <span class="hljs-keyword">this</span>.message = msg;
  <span class="hljs-keyword">this</span>.name = <span class="hljs-string">'StorageError'</span>;
}
StorageError.prototype = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>();</code></pre></div><hr></div><div class="item static public"><h3 id="error_StorageError.messages"><a href="#error_StorageError.messages">StorageError.messages</a></h3><p>The default built-in validator error messages.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">StorageError.messages = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./error/messages'</span>);</code></pre></div><div class="see"><h4>See:</h4><ul class="see"><li><url>= see.url || see.local</url><a href="error_StorageError.messages" title="Error.messages">Error.messages</a></li></ul></div><hr></div></li><li class="module"><a href="https://github.com/archangel-irk/storage/blob/0.0.1/lib/events.js" id="events-js">events.js</a><div class="item method public"><h3 id="events_Events"><a href="#events_Events">Events()</a></h3><p>Backbone.Events</p><div class="description"><p>A module that can be mixed in to <em>any object</em> in order to provide it with<br />custom events. You may bind with <code>on</code> or remove with <code>off</code> callback<br />functions to an event; <code>trigger</code>-ing an event fires all callbacks in<br />succession.</p><p>var object = {};<br />_.extend(object, Events.prototype);<br />object.on(&#39;expand&#39;, function(){ alert(&#39;expanded&#39;); });<br />object.trigger(&#39;expand&#39;);</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Events</span><span class="hljs-params">()</span> </span>{}

Events.prototype = {</code></pre></div><hr></div><div class="item method public"><h3 id="events_eventsApi"><a href="#events_eventsApi">eventsApi(<code></code>, <code></code>, <code></code>, <code></code>)</a></h3><p>Implement fancy features of the Events API such as multiple event<br />names <code>&quot;change blur&quot;</code> and jQuery-style event maps <code>{change: action}</code><br />in terms of the existing API.</p><div class="params"><h4>Parameters:</h4><ul><li><code></code><span class="types"> &lt;<a href="#obj">obj</a>&gt; </span><span></span></li><li><code></code><span class="types"> &lt;<a href="#action">action</a>&gt; </span><span></span></li><li><code></code><span class="types"> &lt;<a href="#name">name</a>&gt; </span><span></span></li><li><code></code><span class="types"> &lt;<a href="#rest">rest</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="hljs-keyword">var</span> eventsApi = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, action, name, rest)</span> </span>{
  <span class="hljs-keyword">if</span> (!name) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;

  <span class="hljs-comment">// Handle event maps.</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> name === <span class="hljs-string">'object'</span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> name) {
      obj[action].apply(obj, [key, name[key]].concat(rest));
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  <span class="hljs-comment">// Handle space separated event names.</span>
  <span class="hljs-keyword">if</span> (eventSplitter.test(name)) {
    <span class="hljs-keyword">var</span> names = name.split(eventSplitter);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = names.length; i &lt; l; i++) {
      obj[action].apply(obj, [names[i]].concat(rest));
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
};</code></pre></div><hr></div><div class="item method public"><h3 id="events_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-off"><a href="#events_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-off">function Object() { [native code] }#off(<code></code>, <code></code>, <code></code>)</a></h3><p>Remove one or many callbacks. If <code>context</code> is null, removes all<br />callbacks with that function. If <code>callback</code> is null, removes all<br />callbacks for the event. If <code>name</code> is null, removes all bound<br />callbacks for all events.</p><div class="params"><h4>Parameters:</h4><ul><li><code></code><span class="types"> &lt;<a href="#name">name</a>&gt; </span><span></span></li><li><code></code><span class="types"> &lt;<a href="#callback">callback</a>&gt; </span><span></span></li><li><code></code><span class="types"> &lt;<a href="#context">context</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">off: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, callback, context)</span> </span>{
  <span class="hljs-keyword">var</span> retain, ev, events, names, i, l, j, k;
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._events || !eventsApi(<span class="hljs-keyword">this</span>, <span class="hljs-string">'off'</span>, name, [callback, context])) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">if</span> (!name &amp;&amp; !callback &amp;&amp; !context) {
    <span class="hljs-keyword">this</span>._events = {};
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  }
  names = name ? [name] : _.keys(<span class="hljs-keyword">this</span>._events);
  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, l = names.length; i &lt; l; i++) {
    name = names[i];
    <span class="hljs-keyword">if</span> (events = <span class="hljs-keyword">this</span>._events[name]) {
      <span class="hljs-keyword">this</span>._events[name] = retain = [];
      <span class="hljs-keyword">if</span> (callback || context) {
        <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>, k = events.length; j &lt; k; j++) {
          ev = events[j];
          <span class="hljs-keyword">if</span> ((callback &amp;&amp; callback !== ev.callback &amp;&amp; callback !== ev.callback._callback) ||
            (context &amp;&amp; context !== ev.context)) {
            retain.push(ev);
          }
        }
      }
      <span class="hljs-keyword">if</span> (!retain.length) <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>._events[name];
    }
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
},</code></pre></div><hr></div><div class="item method public"><h3 id="events_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-on"><a href="#events_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-on">function Object() { [native code] }#on(<code></code>, <code></code>, <code></code>)</a></h3><p>Bind an event to a <code>callback</code> function. Passing <code>&quot;all&quot;</code> will bind<br />the callback to all events fired.</p><div class="params"><h4>Parameters:</h4><ul><li><code></code><span class="types"> &lt;<a href="#name">name</a>&gt; </span><span></span></li><li><code></code><span class="types"> &lt;<a href="#callback">callback</a>&gt; </span><span></span></li><li><code></code><span class="types"> &lt;<a href="#context">context</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">on: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, callback, context)</span> </span>{
  <span class="hljs-keyword">if</span> (!eventsApi(<span class="hljs-keyword">this</span>, <span class="hljs-string">'on'</span>, name, [callback, context]) || !callback) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">this</span>._events || (<span class="hljs-keyword">this</span>._events = {});
  <span class="hljs-keyword">var</span> events = <span class="hljs-keyword">this</span>._events[name] || (<span class="hljs-keyword">this</span>._events[name] = []);
  events.push({callback: callback, context: context, ctx: context || <span class="hljs-keyword">this</span>});
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
},</code></pre></div><hr></div><div class="item method public"><h3 id="events_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-once"><a href="#events_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-once">function Object() { [native code] }#once(<code></code>, <code></code>, <code></code>)</a></h3><p>Bind an event to only be triggered a single time. After the first time<br />the callback is invoked, it will be removed.</p><div class="params"><h4>Parameters:</h4><ul><li><code></code><span class="types"> &lt;<a href="#name">name</a>&gt; </span><span></span></li><li><code></code><span class="types"> &lt;<a href="#callback">callback</a>&gt; </span><span></span></li><li><code></code><span class="types"> &lt;<a href="#context">context</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">once: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, callback, context)</span> </span>{
  <span class="hljs-keyword">if</span> (!eventsApi(<span class="hljs-keyword">this</span>, <span class="hljs-string">'once'</span>, name, [callback, context]) || !callback) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">var</span> once = _.once(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    self.off(name, once);
    callback.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
  });
  once._callback = callback;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.on(name, once, context);
},</code></pre></div><hr></div><div class="item method public"><h3 id="events_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-stopListening"><a href="#events_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-stopListening">function Object() { [native code] }#stopListening(<code></code>, <code></code>, <code></code>)</a></h3><p>Tell this object to stop listening to either specific events ... or<br />to every object it&#39;s currently listening to.</p><div class="params"><h4>Parameters:</h4><ul><li><code></code><span class="types"> &lt;<a href="#obj">obj</a>&gt; </span><span></span></li><li><code></code><span class="types"> &lt;<a href="#name">name</a>&gt; </span><span></span></li><li><code></code><span class="types"> &lt;<a href="#callback">callback</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">stopListening: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, name, callback)</span> </span>{
  <span class="hljs-keyword">var</span> listeningTo = <span class="hljs-keyword">this</span>._listeningTo;
  <span class="hljs-keyword">if</span> (!listeningTo) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">var</span> remove = !name &amp;&amp; !callback;
  <span class="hljs-keyword">if</span> (!callback &amp;&amp; <span class="hljs-keyword">typeof</span> name === <span class="hljs-string">'object'</span>) callback = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">if</span> (obj) (listeningTo = {})[obj._listenId] = obj;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> id <span class="hljs-keyword">in</span> listeningTo) {
    obj = listeningTo[id];
    obj.off(name, callback, <span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">if</span> (remove || _.isEmpty(obj._events)) <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>._listeningTo[id];
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
}
};

<span class="hljs-comment">// Regular expression used to split event strings.</span>
<span class="hljs-keyword">var</span> eventSplitter = <span class="hljs-regexp">/\s+/</span>;</code></pre></div><hr></div><div class="item method public"><h3 id="events_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-trigger"><a href="#events_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-trigger">function Object() { [native code] }#trigger(<code></code>)</a></h3><p>Trigger one or many events, firing all bound callbacks. Callbacks are<br />passed the same arguments as <code>trigger</code> is, apart from the event name<br />(unless you&#39;re listening on <code>&quot;all&quot;</code>, which will cause your callback to<br />receive the true name of the event as the first argument).</p><div class="params"><h4>Parameters:</h4><ul><li><code></code><span class="types"> &lt;<a href="#name">name</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">trigger: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name)</span> </span>{
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._events) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);
  <span class="hljs-keyword">if</span> (!eventsApi(<span class="hljs-keyword">this</span>, <span class="hljs-string">'trigger'</span>, name, args)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">var</span> events = <span class="hljs-keyword">this</span>._events[name];
  <span class="hljs-keyword">var</span> allEvents = <span class="hljs-keyword">this</span>._events.all;
  <span class="hljs-keyword">if</span> (events) triggerEvents(events, args);
  <span class="hljs-keyword">if</span> (allEvents) triggerEvents(allEvents, <span class="hljs-built_in">arguments</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
},</code></pre></div><hr></div><div class="item method public"><h3 id="events_triggerEvents"><a href="#events_triggerEvents">triggerEvents(<code></code>, <code></code>)</a></h3><p>A difficult-to-believe, but optimized internal dispatch function for<br />triggering events. Tries to keep the usual cases speedy (most internal<br />Backbone events have 3 arguments).</p><div class="params"><h4>Parameters:</h4><ul><li><code></code><span class="types"> &lt;<a href="#events">events</a>&gt; </span><span></span></li><li><code></code><span class="types"> &lt;<a href="#args">args</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="hljs-keyword">var</span> triggerEvents = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(events, args)</span> </span>{
  <span class="hljs-keyword">var</span> ev, i = -<span class="hljs-number">1</span>, l = events.length, a1 = args[<span class="hljs-number">0</span>], a2 = args[<span class="hljs-number">1</span>], a3 = args[<span class="hljs-number">2</span>];
  <span class="hljs-keyword">switch</span> (args.length) {
    <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>: <span class="hljs-keyword">while</span> (++i &lt; l) (ev = events[i]).callback.call(ev.ctx); <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>: <span class="hljs-keyword">while</span> (++i &lt; l) (ev = events[i]).callback.call(ev.ctx, a1); <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>: <span class="hljs-keyword">while</span> (++i &lt; l) (ev = events[i]).callback.call(ev.ctx, a1, a2); <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>: <span class="hljs-keyword">while</span> (++i &lt; l) (ev = events[i]).callback.call(ev.ctx, a1, a2, a3); <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">default</span>: <span class="hljs-keyword">while</span> (++i &lt; l) (ev = events[i]).callback.apply(ev.ctx, args);
  }
};

<span class="hljs-keyword">var</span> listenMethods = {listenTo: <span class="hljs-string">'on'</span>, listenToOnce: <span class="hljs-string">'once'</span>};

<span class="hljs-comment">// Inversion-of-control versions of `on` and `once`. Tell *this* object to</span>
<span class="hljs-comment">// listen to an event in another object ... keeping track of what it's</span>
<span class="hljs-comment">// listening to.</span>
_.each(listenMethods, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(implementation, method)</span> </span>{
  Events[method] = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, name, callback)</span> </span>{
    <span class="hljs-keyword">var</span> listeningTo = <span class="hljs-keyword">this</span>._listeningTo || (<span class="hljs-keyword">this</span>._listeningTo = {});
    <span class="hljs-keyword">var</span> id = obj._listenId || (obj._listenId = _.uniqueId(<span class="hljs-string">'l'</span>));
    listeningTo[id] = obj;
    <span class="hljs-keyword">if</span> (!callback &amp;&amp; <span class="hljs-keyword">typeof</span> name === <span class="hljs-string">'object'</span>) callback = <span class="hljs-keyword">this</span>;
    obj[implementation](name, callback, <span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  };
});

<span class="hljs-built_in">module</span>.exports = Events;</code></pre></div><hr></div></li><li class="module"><a href="https://github.com/archangel-irk/storage/blob/0.0.1/lib/mpath.js" id="mpath-js">mpath.js</a><div class="item static public"><h3 id="mpath_exports.get"><a href="#mpath_exports.get">exports.get(<code>path</code>, <code>o</code>, <code>[special]</code>, <code>[map]</code>)</a></h3><p>Returns the value of object <code>o</code> at the given <code>path</code>.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">exports.get = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(path, o, special, map)</span> </span>{
  <span class="hljs-keyword">var</span> lookup;

  <span class="hljs-keyword">if</span> (<span class="hljs-string">'function'</span> == <span class="hljs-keyword">typeof</span> special) {
    <span class="hljs-keyword">if</span> (special.length &lt; <span class="hljs-number">2</span>) {
      map = special;
      special = <span class="hljs-literal">undefined</span>;
    } <span class="hljs-keyword">else</span> {
      lookup = special;
      special = <span class="hljs-literal">undefined</span>;
    }
  }

  map || (map = K);

  <span class="hljs-keyword">var</span> parts = <span class="hljs-string">'string'</span> == <span class="hljs-keyword">typeof</span> path
    ? path.split(<span class="hljs-string">'.'</span>)
    : path;

  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">Array</span>.isArray(parts)) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">TypeError</span>(<span class="hljs-string">'Invalid `path`. Must be either string or array'</span>);
  }

  <span class="hljs-keyword">var</span> obj = o
    , part;

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; parts.length; ++i) {
    part = parts[i];

    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(obj) &amp;&amp; !<span class="hljs-regexp">/^\d+$/</span>.test(part)) {
      <span class="hljs-comment">// reading a property from the array items</span>
      <span class="hljs-keyword">var</span> paths = parts.slice(i);

      <span class="hljs-keyword">return</span> obj.map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(item)</span> </span>{
        <span class="hljs-keyword">return</span> item
          ? exports.get(paths, item, special || lookup, map)
          : map(<span class="hljs-literal">undefined</span>);
      });
    }

    <span class="hljs-keyword">if</span> (lookup) {
      obj = lookup(obj, part);
    } <span class="hljs-keyword">else</span> {
      obj = special &amp;&amp; obj[special]
        ? obj[special][part]
        : obj[part];
    }

    <span class="hljs-keyword">if</span> (!obj) <span class="hljs-keyword">return</span> map(obj);
  }

  <span class="hljs-keyword">return</span> map(obj);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>o</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[special]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>When this property name is present on any object in the path, walking will continue on the value of this property.</span></li><li><code>[map]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>Optional function which receives each individual found value. The value returned from `map` is used in the original values place.</span></li></ul></div><h4>Example:</h4>
<pre><code><span class="hljs-keyword">var</span> obj = {
    comments: [
        { title: &amp;#<span class="hljs-number">39</span>;exciting!&amp;#<span class="hljs-number">39</span>;, _doc: { title: &amp;#<span class="hljs-number">39</span>;great!&amp;#<span class="hljs-number">39</span>; }}
      , { title: &amp;#<span class="hljs-number">39</span>;number dos&amp;#<span class="hljs-number">39</span>; }
    ]
}

mpath.get(&amp;#<span class="hljs-number">39</span>;comments<span class="hljs-number">.0</span>.title&amp;#<span class="hljs-number">39</span>;, o)         <span class="hljs-comment">// &amp;#39;exciting!&amp;#39;</span>
mpath.get(&amp;#<span class="hljs-number">39</span>;comments<span class="hljs-number">.0</span>.title&amp;#<span class="hljs-number">39</span>;, o, &amp;#<span class="hljs-number">39</span>;_doc&amp;#<span class="hljs-number">39</span>;) <span class="hljs-comment">// &amp;#39;great!&amp;#39;</span>
mpath.get(&amp;#<span class="hljs-number">39</span>;comments.title&amp;#<span class="hljs-number">39</span>;, o)           <span class="hljs-comment">// [&amp;#39;exciting!&amp;#39;, &amp;#39;number dos&amp;#39;]</span>

<span class="hljs-comment">// summary</span>
mpath.get(path, o)
mpath.get(path, o, special)
mpath.get(path, o, map)
mpath.get(path, o, special, map)</code></pre><hr></div><div class="item static public"><h3 id="mpath_exports.set"><a href="#mpath_exports.set">exports.set(<code>path</code>, <code>val</code>, <code>o</code>, <code>[special]</code>, <code>[map]</code>)</a></h3><p>Sets the <code>val</code> at the given <code>path</code> of object <code>o</code>.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">exports.set = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(path, val, o, special, map, _copying)</span> </span>{
  <span class="hljs-keyword">var</span> lookup;

  <span class="hljs-keyword">if</span> (<span class="hljs-string">'function'</span> == <span class="hljs-keyword">typeof</span> special) {
    <span class="hljs-keyword">if</span> (special.length &lt; <span class="hljs-number">2</span>) {
      map = special;
      special = <span class="hljs-literal">undefined</span>;
    } <span class="hljs-keyword">else</span> {
      lookup = special;
      special = <span class="hljs-literal">undefined</span>;
    }
  }

  map || (map = K);

  <span class="hljs-keyword">var</span> parts = <span class="hljs-string">'string'</span> == <span class="hljs-keyword">typeof</span> path
    ? path.split(<span class="hljs-string">'.'</span>)
    : path;

  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">Array</span>.isArray(parts)) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">TypeError</span>(<span class="hljs-string">'Invalid `path`. Must be either string or array'</span>);
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == o) <span class="hljs-keyword">return</span>;

  <span class="hljs-comment">// the existance of $ in a path tells us if the user desires</span>
  <span class="hljs-comment">// the copying of an array instead of setting each value of</span>
  <span class="hljs-comment">// the array to the one by one to matching positions of the</span>
  <span class="hljs-comment">// current array.</span>
  <span class="hljs-keyword">var</span> copy = _copying || <span class="hljs-regexp">/\$/</span>.test(path)
    , obj = o
    , part;

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, len = parts.length - <span class="hljs-number">1</span>; i &lt; len; ++i) {
    part = parts[i];

    <span class="hljs-keyword">if</span> (<span class="hljs-string">'$'</span> == part) {
      <span class="hljs-keyword">if</span> (i == len - <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">break</span>;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">continue</span>;
      }
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(obj) &amp;&amp; !<span class="hljs-regexp">/^\d+$/</span>.test(part)) {
      <span class="hljs-keyword">var</span> paths = parts.slice(i);
      <span class="hljs-keyword">if</span> (!copy &amp;&amp; <span class="hljs-built_in">Array</span>.isArray(val)) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; obj.length &amp;&amp; j &lt; val.length; ++j) {
          <span class="hljs-comment">// assignment of single values of array</span>
          exports.set(paths, val[j], obj[j], special || lookup, map, copy);
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; obj.length; ++j) {
          <span class="hljs-comment">// assignment of entire value</span>
          exports.set(paths, val, obj[j], special || lookup, map, copy);
        }
      }
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">if</span> (lookup) {
      obj = lookup(obj, part);
    } <span class="hljs-keyword">else</span> {
      obj = special &amp;&amp; obj[special]
        ? obj[special][part]
        : obj[part];
    }

    <span class="hljs-keyword">if</span> (!obj) <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-comment">// process the last property of the path</span>

  part = parts[len];

  <span class="hljs-comment">// use the special property if exists</span>
  <span class="hljs-keyword">if</span> (special &amp;&amp; obj[special]) {
    obj = obj[special];
  }

  <span class="hljs-comment">// set the value on the last branch</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(obj) &amp;&amp; !<span class="hljs-regexp">/^\d+$/</span>.test(part)) {
    <span class="hljs-keyword">if</span> (!copy &amp;&amp; <span class="hljs-built_in">Array</span>.isArray(val)) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> item, j = <span class="hljs-number">0</span>; j &lt; obj.length &amp;&amp; j &lt; val.length; ++j) {
        item = obj[j];
        <span class="hljs-keyword">if</span> (item) {
          <span class="hljs-keyword">if</span> (lookup) {
            lookup(item, part, map(val[j]));
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (item[special]) item = item[special];
            item[part] = map(val[j]);
          }
        }
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; obj.length; ++j) {
        item = obj[j];
        <span class="hljs-keyword">if</span> (item) {
          <span class="hljs-keyword">if</span> (lookup) {
            lookup(item, part, map(val));
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (item[special]) item = item[special];
            item[part] = map(val);
          }
        }
      }
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">if</span> (lookup) {
      lookup(obj, part, map(val));
    } <span class="hljs-keyword">else</span> {
      obj[part] = map(val);
    }
  }
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>val</code><span class="types"> &lt;<a href="#*">*</a>&gt; </span><span></span></li><li><code>o</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[special]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>When this property name is present on any object in the path, walking will continue on the value of this property.</span></li><li><code>[map]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>Optional function which is passed each individual value before setting it. The value returned from `map` is used in the original values place.</span></li></ul></div><hr></div></li><li class="module private"><a href="https://github.com/archangel-irk/storage/blob/0.0.1/lib/schema/array.js" id="schema-array-js">schema/array.js</a><div class="item method private"><h3 id="schema_array_SchemaArray"><a href="#schema_array_SchemaArray">SchemaArray(<code>key</code>, <code>cast</code>, <code>options</code>)</a></h3><p>Array SchemaType constructor</p><div class="params"><h4>Parameters:</h4><ul><li><code>key</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>cast</code><span class="types"> &lt;<a href="#schematype_SchemaType">SchemaType</a>&gt; </span><span></span></li><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="#schematype_SchemaType">SchemaType</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SchemaArray</span> <span class="hljs-params">(key, cast, options)</span> </span>{
  <span class="hljs-keyword">if</span> (cast) {
    <span class="hljs-keyword">var</span> castOptions = {};

    <span class="hljs-keyword">if</span> (<span class="hljs-string">'Object'</span> === utils.getFunctionName( cast.constructor ) ) {
      <span class="hljs-keyword">if</span> (cast.type) {
        <span class="hljs-comment">// support { type: Woot }</span>
        castOptions = _.clone( cast ); <span class="hljs-comment">// do not alter user arguments</span>
        <span class="hljs-keyword">delete</span> castOptions.type;
        cast = cast.type;
      } <span class="hljs-keyword">else</span> {
        cast = Mixed;
      }
    }

    <span class="hljs-comment">// support { type: 'String' }</span>
    <span class="hljs-keyword">var</span> name = <span class="hljs-string">'string'</span> == <span class="hljs-keyword">typeof</span> cast
      ? cast
      : utils.getFunctionName( cast );

    <span class="hljs-keyword">var</span> caster = name <span class="hljs-keyword">in</span> Types
      ? Types[name]
      : cast;

    <span class="hljs-keyword">this</span>.casterConstructor = caster;
    <span class="hljs-keyword">this</span>.caster = <span class="hljs-keyword">new</span> caster(<span class="hljs-literal">null</span>, castOptions);

    <span class="hljs-comment">// lazy load</span>
    EmbeddedDoc || (EmbeddedDoc = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../types/embedded'</span>));

    <span class="hljs-keyword">if</span> (!(<span class="hljs-keyword">this</span>.caster <span class="hljs-keyword">instanceof</span> EmbeddedDoc)) {
      <span class="hljs-keyword">this</span>.caster.path = key;
    }
  }

  SchemaType.call(<span class="hljs-keyword">this</span>, key, options);

  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
    , defaultArr
    , fn;

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.defaultValue) {
    defaultArr = <span class="hljs-keyword">this</span>.defaultValue;
    fn = <span class="hljs-string">'function'</span> == <span class="hljs-keyword">typeof</span> defaultArr;
  }

  <span class="hljs-keyword">this</span>.default(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">var</span> arr = fn ? defaultArr() : defaultArr || [];
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> StorageArray(arr, self.path, <span class="hljs-keyword">this</span>);
  });
}</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="schema_array_SchemaArray-applyGetters"><a href="#schema_array_SchemaArray-applyGetters">SchemaArray#applyGetters(<code>value</code>, <code>scope</code>)</a></h3><p>Overrides the getters application for the population special-case</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>scope</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaArray.prototype.applyGetters = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value, scope)</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.caster.options &amp;&amp; <span class="hljs-keyword">this</span>.caster.options.ref) {
    <span class="hljs-comment">// means the object id was populated</span>
    <span class="hljs-keyword">return</span> value;
  }

  <span class="hljs-keyword">return</span> SchemaType.prototype.applyGetters.call(<span class="hljs-keyword">this</span>, value, scope);
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="schema_array_SchemaArray-cast"><a href="#schema_array_SchemaArray-cast">SchemaArray#cast(<code>value</code>, <code>doc</code>, <code>init</code>)</a></h3><p>Casts values for set().</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>doc</code><span class="types"> &lt;<a href="#document_Document">Document</a>&gt; </span><span>document that triggers the casting</span></li><li><code>init</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span>whether this is an initialization cast</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaArray.prototype.cast = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( value, doc, init )</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(value)) {
    <span class="hljs-keyword">if</span> (!(value.isStorageArray)) {
      value = <span class="hljs-keyword">new</span> StorageArray(value, <span class="hljs-keyword">this</span>.path, doc);
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.caster) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = value.length; i &lt; l; i++) {
          value[i] = <span class="hljs-keyword">this</span>.caster.cast(value[i], doc, init);
        }
      } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-comment">// rethrow</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CastError(e.type, value, <span class="hljs-keyword">this</span>.path);
      }
    }

    <span class="hljs-keyword">return</span> value;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.cast([value], doc, init);
  }
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="schema_array_SchemaArray-checkRequired"><a href="#schema_array_SchemaArray-checkRequired">SchemaArray#checkRequired(<code>value</code>)</a></h3><p>Check required</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaArray.prototype.checkRequired = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value)</span> </span>{
  <span class="hljs-keyword">return</span> !!(value &amp;&amp; value.length);
};</code></pre></div><hr class="private"></div></li><li class="module private"><a href="https://github.com/archangel-irk/storage/blob/0.0.1/lib/schema/boolean.js" id="schema-boolean-js">schema/boolean.js</a><div class="item method private"><h3 id="schema_boolean_BooleanSchema"><a href="#schema_boolean_BooleanSchema">BooleanSchema(<code>path</code>, <code>options</code>)</a></h3><p>Boolean SchemaType constructor.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="#schematype_SchemaType">SchemaType</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">BooleanSchema</span> <span class="hljs-params">(path, options)</span> </span>{
  SchemaType.call(<span class="hljs-keyword">this</span>, path, options);
}</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="schema_boolean_BooleanSchema-cast"><a href="#schema_boolean_BooleanSchema-cast">BooleanSchema#cast(<code>value</code>)</a></h3><p>Casts to boolean</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">BooleanSchema.prototype.cast = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value)</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> === value) <span class="hljs-keyword">return</span> value;
  <span class="hljs-keyword">if</span> (<span class="hljs-string">'0'</span> === value) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">if</span> (<span class="hljs-string">'true'</span> === value) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">if</span> (<span class="hljs-string">'false'</span> === value) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">return</span> !! value;
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="schema_boolean_BooleanSchema-checkRequired"><a href="#schema_boolean_BooleanSchema-checkRequired">BooleanSchema#checkRequired()</a></h3><p>Required validator</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">BooleanSchema.prototype.checkRequired = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value)</span> </span>{
  <span class="hljs-keyword">return</span> value === <span class="hljs-literal">true</span> || value === <span class="hljs-literal">false</span>;
};</code></pre></div><hr class="private"></div></li><li class="module private"><a href="https://github.com/archangel-irk/storage/blob/0.0.1/lib/schema/buffer.js" id="schema-buffer-js">schema/buffer.js</a><div class="item method private"><h3 id="schema_buffer_SchemaBuffer"><a href="#schema_buffer_SchemaBuffer">SchemaBuffer(<code>key</code>, <code>cast</code>)</a></h3><p>Buffer SchemaType constructor</p><div class="params"><h4>Parameters:</h4><ul><li><code>key</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>cast</code><span class="types"> &lt;<a href="#schematype_SchemaType">SchemaType</a>&gt; </span><span></span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="#schematype_SchemaType">SchemaType</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SchemaBuffer</span> <span class="hljs-params">(key, options)</span> </span>{
  SchemaType.call(<span class="hljs-keyword">this</span>, key, options, <span class="hljs-string">'Buffer'</span>);
}</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="schema_buffer_SchemaBuffer-cast"><a href="#schema_buffer_SchemaBuffer-cast">SchemaBuffer#cast(<code>value</code>, <code>doc</code>, <code>init</code>)</a></h3><p>Casts contents</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>doc</code><span class="types"> &lt;<a href="#document_Document">Document</a>&gt; </span><span>document that triggers the casting</span></li><li><code>init</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaBuffer.prototype.cast = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value, doc, init)</span> </span>{
  <span class="hljs-keyword">if</span> (SchemaType._isRef(<span class="hljs-keyword">this</span>, value, doc, init)) {
    <span class="hljs-comment">// wait! we may need to cast this to a document</span>

    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == value) {
      <span class="hljs-keyword">return</span> value;
    }

    <span class="hljs-comment">// lazy load</span>
    Document || (Document = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./../document'</span>));

    <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> Document) {
      value.$__.wasPopulated = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">return</span> value;
    }

    <span class="hljs-comment">// setting a populated path</span>
    <span class="hljs-keyword">if</span> (Buffer.isBuffer(value)) {
      <span class="hljs-keyword">return</span> value;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!_.isObject(value)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CastError(<span class="hljs-string">'buffer'</span>, value, <span class="hljs-keyword">this</span>.path);
    }

    <span class="hljs-comment">// Handle the case where user directly sets a populated</span>
    <span class="hljs-comment">// path to a plain object; cast to the Model used in</span>
    <span class="hljs-comment">// the population query.</span>
    <span class="hljs-keyword">var</span> path = doc.$__fullPath(<span class="hljs-keyword">this</span>.path);
    <span class="hljs-keyword">var</span> owner = doc.ownerDocument ? doc.ownerDocument() : doc;
    <span class="hljs-keyword">var</span> pop = owner.populated(path, <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">var</span> ret = <span class="hljs-keyword">new</span> pop.options.model(value);
    ret.$__.wasPopulated = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">return</span> ret;
  }

  <span class="hljs-comment">// documents</span>
  <span class="hljs-keyword">if</span> (value &amp;&amp; value._id) {
    value = value._id;
  }

  <span class="hljs-keyword">if</span> (Buffer.isBuffer(value)) {
    <span class="hljs-keyword">if</span> (!value || !value.isStorageBuffer) {
      value = <span class="hljs-keyword">new</span> StorageBuffer(value, [<span class="hljs-keyword">this</span>.path, doc]);
    }

    <span class="hljs-keyword">return</span> value;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> Binary) {
    <span class="hljs-keyword">var</span> ret = <span class="hljs-keyword">new</span> StorageBuffer(value.value(<span class="hljs-literal">true</span>), [<span class="hljs-keyword">this</span>.path, doc]);
    ret.subtype(value.sub_type);
    <span class="hljs-comment">// do not override Binary subtypes. users set this</span>
    <span class="hljs-comment">// to whatever they want.</span>
    <span class="hljs-keyword">return</span> ret;
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> === value) <span class="hljs-keyword">return</span> value;

  <span class="hljs-keyword">var</span> type = <span class="hljs-keyword">typeof</span> value;
  <span class="hljs-keyword">if</span> (<span class="hljs-string">'string'</span> == type || <span class="hljs-string">'number'</span> == type || <span class="hljs-built_in">Array</span>.isArray(value)) {
    <span class="hljs-keyword">var</span> ret = <span class="hljs-keyword">new</span> StorageBuffer(value, [<span class="hljs-keyword">this</span>.path, doc]);
    <span class="hljs-keyword">return</span> ret;
  }

  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CastError(<span class="hljs-string">'buffer'</span>, value, <span class="hljs-keyword">this</span>.path);
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="schema_buffer_SchemaBuffer-checkRequired"><a href="#schema_buffer_SchemaBuffer-checkRequired">SchemaBuffer#checkRequired()</a></h3><p>Check required</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaBuffer.prototype.checkRequired = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value, doc)</span> </span>{
  <span class="hljs-keyword">if</span> (SchemaType._isRef(<span class="hljs-keyword">this</span>, value, doc, <span class="hljs-literal">true</span>)) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span> != value;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> !!(value &amp;&amp; value.length);
  }
};</code></pre></div><hr class="private"></div></li><li class="module private"><a href="https://github.com/archangel-irk/storage/blob/0.0.1/lib/schema/date.js" id="schema-date-js">schema/date.js</a><div class="item method private"><h3 id="schema_date_DateSchema"><a href="#schema_date_DateSchema">DateSchema(<code>key</code>, <code>options</code>)</a></h3><p>Date SchemaType constructor.</p><div class="params"><h4>Parameters:</h4><ul><li><code>key</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="#schematype_SchemaType">SchemaType</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">DateSchema</span> <span class="hljs-params">(key, options)</span> </span>{
  SchemaType.call(<span class="hljs-keyword">this</span>, key, options);
}</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="schema_date_DateSchema-cast"><a href="#schema_date_DateSchema-cast">DateSchema#cast(<code>value</code>)</a></h3><p>Casts to date</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>to cast</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">DateSchema.prototype.cast = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value)</span> </span>{
  <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">null</span> || value === <span class="hljs-string">''</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Date</span>)
    <span class="hljs-keyword">return</span> value;

  <span class="hljs-keyword">var</span> date;

  <span class="hljs-comment">// support for timestamps</span>
  <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Number</span> || <span class="hljs-string">'number'</span> == <span class="hljs-keyword">typeof</span> value
      || <span class="hljs-built_in">String</span>(value) == <span class="hljs-built_in">Number</span>(value))
    date = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-built_in">Number</span>(value));

  <span class="hljs-comment">// support for date strings</span>
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (value.toString)
    date = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(value.toString());

  <span class="hljs-keyword">if</span> (date.toString() != <span class="hljs-string">'Invalid Date'</span>)
    <span class="hljs-keyword">return</span> date;

  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CastError(<span class="hljs-string">'date'</span>, value, <span class="hljs-keyword">this</span>.path );
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="schema_date_DateSchema-checkRequired"><a href="#schema_date_DateSchema-checkRequired">DateSchema#checkRequired()</a></h3><p>Required validator for date</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">DateSchema.prototype.checkRequired = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value)</span> </span>{
  <span class="hljs-keyword">return</span> value <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Date</span>;
};</code></pre></div><hr class="private"></div></li><li class="module private"><a href="https://github.com/archangel-irk/storage/blob/0.0.1/lib/schema/documentarray.js" id="schema-documentarray-js">schema/documentarray.js</a><div class="item method private"><h3 id="schema_documentarray_DocumentArray"><a href="#schema_documentarray_DocumentArray">DocumentArray(<code>key</code>, <code>schema</code>, <code>options</code>)</a></h3><p>SubdocsArray SchemaType constructor</p><div class="params"><h4>Parameters:</h4><ul><li><code>key</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>schema</code><span class="types"> &lt;<a href="#schema_Schema">Schema</a>&gt; </span><span></span></li><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="#schema_array_SchemaArray">SchemaArray</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">DocumentArray</span> <span class="hljs-params">(key, schema, options)</span> </span>{

  <span class="hljs-comment">// compile an embedded document for this schema</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">EmbeddedDocument</span> <span class="hljs-params">()</span> </span>{
    Subdocument.apply( <span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span> );
  }

  EmbeddedDocument.prototype = <span class="hljs-built_in">Object</span>.create( Subdocument.prototype );
  EmbeddedDocument.prototype.constructor = EmbeddedDocument;
  EmbeddedDocument.prototype.$__setSchema( schema );

  <span class="hljs-comment">// apply methods</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i <span class="hljs-keyword">in</span> schema.methods) {
    EmbeddedDocument.prototype[i] = schema.methods[i];
  }

  <span class="hljs-comment">// apply statics</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j <span class="hljs-keyword">in</span> schema.statics) {
    EmbeddedDocument[j] = schema.statics[j];
  }

  EmbeddedDocument.options = options;
  <span class="hljs-keyword">this</span>.schema = schema;

  ArrayType.call(<span class="hljs-keyword">this</span>, key, EmbeddedDocument, options);

  <span class="hljs-keyword">this</span>.schema = schema;
  <span class="hljs-keyword">var</span> path = <span class="hljs-keyword">this</span>.path;
  <span class="hljs-keyword">var</span> fn = <span class="hljs-keyword">this</span>.defaultValue;

  <span class="hljs-keyword">this</span>.default(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">var</span> arr = fn.call(<span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">Array</span>.isArray(arr)) arr = [arr];
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> StorageDocumentArray(arr, path, <span class="hljs-keyword">this</span>);
  });
}</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="schema_documentarray_DocumentArray-cast"><a href="#schema_documentarray_DocumentArray-cast">DocumentArray#cast(<code>value</code>, <code>doc</code>, <code>init</code>)</a></h3><p>Casts contents</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>doc</code><span class="types"> &lt;<a href="#document_Document">Document</a>&gt; </span><span>that triggers the casting</span></li><li><code>init</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span>flag</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">DocumentArray.prototype.cast = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value, doc, init, prev)</span> </span>{
  <span class="hljs-keyword">var</span> selected
    , subdoc
    , i;

  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">Array</span>.isArray(value)) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.cast([value], doc, init, prev);
  }

  <span class="hljs-keyword">if</span> (!(value.isStorageDocumentArray)) {
    value = <span class="hljs-keyword">new</span> StorageDocumentArray(value, <span class="hljs-keyword">this</span>.path, doc);
    <span class="hljs-keyword">if</span> (prev &amp;&amp; prev._handlers) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> prev._handlers) {
        doc.off(key, prev._handlers[key]);
      }
    }
  }

  i = value.length;

  <span class="hljs-keyword">while</span> (i--) {
    <span class="hljs-keyword">if</span> (!(value[i] <span class="hljs-keyword">instanceof</span> Subdocument) &amp;&amp; value[i]) {
      <span class="hljs-keyword">if</span> (init) {
        selected || (selected = scopePaths(<span class="hljs-keyword">this</span>, doc.$__.selected, init));
        subdoc = <span class="hljs-keyword">new</span> <span class="hljs-keyword">this</span>.casterConstructor(<span class="hljs-literal">null</span>, value, <span class="hljs-literal">true</span>, selected);
        value[i] = subdoc.init(value[i]);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">try</span> {
          subdoc = prev.id(value[i]._id);
        } <span class="hljs-keyword">catch</span>(e) {}

        <span class="hljs-keyword">if</span> (prev &amp;&amp; subdoc) {
          <span class="hljs-comment">// handle resetting doc with existing id but differing data</span>
          <span class="hljs-comment">// doc.array = [{ doc: 'val' }]</span>
          subdoc.set(value[i]);
        } <span class="hljs-keyword">else</span> {
          subdoc = <span class="hljs-keyword">new</span> <span class="hljs-keyword">this</span>.casterConstructor(value[i], value);
        }

        <span class="hljs-comment">// if set() is hooked it will have no return value</span>
        <span class="hljs-comment">// see gh-746</span>
        value[i] = subdoc;
      }
    }
  }

  <span class="hljs-keyword">return</span> value;
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="schema_documentarray_DocumentArray-doValidate"><a href="#schema_documentarray_DocumentArray-doValidate">DocumentArray#doValidate()</a></h3><p>Performs local validations first, then validations on each embedded doc</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">DocumentArray.prototype.doValidate = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(array, fn, scope)</span> </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;

  SchemaType.prototype.doValidate.call(<span class="hljs-keyword">this</span>, array, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
    <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> fn(err);

    <span class="hljs-keyword">var</span> count = array &amp;&amp; array.length
      , error;

    <span class="hljs-keyword">if</span> (!count) <span class="hljs-keyword">return</span> fn();

    <span class="hljs-comment">// handle sparse arrays, do not use array.forEach which does not</span>
    <span class="hljs-comment">// iterate over sparse elements yet reports array.length including</span>
    <span class="hljs-comment">// them :(</span>

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, len = count; i &lt; len; ++i) {
      <span class="hljs-comment">// sidestep sparse entries</span>
      <span class="hljs-keyword">var</span> doc = array[i];
      <span class="hljs-keyword">if</span> (!doc) {
        --count || fn();
        <span class="hljs-keyword">continue</span>;
      }

      !(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(i)</span> </span>{
        doc.validate(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
          <span class="hljs-keyword">if</span> (err &amp;&amp; !error) {
            <span class="hljs-comment">// rewrite the key</span>
            err.key = self.key + <span class="hljs-string">'.'</span> + i + <span class="hljs-string">'.'</span> + err.key;
            <span class="hljs-keyword">return</span> fn(error = err);
          }
          --count || fn();
        });
      })(i);
    }
  }, scope);
};</code></pre></div><hr class="private"></div></li><li class="module private"><a href="https://github.com/archangel-irk/storage/blob/0.0.1/lib/schema/mixed.js" id="schema-mixed-js">schema/mixed.js</a><div class="item method private"><h3 id="schema_mixed_Mixed"><a href="#schema_mixed_Mixed">Mixed(<code>path</code>, <code>options</code>)</a></h3><p>Mixed SchemaType constructor.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="#schematype_SchemaType">SchemaType</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Mixed</span> <span class="hljs-params">(path, options)</span> </span>{
  <span class="hljs-keyword">if</span> (options &amp;&amp; options.default) {
    <span class="hljs-keyword">var</span> def = options.default;
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(def) &amp;&amp; <span class="hljs-number">0</span> === def.length) {
      <span class="hljs-comment">// make sure empty array defaults are handled</span>
      options.default = <span class="hljs-built_in">Array</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!options.shared &amp;&amp;
               _.isPlainObject(def) &amp;&amp;
               <span class="hljs-number">0</span> === <span class="hljs-built_in">Object</span>.keys(def).length) {
      <span class="hljs-comment">// prevent odd "shared" objects between documents</span>
      options.default = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> {}
      }
    }
  }

  SchemaType.call(<span class="hljs-keyword">this</span>, path, options);
}</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="schema_mixed_Mixed-cast"><a href="#schema_mixed_Mixed-cast">Mixed#cast(<code>value</code>)</a></h3><p>Casts <code>val</code> for Mixed.</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>to cast</span></li></ul></div><div class="description"><p><em>this is a no-op</em></p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Mixed.prototype.cast = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value)</span> </span>{
  <span class="hljs-keyword">return</span> value;
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="schema_mixed_Mixed-checkRequired"><a href="#schema_mixed_Mixed-checkRequired">Mixed#checkRequired()</a></h3><p>Required validator</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Mixed.prototype.checkRequired = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(val)</span> </span>{
  <span class="hljs-keyword">return</span> (val !== <span class="hljs-literal">undefined</span>) &amp;&amp; (val !== <span class="hljs-literal">null</span>);
};</code></pre></div><hr class="private"></div></li><li class="module"><a href="https://github.com/archangel-irk/storage/blob/0.0.1/lib/schema/number.js" id="schema-number-js">schema/number.js</a><div class="item method private"><h3 id="schema_number_NumberSchema"><a href="#schema_number_NumberSchema">NumberSchema(<code>key</code>, <code>options</code>)</a></h3><p>Number SchemaType constructor.</p><div class="params"><h4>Parameters:</h4><ul><li><code>key</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="#schematype_SchemaType">SchemaType</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NumberSchema</span> <span class="hljs-params">(key, options)</span> </span>{
  SchemaType.call(<span class="hljs-keyword">this</span>, key, options, <span class="hljs-string">'Number'</span>);
}</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="schema_number_NumberSchema-cast"><a href="#schema_number_NumberSchema-cast">NumberSchema#cast(<code>value</code>)</a></h3><p>Casts to number</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>value to cast</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">NumberSchema.prototype.cast = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( value )</span> </span>{
  <span class="hljs-keyword">var</span> val = value &amp;&amp; value._id
    ? value._id <span class="hljs-comment">// documents</span>
    : value;

  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">isNaN</span>(val)){
    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> === val) <span class="hljs-keyword">return</span> val;
    <span class="hljs-keyword">if</span> (<span class="hljs-string">''</span> === val) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-string">'string'</span> == <span class="hljs-keyword">typeof</span> val) val = <span class="hljs-built_in">Number</span>(val);
    <span class="hljs-keyword">if</span> (val <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Number</span>) <span class="hljs-keyword">return</span> val;
    <span class="hljs-keyword">if</span> (<span class="hljs-string">'number'</span> == <span class="hljs-keyword">typeof</span> val) <span class="hljs-keyword">return</span> val;
    <span class="hljs-keyword">if</span> (val.toString &amp;&amp; !<span class="hljs-built_in">Array</span>.isArray(val) &amp;&amp;
        val.toString() == <span class="hljs-built_in">Number</span>(val)) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Number</span>(val);
    }
  }

  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CastError(<span class="hljs-string">'number'</span>, value, <span class="hljs-keyword">this</span>.path);
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="schema_number_NumberSchema-checkRequired"><a href="#schema_number_NumberSchema-checkRequired">NumberSchema#checkRequired()</a></h3><p>Required validator for number</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">NumberSchema.prototype.checkRequired = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( value )</span> </span>{
  <span class="hljs-keyword">if</span> ( SchemaType._isRef( <span class="hljs-keyword">this</span>, value ) ) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span> != value;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> value == <span class="hljs-string">'number'</span> || value <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Number</span>;
  }
};</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="schema_number_NumberSchema-max"><a href="#schema_number_NumberSchema-max">NumberSchema#max(<code>value</code>, <code>[message]</code>)</a></h3><p>Sets a maximum number validator.</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span>maximum number</span></li><li><code>[message]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>optional custom error message</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#schematype_SchemaType">SchemaType</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#error_messages_StorageError-messages" title="Customized Error Messages">Customized Error Messages</a></li></ul></div><div class="description"><h4>Example:</h4>
<pre><code><span class="hljs-keyword">var</span> s = <span class="hljs-keyword">new</span> Schema({ n: { type: <span class="hljs-built_in">Number</span>, max: <span class="hljs-number">10</span> })
<span class="hljs-keyword">var</span> M = db.model(&amp;#<span class="hljs-number">39</span>;M&amp;#<span class="hljs-number">39</span>;, s)
<span class="hljs-keyword">var</span> m = <span class="hljs-keyword">new</span> M({ n: <span class="hljs-number">11</span> })
m.save(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
  <span class="hljs-built_in">console</span>.error(err) <span class="hljs-comment">// validator error</span>
  m.n = <span class="hljs-number">10</span>;
  m.save() <span class="hljs-comment">// success</span>
})

<span class="hljs-comment">// custom error messages</span>
<span class="hljs-comment">// We can also use the special {MAX} token which will be replaced with the invalid value</span>
<span class="hljs-keyword">var</span> max = [<span class="hljs-number">10</span>, &amp;#<span class="hljs-number">39</span>;The value of path `{PATH}` ({VALUE}) exceeds the limit ({MAX}).&amp;#<span class="hljs-number">39</span>;];
<span class="hljs-keyword">var</span> schema = <span class="hljs-keyword">new</span> Schema({ n: { type: <span class="hljs-built_in">Number</span>, max: max })
<span class="hljs-keyword">var</span> M = mongoose.model(&amp;#<span class="hljs-number">39</span>;Measurement&amp;#<span class="hljs-number">39</span>;, schema);
<span class="hljs-keyword">var</span> s= <span class="hljs-keyword">new</span> M({ n: <span class="hljs-number">4</span> });
s.validate(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
  <span class="hljs-built_in">console</span>.log(<span class="hljs-built_in">String</span>(err)) <span class="hljs-comment">// ValidationError: The value of path `n` (4) exceeds the limit (10).</span>
})</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">NumberSchema.prototype.max = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value, message)</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.maxValidator) {
    <span class="hljs-keyword">this</span>.validators = <span class="hljs-keyword">this</span>.validators.filter(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(v)</span></span>{
      <span class="hljs-keyword">return</span> v[<span class="hljs-number">0</span>] != <span class="hljs-keyword">this</span>.maxValidator;
    }, <span class="hljs-keyword">this</span>);
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != value) {
    <span class="hljs-keyword">var</span> msg = message || errorMessages.Number.max;
    msg = msg.replace(<span class="hljs-regexp">/{MAX}/</span>, value);
    <span class="hljs-keyword">this</span>.validators.push([<span class="hljs-keyword">this</span>.maxValidator = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(v)</span></span>{
      <span class="hljs-keyword">return</span> v === <span class="hljs-literal">null</span> || v &lt;= value;
    }, msg, <span class="hljs-string">'max'</span>]);
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</code></pre></div><hr></div><div class="item method public"><h3 id="schema_number_NumberSchema-min"><a href="#schema_number_NumberSchema-min">NumberSchema#min(<code>value</code>, <code>[message]</code>)</a></h3><p>Sets a minimum number validator.</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span>minimum number</span></li><li><code>[message]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>optional custom error message</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#schematype_SchemaType">SchemaType</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#error_messages_StorageError-messages" title="Customized Error Messages">Customized Error Messages</a></li></ul></div><div class="description"><h4>Example:</h4>
<pre><code><span class="hljs-keyword">var</span> s = <span class="hljs-keyword">new</span> Schema({ n: { type: <span class="hljs-built_in">Number</span>, min: <span class="hljs-number">10</span> })
<span class="hljs-keyword">var</span> M = db.model(&amp;#<span class="hljs-number">39</span>;M&amp;#<span class="hljs-number">39</span>;, s)
<span class="hljs-keyword">var</span> m = <span class="hljs-keyword">new</span> M({ n: <span class="hljs-number">9</span> })
m.save(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
  <span class="hljs-built_in">console</span>.error(err) <span class="hljs-comment">// validator error</span>
  m.n = <span class="hljs-number">10</span>;
  m.save() <span class="hljs-comment">// success</span>
})

<span class="hljs-comment">// custom error messages</span>
<span class="hljs-comment">// We can also use the special {MIN} token which will be replaced with the invalid value</span>
<span class="hljs-keyword">var</span> min = [<span class="hljs-number">10</span>, &amp;#<span class="hljs-number">39</span>;The value of path `{PATH}` ({VALUE}) is beneath the limit ({MIN}).&amp;#<span class="hljs-number">39</span>;];
<span class="hljs-keyword">var</span> schema = <span class="hljs-keyword">new</span> Schema({ n: { type: <span class="hljs-built_in">Number</span>, min: min })
<span class="hljs-keyword">var</span> M = mongoose.model(&amp;#<span class="hljs-number">39</span>;Measurement&amp;#<span class="hljs-number">39</span>;, schema);
<span class="hljs-keyword">var</span> s= <span class="hljs-keyword">new</span> M({ n: <span class="hljs-number">4</span> });
s.validate(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
  <span class="hljs-built_in">console</span>.log(<span class="hljs-built_in">String</span>(err)) <span class="hljs-comment">// ValidationError: The value of path `n` (4) is beneath the limit (10).</span>
})</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">NumberSchema.prototype.min = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value, message)</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.minValidator) {
    <span class="hljs-keyword">this</span>.validators = <span class="hljs-keyword">this</span>.validators.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v)</span> </span>{
      <span class="hljs-keyword">return</span> v[<span class="hljs-number">0</span>] != <span class="hljs-keyword">this</span>.minValidator;
    }, <span class="hljs-keyword">this</span>);
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != value) {
    <span class="hljs-keyword">var</span> msg = message || errorMessages.Number.min;
    msg = msg.replace(<span class="hljs-regexp">/{MIN}/</span>, value);
    <span class="hljs-keyword">this</span>.validators.push([<span class="hljs-keyword">this</span>.minValidator = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v)</span> </span>{
      <span class="hljs-keyword">return</span> v === <span class="hljs-literal">null</span> || v &gt;= value;
    }, msg, <span class="hljs-string">'min'</span>]);
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</code></pre></div><hr></div></li><li class="module"><a href="https://github.com/archangel-irk/storage/blob/0.0.1/lib/schema/objectid.js" id="schema-objectid-js">schema/objectid.js</a><div class="item method private"><h3 id="schema_objectid_ObjectId"><a href="#schema_objectid_ObjectId">ObjectId(<code>key</code>, <code>options</code>)</a></h3><p>ObjectId SchemaType constructor.</p><div class="params"><h4>Parameters:</h4><ul><li><code>key</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="#schematype_SchemaType">SchemaType</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ObjectId</span> <span class="hljs-params">(key, options)</span> </span>{
  SchemaType.call(<span class="hljs-keyword">this</span>, key, options, <span class="hljs-string">'ObjectId'</span>);
}</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="schema_objectid_ObjectId-auto"><a href="#schema_objectid_ObjectId-auto">ObjectId#auto(<code>turnOn</code>)</a></h3><p>Adds an auto-generated ObjectId default if turnOn is true.</p><div class="params"><h4>Parameters:</h4><ul><li><code>turnOn</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span>auto generated ObjectId defaults</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#schematype_SchemaType">SchemaType</a>&gt; </span><span>this</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">ObjectId.prototype.auto = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( turnOn )</span> </span>{
  <span class="hljs-keyword">if</span> ( turnOn ) {
    <span class="hljs-keyword">this</span>.default( defaultId );
    <span class="hljs-keyword">this</span>.set( resetId )
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</code></pre></div><hr></div><div class="item method private"><h3 id="schema_objectid_ObjectId-cast"><a href="#schema_objectid_ObjectId-cast">ObjectId#cast(<code>value</code>)</a></h3><p>Casts to ObjectId</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">ObjectId.prototype.cast = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( value )</span> </span>{
  <span class="hljs-keyword">if</span> ( SchemaType._isRef( <span class="hljs-keyword">this</span>, value ) ) {
    <span class="hljs-comment">// wait! we may need to cast this to a document</span>

    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == value) {
      <span class="hljs-keyword">return</span> value;
    }

    <span class="hljs-comment">// lazy load</span>
    Document || (Document = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./../document'</span>));

    <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> Document) {
      value.$__.wasPopulated = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">return</span> value;
    }

    <span class="hljs-comment">// setting a populated path</span>
    <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> oid ) {
      <span class="hljs-keyword">return</span> value;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( !_.isPlainObject( value ) ) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CastError(<span class="hljs-string">'ObjectId'</span>, value, <span class="hljs-keyword">this</span>.path);
    }

    <span class="hljs-comment">// Нужно создать документ по схеме, указанной в ссылке</span>
    <span class="hljs-keyword">var</span> schema = <span class="hljs-keyword">this</span>.options.ref;
    <span class="hljs-keyword">if</span> ( !schema ){
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">TypeError</span>(<span class="hljs-string">'При ссылке (ref) на документ '</span> +
        <span class="hljs-string">'нужно указывать схему, по которой этот документ создавать'</span>);
    }

    <span class="hljs-keyword">if</span> ( !storage.schemas[ schema ] ){
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">TypeError</span>(<span class="hljs-string">'При ссылке (ref) на документ '</span> +
        <span class="hljs-string">'нужно указывать название схемы на которую ссылаемся при её создании ( new Schema("name", schemaObject) )'</span>);
    }

    <span class="hljs-comment">// init doc</span>
    <span class="hljs-keyword">var</span> doc = <span class="hljs-keyword">new</span> Document( value, <span class="hljs-literal">undefined</span>, storage.schemas[ schema ], <span class="hljs-literal">undefined</span>, <span class="hljs-literal">true</span> );
    doc.$__.wasPopulated = <span class="hljs-literal">true</span>;

    <span class="hljs-keyword">return</span> doc;
  }

  <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> value;

  <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> oid)
    <span class="hljs-keyword">return</span> value;

  <span class="hljs-keyword">if</span> ( value._id &amp;&amp; value._id <span class="hljs-keyword">instanceof</span> oid )
    <span class="hljs-keyword">return</span> value._id;

  <span class="hljs-keyword">if</span> (value.toString) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">return</span> oid.createFromHexString(value.toString());
    } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CastError(<span class="hljs-string">'ObjectId'</span>, value, <span class="hljs-keyword">this</span>.path);
    }
  }

  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CastError(<span class="hljs-string">'ObjectId'</span>, value, <span class="hljs-keyword">this</span>.path);
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="schema_objectid_ObjectId-checkRequired"><a href="#schema_objectid_ObjectId-checkRequired">ObjectId#checkRequired()</a></h3><p>Check required</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">ObjectId.prototype.checkRequired = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( value )</span> </span>{
  <span class="hljs-keyword">if</span> (SchemaType._isRef( <span class="hljs-keyword">this</span>, value )) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span> != value;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> value <span class="hljs-keyword">instanceof</span> oid;
  }
};</code></pre></div><hr class="private"></div></li><li class="module"><a href="https://github.com/archangel-irk/storage/blob/0.0.1/lib/schema/string.js" id="schema-string-js">schema/string.js</a><div class="item method private"><h3 id="schema_string_StringSchema"><a href="#schema_string_StringSchema">StringSchema(<code>key</code>, <code>options</code>)</a></h3><p>String SchemaType constructor.</p><div class="params"><h4>Parameters:</h4><ul><li><code>key</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="#schematype_SchemaType">SchemaType</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">StringSchema</span> <span class="hljs-params">(key, options)</span> </span>{
  <span class="hljs-keyword">this</span>.enumValues = [];
  <span class="hljs-keyword">this</span>.regExp = <span class="hljs-literal">null</span>;
  SchemaType.call(<span class="hljs-keyword">this</span>, key, options, <span class="hljs-string">'String'</span>);
}</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="schema_string_StringSchema-cast"><a href="#schema_string_StringSchema-cast">StringSchema#cast()</a></h3><p>Casts to String</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">StringSchema.prototype.cast = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( value )</span> </span>{
  <span class="hljs-keyword">if</span> ( value === <span class="hljs-literal">null</span> ) {
    <span class="hljs-keyword">return</span> value;
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-string">'undefined'</span> !== <span class="hljs-keyword">typeof</span> value) {
    <span class="hljs-comment">// handle documents being passed</span>
    <span class="hljs-keyword">if</span> (value._id &amp;&amp; <span class="hljs-string">'string'</span> == <span class="hljs-keyword">typeof</span> value._id) {
      <span class="hljs-keyword">return</span> value._id;
    }
    <span class="hljs-keyword">if</span> ( value.toString ) {
      <span class="hljs-keyword">return</span> value.toString();
    }
  }

  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CastError(<span class="hljs-string">'string'</span>, value, <span class="hljs-keyword">this</span>.path);
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="schema_string_StringSchema-checkRequired"><a href="#schema_string_StringSchema-checkRequired">StringSchema#checkRequired(<code>value</code>)</a></h3><p>Check required</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="#null">null</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/undefined">undefined</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">StringSchema.prototype.checkRequired = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkRequired</span> <span class="hljs-params">(value, doc)</span> </span>{
  <span class="hljs-keyword">if</span> (SchemaType._isRef(<span class="hljs-keyword">this</span>, value, doc, <span class="hljs-literal">true</span>)) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span> != value;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> (value <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">String</span> || <span class="hljs-keyword">typeof</span> value == <span class="hljs-string">'string'</span>) &amp;&amp; value.length;
  }
};</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="schema_string_StringSchema-enum"><a href="#schema_string_StringSchema-enum">StringSchema#enum(<code>[args...]</code>)</a></h3><p>Adds an enum validator</p><div class="params"><h4>Parameters:</h4><ul><li><code>[args...]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>enumeration values</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#schematype_SchemaType">SchemaType</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#error_messages_StorageError-messages" title="Customized Error Messages">Customized Error Messages</a></li></ul></div><div class="description"><h4>Example:</h4>
<pre><code><span class="hljs-keyword">var</span> states = &amp;#<span class="hljs-number">39</span>;opening open closing closed&amp;#<span class="hljs-number">39</span>;.split(&amp;#<span class="hljs-number">39</span>; &amp;#<span class="hljs-number">39</span>;)
<span class="hljs-keyword">var</span> s = <span class="hljs-keyword">new</span> Schema({ state: { type: <span class="hljs-built_in">String</span>, enum: states }})
<span class="hljs-keyword">var</span> M = db.model(&amp;#<span class="hljs-number">39</span>;M&amp;#<span class="hljs-number">39</span>;, s)
<span class="hljs-keyword">var</span> m = <span class="hljs-keyword">new</span> M({ state: &amp;#<span class="hljs-number">39</span>;invalid&amp;#<span class="hljs-number">39</span>; })
m.save(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
  <span class="hljs-built_in">console</span>.error(<span class="hljs-built_in">String</span>(err)) <span class="hljs-comment">// ValidationError: `invalid` is not a valid enum value for path `state`.</span>
  m.state = &amp;#<span class="hljs-number">39</span>;open&amp;#<span class="hljs-number">39</span>;
  m.save(callback) <span class="hljs-comment">// success</span>
})

<span class="hljs-comment">// or with custom error messages</span>
<span class="hljs-keyword">var</span> enu = {
  values: &amp;#<span class="hljs-number">39</span>;opening open closing closed&amp;#<span class="hljs-number">39</span>;.split(&amp;#<span class="hljs-number">39</span>; &amp;#<span class="hljs-number">39</span>;),
  message: &amp;#<span class="hljs-number">39</span>;enum validator failed <span class="hljs-keyword">for</span> path `{PATH}` <span class="hljs-keyword">with</span> value `{VALUE}`&amp;#<span class="hljs-number">39</span>;
}
<span class="hljs-keyword">var</span> s = <span class="hljs-keyword">new</span> Schema({ state: { type: <span class="hljs-built_in">String</span>, enum: enu })
<span class="hljs-keyword">var</span> M = db.model(&amp;#<span class="hljs-number">39</span>;M&amp;#<span class="hljs-number">39</span>;, s)
<span class="hljs-keyword">var</span> m = <span class="hljs-keyword">new</span> M({ state: &amp;#<span class="hljs-number">39</span>;invalid&amp;#<span class="hljs-number">39</span>; })
m.save(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
  <span class="hljs-built_in">console</span>.error(<span class="hljs-built_in">String</span>(err)) <span class="hljs-comment">// ValidationError: enum validator failed for path `state` with value `invalid`</span>
  m.state = &amp;#<span class="hljs-number">39</span>;open&amp;#<span class="hljs-number">39</span>;
  m.save(callback) <span class="hljs-comment">// success</span>
})</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">StringSchema.prototype.enum = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.enumValidator) {
    <span class="hljs-keyword">this</span>.validators = <span class="hljs-keyword">this</span>.validators.filter(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(v)</span></span>{
      <span class="hljs-keyword">return</span> v[<span class="hljs-number">0</span>] != <span class="hljs-keyword">this</span>.enumValidator;
    }, <span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">this</span>.enumValidator = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-literal">undefined</span> === <span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>] || <span class="hljs-literal">false</span> === <span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>]) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  }

  <span class="hljs-keyword">var</span> values;
  <span class="hljs-keyword">var</span> errorMessage;

  <span class="hljs-keyword">if</span> (_.isPlainObject(<span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>])) {
    values = <span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>].values;
    errorMessage = <span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>].message;
  } <span class="hljs-keyword">else</span> {
    values = <span class="hljs-built_in">arguments</span>;
    errorMessage = errorMessages.String.enum;
  }

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; values.length; i++) {
    <span class="hljs-keyword">if</span> (<span class="hljs-literal">undefined</span> !== values[i]) {
      <span class="hljs-keyword">this</span>.enumValues.push(<span class="hljs-keyword">this</span>.cast(values[i]));
    }
  }

  <span class="hljs-keyword">var</span> vals = <span class="hljs-keyword">this</span>.enumValues;
  <span class="hljs-keyword">this</span>.enumValidator = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span> === v || ~vals.indexOf(v);
  };
  <span class="hljs-keyword">this</span>.validators.push([<span class="hljs-keyword">this</span>.enumValidator, errorMessage, <span class="hljs-string">'enum'</span>]);

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</code></pre></div><hr></div><div class="item method public"><h3 id="schema_string_StringSchema-lowercase"><a href="#schema_string_StringSchema-lowercase">StringSchema#lowercase()</a></h3><p>Adds a lowercase setter.</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#schematype_SchemaType">SchemaType</a>&gt; </span><span>this</span></li></ul></div><div class="description"><h4>Example:</h4>
<pre><code><span class="hljs-keyword">var</span> s = <span class="hljs-keyword">new</span> Schema({ email: { type: <span class="hljs-built_in">String</span>, lowercase: <span class="hljs-literal">true</span> }})
<span class="hljs-keyword">var</span> M = db.model(&amp;#<span class="hljs-number">39</span>;M&amp;#<span class="hljs-number">39</span>;, s);
<span class="hljs-keyword">var</span> m = <span class="hljs-keyword">new</span> M({ email: &amp;#<span class="hljs-number">39</span>;SomeEmail@example.COM&amp;#<span class="hljs-number">39</span>; });
<span class="hljs-built_in">console</span>.log(m.email) <span class="hljs-comment">// someemail@example.com</span></code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">StringSchema.prototype.lowercase = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.set(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v, self)</span> </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-string">'string'</span> != <span class="hljs-keyword">typeof</span> v) v = self.cast(v);
    <span class="hljs-keyword">if</span> (v) <span class="hljs-keyword">return</span> v.toLowerCase();
    <span class="hljs-keyword">return</span> v;
  });
};</code></pre></div><hr></div><div class="item method public"><h3 id="schema_string_StringSchema-match"><a href="#schema_string_StringSchema-match">StringSchema#match(<code>regExp</code>, <code>[message]</code>)</a></h3><p>Sets a regexp validator.</p><div class="params"><h4>Parameters:</h4><ul><li><code>regExp</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/RegExp">RegExp</a>&gt; </span><span>regular expression to test against</span></li><li><code>[message]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>optional custom error message</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#schematype_SchemaType">SchemaType</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#error_messages_StorageError-messages" title="Customized Error Messages">Customized Error Messages</a></li></ul></div><div class="description"><p>Any value that does not pass <code>regExp</code>.test(val) will fail validation.</p><h4>Example:</h4>
<pre><code><span class="hljs-keyword">var</span> s = <span class="hljs-keyword">new</span> Schema({ name: { type: <span class="hljs-built_in">String</span>, match: <span class="hljs-regexp">/^a/</span> }})
<span class="hljs-keyword">var</span> M = db.model(&amp;#<span class="hljs-number">39</span>;M&amp;#<span class="hljs-number">39</span>;, s)
<span class="hljs-keyword">var</span> m = <span class="hljs-keyword">new</span> M({ name: &amp;#<span class="hljs-number">39</span>;I am invalid&amp;#<span class="hljs-number">39</span>; })
m.validate(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
  <span class="hljs-built_in">console</span>.error(<span class="hljs-built_in">String</span>(err)) <span class="hljs-comment">// &amp;quot;ValidationError: Path `name` is invalid (I am invalid).&amp;quot;</span>
  m.name = &amp;#<span class="hljs-number">39</span>;apples&amp;#<span class="hljs-number">39</span>;
  m.validate(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
    assert.ok(err) <span class="hljs-comment">// success</span>
  })
})

<span class="hljs-comment">// using a custom error message</span>
<span class="hljs-keyword">var</span> match = [ <span class="hljs-regexp">/\.html$/</span>, &amp;quot;That file doesn&amp;#<span class="hljs-number">39</span>;t end <span class="hljs-keyword">in</span> .html ({VALUE})&amp;quot; ];
<span class="hljs-keyword">var</span> s = <span class="hljs-keyword">new</span> Schema({ file: { type: <span class="hljs-built_in">String</span>, match: match }})
<span class="hljs-keyword">var</span> M = db.model(&amp;#<span class="hljs-number">39</span>;M&amp;#<span class="hljs-number">39</span>;, s);
<span class="hljs-keyword">var</span> m = <span class="hljs-keyword">new</span> M({ file: &amp;#<span class="hljs-number">39</span>;invalid&amp;#<span class="hljs-number">39</span>; });
m.validate(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
  <span class="hljs-built_in">console</span>.log(<span class="hljs-built_in">String</span>(err)) <span class="hljs-comment">// &amp;quot;ValidationError: That file doesn&amp;#39;t end in .html (invalid)&amp;quot;</span>
})</code></pre><p>Empty strings, <code>undefined</code>, and <code>null</code> values always pass the match validator. If you require these values, enable the <code>required</code> validator also.</p><pre><code><span class="hljs-keyword">var</span> s = <span class="hljs-keyword">new</span> Schema({ name: { type: <span class="hljs-built_in">String</span>, match: <span class="hljs-regexp">/^a/</span>, required: <span class="hljs-literal">true</span> }})</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">StringSchema.prototype.match = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">match</span> <span class="hljs-params">(regExp, message)</span> </span>{
  <span class="hljs-comment">// yes, we allow multiple match validators</span>

  <span class="hljs-keyword">var</span> msg = message || errorMessages.String.match;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">matchValidator</span> <span class="hljs-params">(v)</span></span>{
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span> != v &amp;&amp; <span class="hljs-string">''</span> !== v
      ? regExp.test(v)
      : <span class="hljs-literal">true</span>
  }

  <span class="hljs-keyword">this</span>.validators.push([matchValidator, msg, <span class="hljs-string">'regexp'</span>]);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</code></pre></div><hr></div><div class="item method public"><h3 id="schema_string_StringSchema-trim"><a href="#schema_string_StringSchema-trim">StringSchema#trim()</a></h3><p>Adds a trim setter.</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#schematype_SchemaType">SchemaType</a>&gt; </span><span>this</span></li></ul></div><div class="description"><p>The string value will be trimmed when set.</p><h4>Example:</h4>
<pre><code><span class="hljs-keyword">var</span> s = <span class="hljs-keyword">new</span> Schema({ name: { type: <span class="hljs-built_in">String</span>, trim: <span class="hljs-literal">true</span> }})
<span class="hljs-keyword">var</span> M = db.model(&amp;#<span class="hljs-number">39</span>;M&amp;#<span class="hljs-number">39</span>;, s)
<span class="hljs-keyword">var</span> string = &amp;#<span class="hljs-number">39</span>; some name &amp;#<span class="hljs-number">39</span>;
<span class="hljs-built_in">console</span>.log(string.length) <span class="hljs-comment">// 11</span>
<span class="hljs-keyword">var</span> m = <span class="hljs-keyword">new</span> M({ name: string })
<span class="hljs-built_in">console</span>.log(m.name.length) <span class="hljs-comment">// 9</span></code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">StringSchema.prototype.trim = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.set(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v, self)</span> </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-string">'string'</span> != <span class="hljs-keyword">typeof</span> v) v = self.cast(v);
    <span class="hljs-keyword">if</span> (v) <span class="hljs-keyword">return</span> v.trim();
    <span class="hljs-keyword">return</span> v;
  });
};</code></pre></div><hr></div><div class="item method public"><h3 id="schema_string_StringSchema-uppercase"><a href="#schema_string_StringSchema-uppercase">StringSchema#uppercase()</a></h3><p>Adds an uppercase setter.</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#schematype_SchemaType">SchemaType</a>&gt; </span><span>this</span></li></ul></div><div class="description"><h4>Example:</h4>
<pre><code><span class="hljs-keyword">var</span> s = <span class="hljs-keyword">new</span> Schema({ caps: { type: <span class="hljs-built_in">String</span>, uppercase: <span class="hljs-literal">true</span> }})
<span class="hljs-keyword">var</span> M = db.model(&amp;#<span class="hljs-number">39</span>;M&amp;#<span class="hljs-number">39</span>;, s);
<span class="hljs-keyword">var</span> m = <span class="hljs-keyword">new</span> M({ caps: &amp;#<span class="hljs-number">39</span>;an example&amp;#<span class="hljs-number">39</span>; });
<span class="hljs-built_in">console</span>.log(m.caps) <span class="hljs-comment">// AN EXAMPLE</span></code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">StringSchema.prototype.uppercase = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.set(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v, self)</span> </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-string">'string'</span> != <span class="hljs-keyword">typeof</span> v) v = self.cast(v);
    <span class="hljs-keyword">if</span> (v) <span class="hljs-keyword">return</span> v.toUpperCase();
    <span class="hljs-keyword">return</span> v;
  });
};</code></pre></div><hr></div></li><li class="module"><a href="https://github.com/archangel-irk/storage/blob/0.0.1/lib/schema.js" id="schema-js">schema.js</a><div class="item method public"><h3 id="schema_Schema"><a href="#schema_Schema">Schema(<code>[name]</code>, <code>[baseSchema]</code>, <code>obj</code>, <code>[options]</code>)</a></h3><p>Schema constructor.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[name]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/undefined">undefined</a>&gt; </span><span>Название схемы</span></li><li><code>[baseSchema]</code><span class="types"> &lt;<a href="#schema_Schema">Schema</a>&gt; </span><span>Базовая схема при наследовании</span></li><li><code>obj</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>Схема</span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="description"><h4>Example:</h4>
<pre><code><span class="hljs-keyword">var</span> child = <span class="hljs-keyword">new</span> Schema({ name: <span class="hljs-built_in">String</span> });
<span class="hljs-keyword">var</span> schema = <span class="hljs-keyword">new</span> Schema({ name: <span class="hljs-built_in">String</span>, age: <span class="hljs-built_in">Number</span>, children: [child] });
<span class="hljs-keyword">var</span> Tree = mongoose.model(&amp;#<span class="hljs-number">39</span>;Tree&amp;#<span class="hljs-number">39</span>;, schema);

<span class="hljs-comment">// setting schema options</span>
<span class="hljs-keyword">new</span> Schema({ name: <span class="hljs-built_in">String</span> }, { _id: <span class="hljs-literal">false</span>, autoIndex: <span class="hljs-literal">false</span> })</code></pre><h4>Options:</h4>
<ul>
<li><a href="/docs/guide.html#collection">collection</a>: string - no default</li>
<li><a href="/docs/guide.html#id">id</a>: bool - defaults to true</li>
<li><code>minimize</code>: bool - controls <a href="#document_Document-toObject">document#toObject</a> behavior when called manually - defaults to true</li>
<li><a href="/docs/guide.html#strict">strict</a>: bool - defaults to true</li>
<li><a href="/docs/guide.html#toJSON">toJSON</a> - object - no default</li>
<li><a href="/docs/guide.html#toObject">toObject</a> - object - no default</li>
<li><a href="/docs/guide.html#versionKey">versionKey</a>: bool - defaults to &quot;__v&quot;</li>
</ul>
<h4>Note:</h4>
<p><em>When nesting schemas, (<code>children</code> in the example above), always declare the child schema first before passing it into is parent.</em></p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Schema</span> <span class="hljs-params">( name, baseSchema, obj, options )</span> </span>{
  <span class="hljs-keyword">if</span> ( !(<span class="hljs-keyword">this</span> <span class="hljs-keyword">instanceof</span> Schema) )
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Schema( name, baseSchema, obj, options );

  <span class="hljs-comment">// Если это именованая схема</span>
  <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">typeof</span> name === <span class="hljs-string">'string'</span> ){
    <span class="hljs-keyword">this</span>.name = name;
    schemas[ name ] = <span class="hljs-keyword">this</span>;
  } <span class="hljs-keyword">else</span> {
    options = obj;
    obj = baseSchema;
    baseSchema = name;
    name = <span class="hljs-literal">undefined</span>;
  }

  <span class="hljs-keyword">if</span> ( !(baseSchema <span class="hljs-keyword">instanceof</span> Schema) ){
    options = obj;
    obj = baseSchema;
    baseSchema = <span class="hljs-literal">undefined</span>;
  }

  <span class="hljs-comment">// Сохраним описание схемы для поддержки дискриминаторов</span>
  <span class="hljs-keyword">this</span>.source = obj;

  <span class="hljs-keyword">this</span>.paths = {};
  <span class="hljs-keyword">this</span>.subpaths = {};
  <span class="hljs-keyword">this</span>.virtuals = {};
  <span class="hljs-keyword">this</span>.nested = {};
  <span class="hljs-keyword">this</span>.inherits = {};
  <span class="hljs-keyword">this</span>.callQueue = [];
  <span class="hljs-keyword">this</span>.methods = {};
  <span class="hljs-keyword">this</span>.statics = {};
  <span class="hljs-keyword">this</span>.tree = {};
  <span class="hljs-keyword">this</span>._requiredpaths = <span class="hljs-literal">undefined</span>;
  <span class="hljs-keyword">this</span>.discriminatorMapping = <span class="hljs-literal">undefined</span>;

  <span class="hljs-keyword">this</span>.options = <span class="hljs-keyword">this</span>.defaultOptions( options );

  <span class="hljs-keyword">if</span> ( baseSchema <span class="hljs-keyword">instanceof</span> Schema ){
    baseSchema.discriminator( name, <span class="hljs-keyword">this</span> );
  }

  <span class="hljs-comment">// build paths</span>
  <span class="hljs-keyword">if</span> ( obj ) {
    <span class="hljs-keyword">this</span>.add( obj );
  }

  <span class="hljs-comment">// ensure the documents get an auto _id unless disabled</span>
  <span class="hljs-keyword">var</span> auto_id = !<span class="hljs-keyword">this</span>.paths[<span class="hljs-string">'_id'</span>] &amp;&amp; (!<span class="hljs-keyword">this</span>.options.noId &amp;&amp; <span class="hljs-keyword">this</span>.options._id);
  <span class="hljs-keyword">if</span> (auto_id) {
    <span class="hljs-keyword">this</span>.add({ _id: {type: Schema.ObjectId, auto: <span class="hljs-literal">true</span>} });
  }

  <span class="hljs-comment">// ensure the documents receive an id getter unless disabled</span>
  <span class="hljs-keyword">var</span> autoid = !<span class="hljs-keyword">this</span>.paths[<span class="hljs-string">'id'</span>] &amp;&amp; <span class="hljs-keyword">this</span>.options.id;
  <span class="hljs-keyword">if</span> ( autoid ) {
    <span class="hljs-keyword">this</span>.virtual(<span class="hljs-string">'id'</span>).get( idGetter );
  }
}</code></pre></div><hr></div><div class="item method public"><h3 id="schema_Schema-add"><a href="#schema_Schema-add">Schema#add(<code>obj</code>, <code>prefix</code>)</a></h3><p>Adds key path / schema type pairs to this schema.</p><div class="params"><h4>Parameters:</h4><ul><li><code>obj</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>prefix</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="description"><h4>Example:</h4>
<pre><code><span class="hljs-keyword">var</span> ToySchema = <span class="hljs-keyword">new</span> Schema;
ToySchema.add({ name: &amp;#<span class="hljs-number">39</span>;string&amp;#<span class="hljs-number">39</span>;, color: &amp;#<span class="hljs-number">39</span>;string&amp;#<span class="hljs-number">39</span>;, price: &amp;#<span class="hljs-number">39</span>;number&amp;#<span class="hljs-number">39</span>; });</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.add = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add</span> <span class="hljs-params">( obj, prefix )</span> </span>{
  prefix = prefix || <span class="hljs-string">''</span>;
  <span class="hljs-keyword">var</span> keys = <span class="hljs-built_in">Object</span>.keys( obj );

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; keys.length; ++i) {
    <span class="hljs-keyword">var</span> key = keys[i];

    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == obj[ key ]) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">TypeError</span>(<span class="hljs-string">'Invalid value for schema path `'</span>+ prefix + key +<span class="hljs-string">'`'</span>);
    }

    <span class="hljs-keyword">if</span> ( _.isPlainObject(obj[key] )
      &amp;&amp; ( !obj[ key ].constructor || <span class="hljs-string">'Object'</span> == utils.getFunctionName(obj[key].constructor) )
      &amp;&amp; ( !obj[ key ].type || obj[ key ].type.type ) ){

      <span class="hljs-keyword">if</span> ( <span class="hljs-built_in">Object</span>.keys(obj[ key ]).length ) {
        <span class="hljs-comment">// nested object { last: { name: String }}</span>
        <span class="hljs-keyword">this</span>.nested[ prefix + key ] = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">this</span>.add( obj[ key ], prefix + key + <span class="hljs-string">'.'</span>);

      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>.path( prefix + key, obj[ key ] ); <span class="hljs-comment">// mixed type</span>
      }

    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">this</span>.path( prefix + key, obj[ key ] );
    }
  }
};</code></pre></div><hr></div><div class="item method private"><h3 id="schema_Schema-defaultOptions"><a href="#schema_Schema-defaultOptions">Schema#defaultOptions(<code>options</code>)</a></h3><p>Returns default options for this schema, merged with <code>options</code>.</p><div class="params"><h4>Parameters:</h4><ul><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.defaultOptions = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> </span>{
  options = $.extend({
      strict: <span class="hljs-literal">true</span>
    , versionKey: <span class="hljs-string">'__v'</span>
    , discriminatorKey: <span class="hljs-string">'__t'</span>
    , minimize: <span class="hljs-literal">true</span>
    <span class="hljs-comment">// the following are only applied at construction time</span>
    , _id: <span class="hljs-literal">true</span>
    , id: <span class="hljs-literal">true</span>
  }, options );

  <span class="hljs-keyword">return</span> options;
};</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="schema_Schema-discriminator"><a href="#schema_Schema-discriminator">Schema#discriminator(<code>name</code>, <code>schema</code>)</a></h3><p>Наследование от схемы.<br />this - базовая схема!!!</p><div class="params"><h4>Parameters:</h4><ul><li><code>name</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>discriminator name</span></li><li><code>schema</code><span class="types"> &lt;<a href="#schema_Schema">Schema</a>&gt; </span><span>discriminator schema</span></li></ul></div><div class="description"><h4>Example:</h4>
<pre><code><span class="hljs-keyword">var</span> PersonSchema = <span class="hljs-keyword">new</span> Schema(&amp;#<span class="hljs-number">39</span>;Person&amp;#<span class="hljs-number">39</span>;, {
  name: <span class="hljs-built_in">String</span>,
  createdAt: <span class="hljs-built_in">Date</span>
});

<span class="hljs-keyword">var</span> BossSchema = <span class="hljs-keyword">new</span> Schema(&amp;#<span class="hljs-number">39</span>;Boss&amp;#<span class="hljs-number">39</span>;, PersonSchema, { department: <span class="hljs-built_in">String</span> });</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.discriminator = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">discriminator</span> <span class="hljs-params">(name, schema)</span> </span>{
  <span class="hljs-keyword">if</span> (!(schema <span class="hljs-keyword">instanceof</span> Schema)) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"You must pass a valid discriminator Schema"</span>);
  }

  <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">this</span>.discriminatorMapping &amp;&amp; !<span class="hljs-keyword">this</span>.discriminatorMapping.isRoot ) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Discriminator \""</span> + name + <span class="hljs-string">"\" can only be a discriminator of the root model"</span>);
  }

  <span class="hljs-keyword">var</span> key = <span class="hljs-keyword">this</span>.options.discriminatorKey;
  <span class="hljs-keyword">if</span> ( schema.path(key) ) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Discriminator \""</span> + name + <span class="hljs-string">"\" cannot have field with name \""</span> + key + <span class="hljs-string">"\""</span>);
  }

  <span class="hljs-comment">// merges base schema into new discriminator schema and sets new type field.</span>
  (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">mergeSchemas</span><span class="hljs-params">(schema, baseSchema)</span> </span>{
    utils.merge(schema, baseSchema);

    <span class="hljs-keyword">var</span> obj = {};
    obj[key] = { type: <span class="hljs-built_in">String</span>, <span class="hljs-keyword">default</span>: name };
    schema.add(obj);
    schema.discriminatorMapping = { key: key, value: name, isRoot: <span class="hljs-literal">false</span> };

    <span class="hljs-keyword">if</span> (baseSchema.options.collection) {
      schema.options.collection = baseSchema.options.collection;
    }

      <span class="hljs-comment">// throws error if options are invalid</span>
    (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">validateOptions</span><span class="hljs-params">(a, b)</span> </span>{
      a = utils.clone(a);
      b = utils.clone(b);
      <span class="hljs-keyword">delete</span> a.toJSON;
      <span class="hljs-keyword">delete</span> a.toObject;
      <span class="hljs-keyword">delete</span> b.toJSON;
      <span class="hljs-keyword">delete</span> b.toObject;

      <span class="hljs-keyword">if</span> (!utils.deepEqual(a, b)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Discriminator options are not customizable (except toJSON &amp; toObject)"</span>);
      }
    })(schema.options, baseSchema.options);

    <span class="hljs-keyword">var</span> toJSON = schema.options.toJSON
      , toObject = schema.options.toObject;

    schema.options = utils.clone(baseSchema.options);
    <span class="hljs-keyword">if</span> (toJSON)   schema.options.toJSON = toJSON;
    <span class="hljs-keyword">if</span> (toObject) schema.options.toObject = toObject;

    <span class="hljs-comment">//schema.callQueue = baseSchema.callQueue.concat(schema.callQueue);</span>
    schema._requiredpaths = <span class="hljs-literal">undefined</span>; <span class="hljs-comment">// reset just in case Schema#requiredPaths() was called on either schema</span>
  })(schema, <span class="hljs-keyword">this</span>);

  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.discriminators) {
    <span class="hljs-keyword">this</span>.discriminators = {};
  }

  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.discriminatorMapping) {
    <span class="hljs-keyword">this</span>.discriminatorMapping = { key: key, value: <span class="hljs-literal">null</span>, isRoot: <span class="hljs-literal">true</span> };
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.discriminators[name]) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Discriminator with name \""</span> + name + <span class="hljs-string">"\" already exists"</span>);
  }

  <span class="hljs-keyword">this</span>.discriminators[name] = schema;
};</code></pre></div><hr></div><div class="item method public"><h3 id="schema_Schema-eachPath"><a href="#schema_Schema-eachPath">Schema#eachPath(<code>fn</code>)</a></h3><p>Iterates the schemas paths similar to Array#forEach.</p><div class="params"><h4>Parameters:</h4><ul><li><code>fn</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>callback function</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#schema_Schema">Schema</a>&gt; </span><span>this</span></li></ul></div><div class="description"><p>The callback is passed the pathname and schemaType as arguments on each iteration.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.eachPath = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn)</span> </span>{
  <span class="hljs-keyword">var</span> keys = <span class="hljs-built_in">Object</span>.keys(<span class="hljs-keyword">this</span>.paths)
    , len = keys.length;

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; len; ++i) {
    fn(keys[i], <span class="hljs-keyword">this</span>.paths[keys[i]]);
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</code></pre></div><hr></div><div class="item method public"><h3 id="schema_Schema-get"><a href="#schema_Schema-get">Schema#get(<code>key</code>)</a></h3><p>Gets a schema option.</p><div class="params"><h4>Parameters:</h4><ul><li><code>key</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>option name</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.get = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.options[key];
};</code></pre></div><hr></div><div class="item method public"><h3 id="schema_Schema-method"><a href="#schema_Schema-method">Schema#method(<code>method</code>, <code>[fn]</code>)</a></h3><p>Adds an instance method to documents constructed from Models compiled from this schema.</p><div class="params"><h4>Parameters:</h4><ul><li><code>method</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>name</span></li><li><code>[fn]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="description"><h4>Example</h4>
<pre><code><span class="hljs-keyword">var</span> schema = kittySchema = <span class="hljs-keyword">new</span> Schema(..);

schema.method(&amp;#<span class="hljs-number">39</span>;meow&amp;#<span class="hljs-number">39</span>;, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-built_in">console</span>.log(&amp;#<span class="hljs-number">39</span>;meeeeeoooooooooooow&amp;#<span class="hljs-number">39</span>;);
})

<span class="hljs-keyword">var</span> Kitty = mongoose.model(&amp;#<span class="hljs-number">39</span>;Kitty&amp;#<span class="hljs-number">39</span>;, schema);

<span class="hljs-keyword">var</span> fizz = <span class="hljs-keyword">new</span> Kitty;
fizz.meow(); <span class="hljs-comment">// meeeeeooooooooooooow</span></code></pre><p>If a hash of name/fn pairs is passed as the only argument, each name/fn pair will be added as methods.</p><pre><code>schema.method({
    purr: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{}
  , scratch: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{}
});

<span class="hljs-comment">// later</span>
fizz.purr();
fizz.scratch();</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.method = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(name, fn)</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-string">'string'</span> != <span class="hljs-keyword">typeof</span> name)
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i <span class="hljs-keyword">in</span> name)
      <span class="hljs-keyword">this</span>.methods[i] = name[i];
  <span class="hljs-keyword">else</span>
    <span class="hljs-keyword">this</span>.methods[name] = fn;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</code></pre></div><hr></div><div class="item method public"><h3 id="schema_Schema-path"><a href="#schema_Schema-path">Schema#path(<code>path</code>, <code>constructor</code>)</a></h3><p>Gets/sets schema paths.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>constructor</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="description"><p>Sets a path (if arity 2)<br />Gets a path (if arity 1)</p><h4>Example</h4>
<pre><code>schema.path(&amp;#<span class="hljs-number">39</span>;name&amp;#<span class="hljs-number">39</span>;) <span class="hljs-comment">// returns a SchemaType</span>
schema.path(&amp;#<span class="hljs-number">39</span>;name&amp;#<span class="hljs-number">39</span>;, <span class="hljs-built_in">Number</span>) <span class="hljs-comment">// changes the schemaType of `name` to Number</span></code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.path = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(path, obj)</span> </span>{
  <span class="hljs-keyword">if</span> (obj == <span class="hljs-literal">undefined</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.paths[path]) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.paths[path];
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.subpaths[path]) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.subpaths[path];

    <span class="hljs-comment">// subpaths?</span>
    <span class="hljs-keyword">return</span> <span class="hljs-regexp">/\.\d+\.?.*$/</span>.test(path)
      ? getPositionalPath(<span class="hljs-keyword">this</span>, path)
      : <span class="hljs-literal">undefined</span>;
  }

  <span class="hljs-comment">// some path names conflict with document methods</span>
  <span class="hljs-keyword">if</span> (reserved[path]) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"`"</span> + path + <span class="hljs-string">"` may not be used as a schema pathname"</span>);
  }

  <span class="hljs-comment">// update the tree</span>
  <span class="hljs-keyword">var</span> subpaths = path.split(<span class="hljs-regexp">/\./</span>)
    , last = subpaths.pop()
    , branch = <span class="hljs-keyword">this</span>.tree;

  subpaths.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(sub, i)</span> </span>{
    <span class="hljs-keyword">if</span> (!branch[sub]) branch[sub] = {};
    <span class="hljs-keyword">if</span> (<span class="hljs-string">'object'</span> != <span class="hljs-keyword">typeof</span> branch[sub]) {
      <span class="hljs-keyword">var</span> msg = <span class="hljs-string">'Cannot set nested path `'</span> + path + <span class="hljs-string">'`. '</span>
              + <span class="hljs-string">'Parent path `'</span>
              + subpaths.slice(<span class="hljs-number">0</span>, i).concat([sub]).join(<span class="hljs-string">'.'</span>)
              + <span class="hljs-string">'` already set to type '</span> + branch[sub].name
              + <span class="hljs-string">'.'</span>;
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(msg);
    }
    branch = branch[sub];
  });

  branch[last] = utils.clone(obj);

  <span class="hljs-keyword">this</span>.paths[path] = Schema.interpretAsType(path, obj);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</code></pre></div><hr></div><div class="item method public"><h3 id="schema_Schema-pathType"><a href="#schema_Schema-pathType">Schema#pathType(<code>path</code>)</a></h3><p>Returns the pathType of <code>path</code> for this schema.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="description"><p>Given a path, returns whether it is a real, virtual, nested, or ad-hoc/undefined path.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.pathType = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(path)</span> </span>{
  <span class="hljs-keyword">if</span> (path <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.paths) <span class="hljs-keyword">return</span> <span class="hljs-string">'real'</span>;
  <span class="hljs-keyword">if</span> (path <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.virtuals) <span class="hljs-keyword">return</span> <span class="hljs-string">'virtual'</span>;
  <span class="hljs-keyword">if</span> (path <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.nested) <span class="hljs-keyword">return</span> <span class="hljs-string">'nested'</span>;
  <span class="hljs-keyword">if</span> (path <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.subpaths) <span class="hljs-keyword">return</span> <span class="hljs-string">'real'</span>;

  <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/\.\d+\.|\.\d+$/</span>.test(path) &amp;&amp; getPositionalPath(<span class="hljs-keyword">this</span>, path)) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'real'</span>;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'adhocOrUndefined'</span>
  }
};</code></pre></div><hr></div><div class="item method public"><h3 id="schema_Schema-plugin"><a href="#schema_Schema-plugin">Schema#plugin(<code>plugin</code>, <code>opts</code>)</a></h3><p>Registers a plugin for this schema.</p><div class="params"><h4>Parameters:</h4><ul><li><code>plugin</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>callback</span></li><li><code>opts</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="plugins" title="plugins">plugins</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.plugin = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn, opts)</span> </span>{
  fn(<span class="hljs-keyword">this</span>, opts);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</code></pre></div><hr></div><div class="item method public"><h3 id="schema_Schema-post"><a href="#schema_Schema-post">Schema#post(<code>method</code>, <code>fn</code>)</a></h3><p>Defines a post for the document</p><div class="params"><h4>Parameters:</h4><ul><li><code>method</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>name of the method to hook</span></li><li><code>fn</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>callback</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="https://github.com/bnoguchi/hooks-js/tree/31ec571cef0332e21121ee7157e0cf9728572cc3" title="hooks.js">hooks.js</a></li></ul></div><div class="description"><p>Post hooks fire <code>on</code> the event emitted from document instances of Models compiled from this schema.</p><pre><code><span class="hljs-keyword">var</span> schema = <span class="hljs-keyword">new</span> Schema(..);
schema.post(&amp;#<span class="hljs-number">39</span>;save&amp;#<span class="hljs-number">39</span>;, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{
  <span class="hljs-built_in">console</span>.log(&amp;#<span class="hljs-number">39</span>;<span class="hljs-keyword">this</span> fired after a <span class="hljs-built_in">document</span> was saved&amp;#<span class="hljs-number">39</span>;);
});

<span class="hljs-keyword">var</span> Model = mongoose.model(&amp;#<span class="hljs-number">39</span>;Model&amp;#<span class="hljs-number">39</span>;, schema);

<span class="hljs-keyword">var</span> m = <span class="hljs-keyword">new</span> Model(..);
m.save(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
  <span class="hljs-built_in">console</span>.log(&amp;#<span class="hljs-number">39</span>;<span class="hljs-keyword">this</span> fires after the `post` hook&amp;#<span class="hljs-number">39</span>;);
});</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.post = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(method, fn)</span></span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.queue(<span class="hljs-string">'on'</span>, <span class="hljs-built_in">arguments</span>);
};</code></pre></div><hr></div><div class="item method public"><h3 id="schema_Schema-pre"><a href="#schema_Schema-pre">Schema#pre(<code>method</code>, <code>callback</code>)</a></h3><p>Defines a pre hook for the document.</p><div class="params"><h4>Parameters:</h4><ul><li><code>method</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>callback</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="https://github.com/bnoguchi/hooks-js/tree/31ec571cef0332e21121ee7157e0cf9728572cc3" title="hooks.js">hooks.js</a></li></ul></div><div class="description"><h4>Example</h4>
<pre><code><span class="hljs-keyword">var</span> toySchema = <span class="hljs-keyword">new</span> Schema(..);

toySchema.pre(&amp;#<span class="hljs-number">39</span>;save&amp;#<span class="hljs-number">39</span>;, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(next)</span> </span>{
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.created) <span class="hljs-keyword">this</span>.created = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>;
  next();
})

toySchema.pre(&amp;#<span class="hljs-number">39</span>;validate&amp;#<span class="hljs-number">39</span>;, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(next)</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.name != &amp;#<span class="hljs-number">39</span>;Woody&amp;#<span class="hljs-number">39</span>;) <span class="hljs-keyword">this</span>.name = &amp;#<span class="hljs-number">39</span>;Woody&amp;#<span class="hljs-number">39</span>;;
  next();
})</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.pre = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.queue(<span class="hljs-string">'pre'</span>, <span class="hljs-built_in">arguments</span>);
};</code></pre></div><hr></div><div class="item method private"><h3 id="schema_Schema-queue"><a href="#schema_Schema-queue">Schema#queue(<code>name</code>, <code>args</code>)</a></h3><p>Adds a method call to the queue.</p><div class="params"><h4>Parameters:</h4><ul><li><code>name</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>name of the document method to call later</span></li><li><code>args</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span>arguments to pass to the method</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.queue = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, args)</span></span>{
  <span class="hljs-keyword">this</span>.callQueue.push([name, args]);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="schema_Schema-requiredPaths"><a href="#schema_Schema-requiredPaths">Schema#requiredPaths()</a></h3><p>Returns an Array of path strings that are required by this schema.</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.requiredPaths = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">requiredPaths</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._requiredpaths) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._requiredpaths;

  <span class="hljs-keyword">var</span> paths = <span class="hljs-built_in">Object</span>.keys(<span class="hljs-keyword">this</span>.paths)
    , i = paths.length
    , ret = [];

  <span class="hljs-keyword">while</span> (i--) {
    <span class="hljs-keyword">var</span> path = paths[i];
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.paths[path].isRequired) ret.push(path);
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._requiredpaths = ret;
};</code></pre></div><hr></div><div class="item method public"><h3 id="schema_Schema-set"><a href="#schema_Schema-set">Schema#set(<code>key</code>, <code>[value]</code>)</a></h3><p>Sets/gets a schema option.</p><div class="params"><h4>Parameters:</h4><ul><li><code>key</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>option name</span></li><li><code>[value]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>if not passed, the current option value is returned</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.set = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key, value)</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-number">1</span> === <span class="hljs-built_in">arguments</span>.length) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.options[key];
  }

  <span class="hljs-keyword">this</span>.options[key] = value;

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</code></pre></div><hr></div><div class="item method public"><h3 id="schema_Schema-static"><a href="#schema_Schema-static">Schema#static(<code>name</code>, <code>fn</code>)</a></h3><p>Adds static &quot;class&quot; methods to Models compiled from this schema.</p><div class="params"><h4>Parameters:</h4><ul><li><code>name</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>fn</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="description"><h4>Example</h4>
<pre><code><span class="hljs-keyword">var</span> schema = <span class="hljs-keyword">new</span> Schema(..);
schema.static(&amp;#<span class="hljs-number">39</span>;findByName&amp;#<span class="hljs-number">39</span>;, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(name, callback)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.find({ name: name }, callback);
});

<span class="hljs-keyword">var</span> Drink = mongoose.model(&amp;#<span class="hljs-number">39</span>;Drink&amp;#<span class="hljs-number">39</span>;, schema);
Drink.findByName(&amp;#<span class="hljs-number">39</span>;sanpellegrino&amp;#<span class="hljs-number">39</span>;, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, drinks)</span> </span>{
  <span class="hljs-comment">//</span>
});</code></pre><p>If a hash of name/fn pairs is passed as the only argument, each name/fn pair will be added as statics.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.static = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, fn)</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-string">'string'</span> != <span class="hljs-keyword">typeof</span> name)
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i <span class="hljs-keyword">in</span> name)
      <span class="hljs-keyword">this</span>.statics[i] = name[i];
  <span class="hljs-keyword">else</span>
    <span class="hljs-keyword">this</span>.statics[name] = fn;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</code></pre></div><hr></div><div class="item method public"><h3 id="schema_Schema-virtual"><a href="#schema_Schema-virtual">Schema#virtual(<code>name</code>, <code>[options]</code>)</a></h3><p>Creates a virtual type with the given name.</p><div class="params"><h4>Parameters:</h4><ul><li><code>name</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#virtualtype_VirtualType">VirtualType</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.virtual = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(name, options)</span> </span>{
  <span class="hljs-keyword">var</span> virtuals = <span class="hljs-keyword">this</span>.virtuals;
  <span class="hljs-keyword">var</span> parts = name.split(<span class="hljs-string">'.'</span>);
  <span class="hljs-keyword">return</span> virtuals[name] = parts.reduce(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(mem, part, i)</span> </span>{
    mem[part] || (mem[part] = (i === parts.length-<span class="hljs-number">1</span>)
                            ? <span class="hljs-keyword">new</span> VirtualType(options, name)
                            : {});
    <span class="hljs-keyword">return</span> mem[part];
  }, <span class="hljs-keyword">this</span>.tree);
};</code></pre></div><hr></div><div class="item method public"><h3 id="schema_Schema-virtualpath"><a href="#schema_Schema-virtualpath">Schema#virtualpath(<code>name</code>)</a></h3><p>Returns the virtual type with the given <code>name</code>.</p><div class="params"><h4>Parameters:</h4><ul><li><code>name</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#virtualtype_VirtualType">VirtualType</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.virtualpath = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(name)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.virtuals[name];
};</code></pre></div><hr></div><div class="item static public"><h3 id="schema_Schema.Types"><a href="#schema_Schema.Types">Schema.Types</a></h3><p>The various built-in Storage Schema Types.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.Types = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./schema/index'</span>);

<span class="hljs-comment">// Хранилище схем</span>
Schema.schemas = schemas = {};</code></pre></div><h4>Example:</h4>
<pre><code><span class="hljs-keyword">var</span> mongoose = <span class="hljs-built_in">require</span>(&amp;#<span class="hljs-number">39</span>;mongoose&amp;#<span class="hljs-number">39</span>;);
<span class="hljs-keyword">var</span> ObjectId = mongoose.Schema.Types.ObjectId;</code></pre><h4>Types:</h4>
<ul>
<li><a href="#schema-string-js">String</a></li>
<li><a href="#schema-number-js">Number</a></li>
<li><a href="#schema-boolean-js">Boolean</a> | Bool</li>
<li><a href="#schema-array-js">Array</a></li>
<li><a href="#schema-date-js">Date</a></li>
<li><a href="#schema-objectid-js">ObjectId</a> | Oid</li>
<li><a href="#schema-mixed-js">Mixed</a> | Object</li>
</ul>
<p>Using this exposed access to the <code>Mixed</code> SchemaType, we can use them in our schema.</p><pre><code><span class="hljs-keyword">var</span> Mixed = mongoose.Schema.Types.Mixed;
<span class="hljs-keyword">new</span> mongoose.Schema({ _user: Mixed })</code></pre><hr></div><div class="item static private"><h3 id="schema_Schema.interpretAsType"><a href="#schema_Schema.interpretAsType">Schema.interpretAsType(<code>path</code>, <code>obj</code>)</a></h3><p>Converts type arguments into Schema Types.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.interpretAsType = function (path, obj) {
  var constructorName = utils.getFunctionName(obj.constructor);
  if (constructorName != 'Object'){
    obj = { type: obj };
  }

  // Get the type making sure to allow keys named "type"
  // and default to mixed if not specified.
  // { type: { type: String, default: 'freshcut' } }
  var type = obj.type &amp;&amp; !obj.type.type
    ? obj.type
    : {};

  if ('Object' == utils.getFunctionName(type.constructor) || 'mixed' == type) {
    return new Types.Mixed(path, obj);
  }

  if (Array.isArray(type) || Array == type || 'array' == type) {
    // if it was specified through { type } look for `cast`
    var cast = (Array == type || 'array' == type)
      ? obj.cast
      : type[0];

    if (cast instanceof Schema) {
      return new Types.DocumentArray(path, cast, obj);
    }

    if ('string' == typeof cast) {
      cast = Types[cast.charAt(0).toUpperCase() + cast.substring(1)];
    } else if (cast &amp;&amp; (!cast.type || cast.type.type)
                    &amp;&amp; 'Object' == utils.getFunctionName(cast.constructor)
                    &amp;&amp; Object.keys(cast).length) {
      return new Types.DocumentArray(path, new Schema(cast), obj);
    }

    return new Types.Array(path, cast || Types.Mixed, obj);
  }

  var name = 'string' == typeof type
    ? type
    // If not string, `type` is a function. Outside of IE, function.name
    // gives you the function name. In IE, you need to compute it
    : utils.getFunctionName(type);

  if (name) {
    name = name.charAt(0).toUpperCase() + name.substring(1);
  }

  if (undefined == Types[name]) {
    throw new TypeError('Undefined type at `' + path +
        '`
  Did you try nesting Schemas? ' +
        'You can only nest using refs or arrays.');
  }

  return new Types[name](path, obj);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>obj</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>constructor</span></li></ul></div><hr class="private"></div><div class="item static public"><h3 id="schema_Schema.reserved"><a href="#schema_Schema.reserved">Schema.reserved</a></h3><p>Reserved document keys.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.reserved = <span class="hljs-built_in">Object</span>.create( <span class="hljs-literal">null</span> );
<span class="hljs-keyword">var</span> reserved = Schema.reserved;
reserved.on =
reserved.db =
reserved.get =
reserved.set =
reserved.init =
reserved.isNew =
reserved.errors =
reserved.schema =
reserved.options =
reserved.modelName =
reserved.collection =
reserved.toObject =
reserved.domain =
reserved.emit =    <span class="hljs-comment">// EventEmitter</span>
reserved._events = <span class="hljs-comment">// EventEmitter</span>
reserved._pres = reserved._posts = <span class="hljs-number">1</span>; <span class="hljs-comment">// hooks.js</span></code></pre></div><p>Keys in this object are names that are rejected in schema declarations b/c they conflict with mongoose functionality. Using these key name will throw an error.</p><pre><code>on, emit, _events, db, get, set, init, isNew, errors, schema, options, modelName, collection, _pres, _posts, toObject</code></pre><p><em>NOTE:</em> Use of these terms as method names is permitted, but play at your own risk, as they may be existing mongoose document methods you are stomping on.</p><pre><code><span class="hljs-keyword">var</span> schema = <span class="hljs-keyword">new</span> Schema(..);
 schema.methods.init = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{} <span class="hljs-comment">// potentially breaking</span></code></pre><hr></div><div class="item property public"><h3 id="schema_Schema-discriminators"><a href="#schema_Schema-discriminators">Schema#<span>discriminators</span></a></h3><p>Registered discriminators for this schema.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.discriminators;</code></pre></div><hr></div><div class="item property private"><h3 id="schema_Schema-paths"><a href="#schema_Schema-paths">Schema#<span>paths</span></a></h3><p>Schema as flat paths</p><h4>Example:</h4>
<pre><code>{
    &amp;#<span class="hljs-number">39</span>;_id&amp;#<span class="hljs-number">39</span>;        : SchemaType,
  , &amp;#<span class="hljs-number">39</span>;nested.key&amp;#<span class="hljs-number">39</span>; : SchemaType,
}</code></pre><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.paths;</code></pre></div><hr class="private"></div><div class="item property private"><h3 id="schema_Schema-tree"><a href="#schema_Schema-tree">Schema#<span>tree</span></a></h3><p>Schema as a tree</p><h4>Example:</h4>
<pre><code>{
    &amp;#<span class="hljs-number">39</span>;_id&amp;#<span class="hljs-number">39</span>;     : ObjectId
  , &amp;#<span class="hljs-number">39</span>;nested&amp;#<span class="hljs-number">39</span>;  : {
        &amp;#<span class="hljs-number">39</span>;key&amp;#<span class="hljs-number">39</span>; : <span class="hljs-built_in">String</span>
    }
}</code></pre><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.tree;</code></pre></div><hr class="private"></div></li><li class="module"><a href="https://github.com/archangel-irk/storage/blob/0.0.1/lib/schematype.js" id="schematype-js">schematype.js</a><div class="item method public"><h3 id="schematype_SchemaType"><a href="#schematype_SchemaType">SchemaType(<code>path</code>, <code>[options]</code>, <code>[instance]</code>)</a></h3><p>SchemaType constructor</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[instance]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SchemaType</span> <span class="hljs-params">(path, options, instance)</span> </span>{
  <span class="hljs-keyword">this</span>.path = path;
  <span class="hljs-keyword">this</span>.instance = instance;
  <span class="hljs-keyword">this</span>.validators = [];
  <span class="hljs-keyword">this</span>.setters = [];
  <span class="hljs-keyword">this</span>.getters = [];
  <span class="hljs-keyword">this</span>.options = options;

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i <span class="hljs-keyword">in</span> options) <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>[i] &amp;&amp; <span class="hljs-string">'function'</span> == <span class="hljs-keyword">typeof</span> <span class="hljs-keyword">this</span>[i]) {
    <span class="hljs-keyword">var</span> opts = <span class="hljs-built_in">Array</span>.isArray(options[i])
      ? options[i]
      : [options[i]];

    <span class="hljs-keyword">this</span>[i].apply(<span class="hljs-keyword">this</span>, opts);
  }
}</code></pre></div><hr></div><div class="item method public"><h3 id="schematype_SchemaType-default"><a href="#schematype_SchemaType-default">SchemaType#default(<code>val</code>)</a></h3><p>Sets a default value for this SchemaType.</p><div class="params"><h4>Parameters:</h4><ul><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>, T&gt; </span><span>the default value</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#defaultValue">defaultValue</a>&gt; </span><span></span></li></ul></div><div class="description"><h4>Example:</h4>
<pre><code><span class="hljs-keyword">var</span> schema = <span class="hljs-keyword">new</span> Schema({ n: { type: <span class="hljs-built_in">Number</span>, <span class="hljs-keyword">default</span>: <span class="hljs-number">10</span> })
<span class="hljs-keyword">var</span> M = db.model(&amp;#<span class="hljs-number">39</span>;M&amp;#<span class="hljs-number">39</span>;, schema)
<span class="hljs-keyword">var</span> m = <span class="hljs-keyword">new</span> M;
<span class="hljs-built_in">console</span>.log(m.n) <span class="hljs-comment">// 10</span></code></pre><p>Defaults can be either <code>functions</code> which return the value to use as the default or the literal value itself. Either way, the value will be cast based on its schema type before being set during document creation.</p><h4>Example:</h4>
<pre><code><span class="hljs-comment">// values are cast:</span>
<span class="hljs-keyword">var</span> schema = <span class="hljs-keyword">new</span> Schema({ aNumber: <span class="hljs-built_in">Number</span>, <span class="hljs-keyword">default</span>: &amp;quot;<span class="hljs-number">4.815162342</span>&amp;quot; })
<span class="hljs-keyword">var</span> M = db.model(&amp;#<span class="hljs-number">39</span>;M&amp;#<span class="hljs-number">39</span>;, schema)
<span class="hljs-keyword">var</span> m = <span class="hljs-keyword">new</span> M;
<span class="hljs-built_in">console</span>.log(m.aNumber) <span class="hljs-comment">// 4.815162342</span>

<span class="hljs-comment">// default unique objects for Mixed types:</span>
<span class="hljs-keyword">var</span> schema = <span class="hljs-keyword">new</span> Schema({ mixed: Schema.Types.Mixed });
schema.path(&amp;#<span class="hljs-number">39</span>;mixed&amp;#<span class="hljs-number">39</span>;).default(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">return</span> {};
});

<span class="hljs-comment">// if we don&amp;#39;t use a function to return object literals for Mixed defaults,</span>
<span class="hljs-comment">// each document will receive a reference to the same object literal creating</span>
<span class="hljs-comment">// a &amp;quot;shared&amp;quot; object instance:</span>
<span class="hljs-keyword">var</span> schema = <span class="hljs-keyword">new</span> Schema({ mixed: Schema.Types.Mixed });
schema.path(&amp;#<span class="hljs-number">39</span>;mixed&amp;#<span class="hljs-number">39</span>;).default({});
<span class="hljs-keyword">var</span> M = db.model(&amp;#<span class="hljs-number">39</span>;M&amp;#<span class="hljs-number">39</span>;, schema);
<span class="hljs-keyword">var</span> m1 = <span class="hljs-keyword">new</span> M;
m1.mixed.added = <span class="hljs-number">1</span>;
<span class="hljs-built_in">console</span>.log(m1.mixed); <span class="hljs-comment">// { added: 1 }</span>
<span class="hljs-keyword">var</span> m2 = <span class="hljs-keyword">new</span> M;
<span class="hljs-built_in">console</span>.log(m2.mixed); <span class="hljs-comment">// { added: 1 }</span></code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaType.prototype.default = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(val)</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-number">1</span> === <span class="hljs-built_in">arguments</span>.length) {
    <span class="hljs-keyword">this</span>.defaultValue = <span class="hljs-keyword">typeof</span> val === <span class="hljs-string">'function'</span>
      ? val
      : <span class="hljs-keyword">this</span>.cast( val );

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;

  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( <span class="hljs-built_in">arguments</span>.length &gt; <span class="hljs-number">1</span> ) {
    <span class="hljs-keyword">this</span>.defaultValue = _.toArray( <span class="hljs-built_in">arguments</span> );
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.defaultValue;
};</code></pre></div><hr></div><div class="item method public"><h3 id="schematype_SchemaType-get"><a href="#schematype_SchemaType-get">SchemaType#get(<code>fn</code>)</a></h3><p>Adds a getter to this schematype.</p><div class="params"><h4>Parameters:</h4><ul><li><code>fn</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#schematype_SchemaType">SchemaType</a>&gt; </span><span>this</span></li></ul></div><div class="description"><h4>Example:</h4>
<pre><code><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dob</span> <span class="hljs-params">(val)</span> </span>{
  <span class="hljs-keyword">if</span> (!val) <span class="hljs-keyword">return</span> val;
  <span class="hljs-keyword">return</span> (val.getMonth() + <span class="hljs-number">1</span>) + &amp;quot;<span class="hljs-regexp">/&amp;quot; + val.getDate() + &amp;quot;/</span>&amp;quot; + val.getFullYear();
}

<span class="hljs-comment">// defining within the schema</span>
<span class="hljs-keyword">var</span> s = <span class="hljs-keyword">new</span> Schema({ born: { type: <span class="hljs-built_in">Date</span>, get: dob })

<span class="hljs-comment">// or by retreiving its SchemaType</span>
<span class="hljs-keyword">var</span> s = <span class="hljs-keyword">new</span> Schema({ born: <span class="hljs-built_in">Date</span> })
s.path(&amp;#<span class="hljs-number">39</span>;born&amp;#<span class="hljs-number">39</span>;).get(dob)</code></pre><p>Getters allow you to transform the representation of the data as it travels from the raw mongodb document to the value that you see.</p><p>Suppose you are storing credit card numbers and you want to hide everything except the last 4 digits to the mongoose user. You can do so by defining a getter in the following way:</p><pre><code><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">obfuscate</span> <span class="hljs-params">(cc)</span> </span>{
  <span class="hljs-keyword">return</span> &amp;#<span class="hljs-number">39</span>;****-****-****-&amp;#<span class="hljs-number">39</span>; + cc.slice(cc.length-<span class="hljs-number">4</span>, cc.length);
}

<span class="hljs-keyword">var</span> AccountSchema = <span class="hljs-keyword">new</span> Schema({
  creditCardNumber: { type: <span class="hljs-built_in">String</span>, get: obfuscate }
});

<span class="hljs-keyword">var</span> Account = db.model(&amp;#<span class="hljs-number">39</span>;Account&amp;#<span class="hljs-number">39</span>;, AccountSchema);

Account.findById(id, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, found)</span> </span>{
  <span class="hljs-built_in">console</span>.log(found.creditCardNumber); <span class="hljs-comment">// &amp;#39;****-****-****-1234&amp;#39;</span>
});</code></pre><p>Getters are also passed a second argument, the schematype on which the getter was defined. This allows for tailored behavior based on options passed in the schema.</p><pre><code><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">inspector</span> <span class="hljs-params">(val, schematype)</span> </span>{
  <span class="hljs-keyword">if</span> (schematype.options.required) {
    <span class="hljs-keyword">return</span> schematype.path + &amp;#<span class="hljs-number">39</span>; is required&amp;#<span class="hljs-number">39</span>;;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> schematype.path + &amp;#<span class="hljs-number">39</span>; is not&amp;#<span class="hljs-number">39</span>;;
  }
}

<span class="hljs-keyword">var</span> VirusSchema = <span class="hljs-keyword">new</span> Schema({
  name: { type: <span class="hljs-built_in">String</span>, required: <span class="hljs-literal">true</span>, get: inspector },
  taxonomy: { type: <span class="hljs-built_in">String</span>, get: inspector }
})

<span class="hljs-keyword">var</span> Virus = db.model(&amp;#<span class="hljs-number">39</span>;Virus&amp;#<span class="hljs-number">39</span>;, VirusSchema);

Virus.findById(id, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, virus)</span> </span>{
  <span class="hljs-built_in">console</span>.log(virus.name);     <span class="hljs-comment">// name is required</span>
  <span class="hljs-built_in">console</span>.log(virus.taxonomy); <span class="hljs-comment">// taxonomy is not</span>
})</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaType.prototype.get = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn)</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-string">'function'</span> != <span class="hljs-keyword">typeof</span> fn)
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">TypeError</span>(<span class="hljs-string">'A getter must be a function.'</span>);
  <span class="hljs-keyword">this</span>.getters.push(fn);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</code></pre></div><hr></div><div class="item method public"><h3 id="schematype_SchemaType-set"><a href="#schematype_SchemaType-set">SchemaType#set(<code>fn</code>)</a></h3><p>Adds a setter to this schematype.</p><div class="params"><h4>Parameters:</h4><ul><li><code>fn</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#schematype_SchemaType">SchemaType</a>&gt; </span><span>this</span></li></ul></div><div class="description"><h4>Example:</h4>
<pre><code><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">capitalize</span> <span class="hljs-params">(val)</span> </span>{
  <span class="hljs-keyword">if</span> (&amp;#<span class="hljs-number">39</span>;string&amp;#<span class="hljs-number">39</span>; != <span class="hljs-keyword">typeof</span> val) val = &amp;#<span class="hljs-number">39</span>;&amp;#<span class="hljs-number">39</span>;;
  <span class="hljs-keyword">return</span> val.charAt(<span class="hljs-number">0</span>).toUpperCase() + val.substring(<span class="hljs-number">1</span>);
}

<span class="hljs-comment">// defining within the schema</span>
<span class="hljs-keyword">var</span> s = <span class="hljs-keyword">new</span> Schema({ name: { type: <span class="hljs-built_in">String</span>, set: capitalize }})

<span class="hljs-comment">// or by retreiving its SchemaType</span>
<span class="hljs-keyword">var</span> s = <span class="hljs-keyword">new</span> Schema({ name: <span class="hljs-built_in">String</span> })
s.path(&amp;#<span class="hljs-number">39</span>;name&amp;#<span class="hljs-number">39</span>;).set(capitalize)</code></pre><p>Setters allow you to transform the data before it gets to the raw mongodb document and is set as a value on an actual key.</p><p>Suppose you are implementing user registration for a website. Users provide an email and password, which gets saved to mongodb. The email is a string that you will want to normalize to lower case, in order to avoid one email having more than one account -- e.g., otherwise, avenue@q.com can be registered for 2 accounts via avenue@q.com and AvEnUe@Q.CoM.</p><p>You can set up email lower case normalization easily via a Storage setter.</p><pre><code><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toLower</span> <span class="hljs-params">(v)</span> </span>{
  <span class="hljs-keyword">return</span> v.toLowerCase();
}

<span class="hljs-keyword">var</span> UserSchema = <span class="hljs-keyword">new</span> Schema({
  email: { type: <span class="hljs-built_in">String</span>, set: toLower }
})

<span class="hljs-keyword">var</span> User = db.model(&amp;#<span class="hljs-number">39</span>;User&amp;#<span class="hljs-number">39</span>;, UserSchema)

<span class="hljs-keyword">var</span> user = <span class="hljs-keyword">new</span> User({email: &amp;#<span class="hljs-number">39</span>;AVENUE@Q.COM&amp;#<span class="hljs-number">39</span>;})
<span class="hljs-built_in">console</span>.log(user.email); <span class="hljs-comment">// &amp;#39;avenue@q.com&amp;#39;</span>

<span class="hljs-comment">// or</span>
<span class="hljs-keyword">var</span> user = <span class="hljs-keyword">new</span> User
user.email = &amp;#<span class="hljs-number">39</span>;Avenue@Q.com&amp;#<span class="hljs-number">39</span>;
<span class="hljs-built_in">console</span>.log(user.email) <span class="hljs-comment">// &amp;#39;avenue@q.com&amp;#39;</span></code></pre><p>As you can see above, setters allow you to transform the data before it gets to the raw mongodb document and is set as a value on an actual key.</p><p><em>NOTE: we could have also just used the built-in <code>lowercase: true</code> SchemaType option instead of defining our own function.</em></p><pre><code><span class="hljs-keyword">new</span> Schema({ email: { type: <span class="hljs-built_in">String</span>, lowercase: <span class="hljs-literal">true</span> }})</code></pre><p>Setters are also passed a second argument, the schematype on which the setter was defined. This allows for tailored behavior based on options passed in the schema.</p><pre><code><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">inspector</span> <span class="hljs-params">(val, schematype)</span> </span>{
  <span class="hljs-keyword">if</span> (schematype.options.required) {
    <span class="hljs-keyword">return</span> schematype.path + &amp;#<span class="hljs-number">39</span>; is required&amp;#<span class="hljs-number">39</span>;;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> val;
  }
}

<span class="hljs-keyword">var</span> VirusSchema = <span class="hljs-keyword">new</span> Schema({
  name: { type: <span class="hljs-built_in">String</span>, required: <span class="hljs-literal">true</span>, set: inspector },
  taxonomy: { type: <span class="hljs-built_in">String</span>, set: inspector }
})

<span class="hljs-keyword">var</span> Virus = db.model(&amp;#<span class="hljs-number">39</span>;Virus&amp;#<span class="hljs-number">39</span>;, VirusSchema);
<span class="hljs-keyword">var</span> v = <span class="hljs-keyword">new</span> Virus({ name: &amp;#<span class="hljs-number">39</span>;Parvoviridae&amp;#<span class="hljs-number">39</span>;, taxonomy: &amp;#<span class="hljs-number">39</span>;Parvovirinae&amp;#<span class="hljs-number">39</span>; });

<span class="hljs-built_in">console</span>.log(v.name);     <span class="hljs-comment">// name is required</span>
<span class="hljs-built_in">console</span>.log(v.taxonomy); <span class="hljs-comment">// Parvovirinae</span></code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaType.prototype.set = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn)</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-string">'function'</span> != <span class="hljs-keyword">typeof</span> fn)
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">TypeError</span>(<span class="hljs-string">'A setter must be a function.'</span>);
  <span class="hljs-keyword">this</span>.setters.push(fn);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</code></pre></div><hr></div><div class="item method public"><h3 id="schematype_SchemaType-validate"><a href="#schematype_SchemaType-validate">SchemaType#validate(<code>obj</code>, <code>[message]</code>)</a></h3><p>Adds validator(s) for this document path.</p><div class="params"><h4>Parameters:</h4><ul><li><code>obj</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/RegExp">RegExp</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>validator</span></li><li><code>[message]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>optional error message</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#schematype_SchemaType">SchemaType</a>&gt; </span><span>this</span></li></ul></div><div class="description"><p>Validators always receive the value to validate as their first argument and must return <code>Boolean</code>. Returning <code>false</code> means validation failed.</p><p>The error message argument is optional. If not passed, the <a href="#error_messages_StorageError-messages">default generic error message template</a> will be used.</p><h4>Examples:</h4>
<pre><code><span class="hljs-comment">// make sure every value is equal to &amp;quot;something&amp;quot;</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">validator</span> <span class="hljs-params">(val)</span> </span>{
  <span class="hljs-keyword">return</span> val == &amp;#<span class="hljs-number">39</span>;something&amp;#<span class="hljs-number">39</span>;;
}
<span class="hljs-keyword">new</span> Schema({ name: { type: <span class="hljs-built_in">String</span>, validate: validator }});

<span class="hljs-comment">// with a custom error message</span>

<span class="hljs-keyword">var</span> custom = [validator, &amp;#<span class="hljs-number">39</span>;Uh oh, {PATH} does not equal &amp;quot;something&amp;quot;.&amp;#<span class="hljs-number">39</span>;]
<span class="hljs-keyword">new</span> Schema({ name: { type: <span class="hljs-built_in">String</span>, validate: custom }});

<span class="hljs-comment">// adding many validators at a time</span>

<span class="hljs-keyword">var</span> many = [
    { validator: validator, msg: &amp;#<span class="hljs-number">39</span>;uh oh&amp;#<span class="hljs-number">39</span>; }
  , { validator: anotherValidator, msg: &amp;#<span class="hljs-number">39</span>;failed&amp;#<span class="hljs-number">39</span>; }
]
<span class="hljs-keyword">new</span> Schema({ name: { type: <span class="hljs-built_in">String</span>, validate: many }});

<span class="hljs-comment">// or utilizing SchemaType methods directly:</span>

<span class="hljs-keyword">var</span> schema = <span class="hljs-keyword">new</span> Schema({ name: &amp;#<span class="hljs-number">39</span>;string&amp;#<span class="hljs-number">39</span>; });
schema.path(&amp;#<span class="hljs-number">39</span>;name&amp;#<span class="hljs-number">39</span>;).validate(validator, &amp;#<span class="hljs-number">39</span>;validation of `{PATH}` failed <span class="hljs-keyword">with</span> value `{VALUE}`&amp;#<span class="hljs-number">39</span>;);</code></pre><h4>Error message templates:</h4>
<p>From the examples above, you may have noticed that error messages support baseic templating. There are a few other template keywords besides <code>{PATH}</code> and <code>{VALUE}</code> too. To find out more, details are available <a href="#error_messages_StorageError-messages">here</a></p><h4>Asynchronous validation:</h4>
<p>Passing a validator function that receives two arguments tells mongoose that the validator is an asynchronous validator. The first argument passed to the validator function is the value being validated. The second argument is a callback function that must called when you finish validating the value and passed either <code>true</code> or <code>false</code> to communicate either success or failure respectively.</p><pre><code>schema.path(&amp;#<span class="hljs-number">39</span>;name&amp;#<span class="hljs-number">39</span>;).validate(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value, respond)</span> </span>{
  doStuff(value, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    ...
    respond(<span class="hljs-literal">false</span>); <span class="hljs-comment">// validation failed</span>
  })
 }, &amp;#<span class="hljs-number">39</span>;{PATH} failed validation.&amp;#<span class="hljs-number">39</span>;);</code></pre><p>You might use asynchronous validators to retreive other documents from the database to validate against or to meet other I/O bound validation needs.</p><p>Validation occurs <code>pre(&#39;save&#39;)</code> or whenever you manually execute <a href="#document_Document-validate">document#validate</a>.</p><p>If validation fails during <code>pre(&#39;save&#39;)</code> and no callback was passed to receive the error, an <code>error</code> event will be emitted on your Models associated db <a href="#connection_Connection">connection</a>, passing the validation error object along.</p><pre><code><span class="hljs-keyword">var</span> conn = mongoose.createConnection(..);
conn.on(&amp;#<span class="hljs-number">39</span>;error&amp;#<span class="hljs-number">39</span>;, handleError);

<span class="hljs-keyword">var</span> Product = conn.model(&amp;#<span class="hljs-number">39</span>;Product&amp;#<span class="hljs-number">39</span>;, yourSchema);
<span class="hljs-keyword">var</span> dvd = <span class="hljs-keyword">new</span> Product(..);
dvd.save(); <span class="hljs-comment">// emits error on the `conn` above</span></code></pre><p>If you desire handling these errors at the Model level, attach an <code>error</code> listener to your Model and the event will instead be emitted there.</p><pre><code><span class="hljs-comment">// registering an error listener on the Model lets us handle errors more locally</span>
Product.on(&amp;#<span class="hljs-number">39</span>;error&amp;#<span class="hljs-number">39</span>;, handleError);</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaType.prototype.validate = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj, message, type)</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-string">'function'</span> == <span class="hljs-keyword">typeof</span> obj || obj &amp;&amp; <span class="hljs-string">'RegExp'</span> === utils.getFunctionName( obj.constructor )) {
    <span class="hljs-keyword">if</span> (!message) message = errorMessages.general.default;
    <span class="hljs-keyword">if</span> (!type) type = <span class="hljs-string">'user defined'</span>;
    <span class="hljs-keyword">this</span>.validators.push([obj, message, type]);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  }

  <span class="hljs-keyword">var</span> i = <span class="hljs-built_in">arguments</span>.length
    , arg;

  <span class="hljs-keyword">while</span> (i--) {
    arg = <span class="hljs-built_in">arguments</span>[i];
    <span class="hljs-keyword">if</span> (!(arg &amp;&amp; <span class="hljs-string">'Object'</span> == utils.getFunctionName( arg.constructor ) )) {
      <span class="hljs-keyword">var</span> msg = <span class="hljs-string">'Invalid validator. Received ('</span> + <span class="hljs-keyword">typeof</span> arg + <span class="hljs-string">') '</span>
        + arg
        + <span class="hljs-string">'. See http://mongoosejs.com/docs/api.html#schematype_SchemaType-validate'</span>;

      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(msg);
    }
    <span class="hljs-keyword">this</span>.validate(arg.validator, arg.msg, arg.type);
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

<span class="hljs-comment">/**
 * Adds a required validator to this schematype.
 *
 * ####Example:
 *
 *     var s = new Schema({ born: { type: Date, required: true })
 *
 *     // or with custom error message
 *
 *     var s = new Schema({ born: { type: Date, required: '{PATH} is required!' })
 *
 *     // or through the path API
 *
 *     Schema.path('name').required(true);
 *
 *     // with custom error messaging
 *
 *     Schema.path('name').required(true, 'grrr :( ');
 *
 *
 * @param {Boolean} required enable/disable the validator
 * @param {String} [message] optional custom error message
 * @return {SchemaType} this
 * @see Customized Error Messages #error_messages_StorageError-messages
 * @api public
 */</span>
SchemaType.prototype.required = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(required, message)</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">false</span> === required) {
    <span class="hljs-keyword">this</span>.validators = <span class="hljs-keyword">this</span>.validators.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v)</span> </span>{
      <span class="hljs-keyword">return</span> v[<span class="hljs-number">0</span>] != <span class="hljs-keyword">this</span>.requiredValidator;
    }, <span class="hljs-keyword">this</span>);

    <span class="hljs-keyword">this</span>.isRequired = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  }

  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">this</span>.isRequired = <span class="hljs-literal">true</span>;

  <span class="hljs-keyword">this</span>.requiredValidator = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v)</span> </span>{
    <span class="hljs-comment">// in here, `this` refers to the validating document.</span>
    <span class="hljs-comment">// no validation when this path wasn't selected in the query.</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> !== <span class="hljs-literal">undefined</span> &amp;&amp; <span class="hljs-comment">// специальная проверка из-за strict mode и особенности .call(undefined)</span>
        <span class="hljs-string">'isSelected'</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span> &amp;&amp;
        !<span class="hljs-keyword">this</span>.isSelected(self.path) &amp;&amp;
        !<span class="hljs-keyword">this</span>.isModified(self.path)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;

    <span class="hljs-keyword">return</span> self.checkRequired(v, <span class="hljs-keyword">this</span>);
  };

  <span class="hljs-keyword">if</span> (<span class="hljs-string">'string'</span> == <span class="hljs-keyword">typeof</span> required) {
    message = required;
    required = <span class="hljs-literal">undefined</span>;
  }

  <span class="hljs-keyword">var</span> msg = message || errorMessages.general.required;
  <span class="hljs-keyword">this</span>.validators.push([<span class="hljs-keyword">this</span>.requiredValidator, msg, <span class="hljs-string">'required'</span>]);

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};


<span class="hljs-comment">/**
 * Gets the default value
 *
 * @param {Object} scope the scope which callback are executed
 * @param {Boolean} init
 * @api private
 */</span>
SchemaType.prototype.getDefault = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(scope, init)</span> </span>{
  <span class="hljs-keyword">var</span> ret = <span class="hljs-string">'function'</span> === <span class="hljs-keyword">typeof</span> <span class="hljs-keyword">this</span>.defaultValue
    ? <span class="hljs-keyword">this</span>.defaultValue.call(scope)
    : <span class="hljs-keyword">this</span>.defaultValue;

  <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== ret &amp;&amp; <span class="hljs-literal">undefined</span> !== ret) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.cast(ret, scope, init);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> ret;
  }
};

<span class="hljs-comment">/**
 * Applies setters
 *
 * @param {Object} value
 * @param {Object} scope
 * @param {Boolean} init
 * @api private
 */</span>

SchemaType.prototype.applySetters = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value, scope, init, priorVal)</span> </span>{
  <span class="hljs-keyword">if</span> (SchemaType._isRef( <span class="hljs-keyword">this</span>, value )) {
    <span class="hljs-keyword">return</span> init
      ? value
      : <span class="hljs-keyword">this</span>.cast(value, scope, init, priorVal);
  }

  <span class="hljs-keyword">var</span> v = value
    , setters = <span class="hljs-keyword">this</span>.setters
    , len = setters.length
    , caster = <span class="hljs-keyword">this</span>.caster;

  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(v) &amp;&amp; caster &amp;&amp; caster.setters) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; v.length; i++) {
      v[i] = caster.applySetters(v[i], scope, init, priorVal);
    }
  }

  <span class="hljs-keyword">if</span> (!len) {
    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> === v || <span class="hljs-literal">undefined</span> === v) <span class="hljs-keyword">return</span> v;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.cast(v, scope, init, priorVal);
  }

  <span class="hljs-keyword">while</span> (len--) {
    v = setters[len].call(scope, v, <span class="hljs-keyword">this</span>);
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> === v || <span class="hljs-literal">undefined</span> === v) <span class="hljs-keyword">return</span> v;

  <span class="hljs-comment">// do not cast until all setters are applied #665</span>
  v = <span class="hljs-keyword">this</span>.cast(v, scope, init, priorVal);

  <span class="hljs-keyword">return</span> v;
};

<span class="hljs-comment">/**
 * Applies getters to a value
 *
 * @param {Object} value
 * @param {Object} scope
 * @api private
 */</span>
SchemaType.prototype.applyGetters = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( value, scope )</span></span>{
  <span class="hljs-keyword">if</span> ( SchemaType._isRef( <span class="hljs-keyword">this</span>, value ) ) <span class="hljs-keyword">return</span> value;

  <span class="hljs-keyword">var</span> v = value
    , getters = <span class="hljs-keyword">this</span>.getters
    , len = getters.length;

  <span class="hljs-keyword">if</span> ( !len ) {
    <span class="hljs-keyword">return</span> v;
  }

  <span class="hljs-keyword">while</span> ( len-- ) {
    v = getters[ len ].call(scope, v, <span class="hljs-keyword">this</span>);
  }

  <span class="hljs-keyword">return</span> v;
};

<span class="hljs-comment">/**
 * Performs a validation of `value` using the validators declared for this SchemaType.
 *
 * @param {*} value
 * @param {Function} callback
 * @param {Object} scope
 * @api private
 */</span>
SchemaType.prototype.doValidate = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value, callback, scope)</span> </span>{
  <span class="hljs-keyword">var</span> err = <span class="hljs-literal">false</span>
    , path = <span class="hljs-keyword">this</span>.path
    , count = <span class="hljs-keyword">this</span>.validators.length;

  <span class="hljs-keyword">if</span> (!count) <span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>);

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">validate</span> <span class="hljs-params">(ok, message, type, val)</span> </span>{
    <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span> (ok === <span class="hljs-literal">undefined</span> || ok) {
      --count || callback(<span class="hljs-literal">null</span>);
    } <span class="hljs-keyword">else</span> {
      callback(err = <span class="hljs-keyword">new</span> ValidatorError(path, message, type, val));
    }
  }

  <span class="hljs-keyword">this</span>.validators.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v)</span> </span>{
    <span class="hljs-keyword">var</span> validator = v[<span class="hljs-number">0</span>]
      , message = v[<span class="hljs-number">1</span>]
      , type = v[<span class="hljs-number">2</span>];

    <span class="hljs-keyword">if</span> (validator <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">RegExp</span>) {
      validate(validator.test(value), message, type, value);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">'function'</span> === <span class="hljs-keyword">typeof</span> validator) {
      <span class="hljs-keyword">if</span> (<span class="hljs-number">2</span> === validator.length) {
        validator.call(scope, value, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(ok)</span> </span>{
          validate(ok, message, type, value);
        });
      } <span class="hljs-keyword">else</span> {
        validate(validator.call(scope, value), message, type, value);
      }
    }
  });
};

<span class="hljs-comment">/**
 * Determines if value is a valid Reference.
 *
 * На клиенте в качестве ссылки можно хранить как id, так и полные документы
 *
 * @param {SchemaType} self
 * @param {Object} value
 * @return {Boolean}
 * @api private
 */</span>
SchemaType._isRef = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( self, value )</span></span>{
  <span class="hljs-comment">// fast path</span>
  <span class="hljs-keyword">var</span> ref = self.options &amp;&amp; self.options.ref;

  <span class="hljs-keyword">if</span> ( ref ) {
    <span class="hljs-keyword">if</span> ( <span class="hljs-literal">null</span> == value ) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">if</span> ( _.isObject( value ) ) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
};

<span class="hljs-comment">/*!
 * Module exports.
 */</span>

<span class="hljs-built_in">module</span>.exports = SchemaType;

SchemaType.CastError = CastError;

SchemaType.ValidatorError = ValidatorError;</code></pre></div><hr></div></li><li class="module"><a href="https://github.com/archangel-irk/storage/blob/0.0.1/lib/types/array.js" id="types-array-js">types/array.js</a><div class="item method private"><h3 id="types_array_StorageArray"><a href="#types_array_StorageArray">StorageArray(<code>values</code>, <code>path</code>, <code>doc</code>)</a></h3><p>Storage Array constructor.</p><div class="params"><h4>Parameters:</h4><ul><li><code>values</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span></span></li><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>doc</code><span class="types"> &lt;<a href="#document_Document">Document</a>&gt; </span><span>parent document</span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a></li></ul></div><div class="description"><h4>NOTE:</h4>
<p><em>Values always have to be passed to the constructor to initialize, otherwise <code>StorageArray#push</code> will mark the array as modified.</em></p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">StorageArray</span> <span class="hljs-params">(values, path, doc)</span> </span>{
  <span class="hljs-keyword">var</span> arr = [];
  arr.push.apply(arr, values);
  _.mixin( arr, StorageArray.mixin );

  arr.validators = [];
  arr._path = path;
  arr.isStorageArray = <span class="hljs-literal">true</span>;

  <span class="hljs-keyword">if</span> (doc) {
    arr._parent = doc;
    arr._schema = doc.schema.path(path);
  }

  <span class="hljs-keyword">return</span> arr;
}

StorageArray.mixin = {</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="types_array_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-_cast"><a href="#types_array_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-_cast">function Object() { [native code] }#_cast(<code>value</code>)</a></h3><p>Casts a member based on this arrays schema.</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="#*">*</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#value">value</a>&gt; </span><span>the casted value</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">_cast: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( value )</span> </span>{
  <span class="hljs-keyword">var</span> owner = <span class="hljs-keyword">this</span>._owner;
  <span class="hljs-keyword">var</span> populated = <span class="hljs-literal">false</span>;

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._parent) {
    <span class="hljs-comment">// if a populated array, we must cast to the same model</span>
    <span class="hljs-comment">// instance as specified in the original query.</span>
    <span class="hljs-keyword">if</span> (!owner) {
      owner = <span class="hljs-keyword">this</span>._owner = <span class="hljs-keyword">this</span>._parent.ownerDocument
        ? <span class="hljs-keyword">this</span>._parent.ownerDocument()
        : <span class="hljs-keyword">this</span>._parent;
    }

    populated = owner.populated(<span class="hljs-keyword">this</span>._path, <span class="hljs-literal">true</span>);
  }

  <span class="hljs-keyword">if</span> (populated &amp;&amp; <span class="hljs-literal">null</span> != value) {
    <span class="hljs-comment">// cast to the populated Models schema</span>
    <span class="hljs-keyword">var</span> Model = populated.options.model;

    <span class="hljs-comment">// only objects are permitted so we can safely assume that</span>
    <span class="hljs-comment">// non-objects are to be interpreted as _id</span>
    <span class="hljs-keyword">if</span> ( value <span class="hljs-keyword">instanceof</span> ObjectId || !_.isObject(value) ) {
      value = { _id: value };
    }

    value = <span class="hljs-keyword">new</span> Model(value);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._schema.caster.cast(value, <span class="hljs-keyword">this</span>._parent, <span class="hljs-literal">true</span>)
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._schema.caster.cast(value, <span class="hljs-keyword">this</span>._parent, <span class="hljs-literal">false</span>)
},</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="types_array_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-_markModified"><a href="#types_array_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-_markModified">function Object() { [native code] }#_markModified(<code>embeddedDoc</code>, <code>embeddedPath</code>)</a></h3><p>Marks this array as modified.</p><div class="params"><h4>Parameters:</h4><ul><li><code>embeddedDoc</code><span class="types"> &lt;<a href="#types_embedded_EmbeddedDocument">EmbeddedDocument</a>&gt; </span><span>the embedded doc that invoked this method on the Array</span></li><li><code>embeddedPath</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>the path which changed in the embeddedDoc</span></li></ul></div><div class="description"><p>If it bubbles up from an embedded document change, then it takes the following arguments (otherwise, takes 0 arguments)</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">_markModified: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(elem, embeddedPath)</span> </span>{
  <span class="hljs-keyword">var</span> parent = <span class="hljs-keyword">this</span>._parent
    , dirtyPath;

  <span class="hljs-keyword">if</span> (parent) {
    dirtyPath = <span class="hljs-keyword">this</span>._path;

    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length) {
      <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != embeddedPath) {
        <span class="hljs-comment">// an embedded doc bubbled up the change</span>
        dirtyPath = dirtyPath + <span class="hljs-string">'.'</span> + <span class="hljs-keyword">this</span>.indexOf(elem) + <span class="hljs-string">'.'</span> + embeddedPath;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// directly set an index</span>
        dirtyPath = dirtyPath + <span class="hljs-string">'.'</span> + elem;
      }
    }

    parent.markModified(dirtyPath);
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
},</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="types_array_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-addToSet"><a href="#types_array_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-addToSet">function Object() { [native code] }#addToSet(<code>arguments</code>)</a></h3><p>Adds values to the array if not already present.</p><div class="params"><h4>Parameters:</h4><ul><li><code>arguments</code><span class="types"> &lt;<a href="#*">*</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span>the values that were added</span></li></ul></div><div class="description"><h4>Example:</h4>
<pre><code><span class="hljs-built_in">console</span>.log(doc.array) <span class="hljs-comment">// [2,3,4]</span>
<span class="hljs-keyword">var</span> added = doc.array.addToSet(<span class="hljs-number">4</span>,<span class="hljs-number">5</span>);
<span class="hljs-built_in">console</span>.log(doc.array) <span class="hljs-comment">// [2,3,4,5]</span>
<span class="hljs-built_in">console</span>.log(added)     <span class="hljs-comment">// [5]</span></code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">addToSet: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addToSet</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> values = [].map.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-keyword">this</span>._cast, <span class="hljs-keyword">this</span>)
    , added = []
    , type = values[<span class="hljs-number">0</span>] <span class="hljs-keyword">instanceof</span> EmbeddedDocument ? <span class="hljs-string">'doc'</span> :
             values[<span class="hljs-number">0</span>] <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Date</span> ? <span class="hljs-string">'date'</span> :
             <span class="hljs-string">''</span>;

  values.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v)</span> </span>{
    <span class="hljs-keyword">var</span> found;
    <span class="hljs-keyword">switch</span> (type) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'doc'</span>:
        found = <span class="hljs-keyword">this</span>.some(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(doc)</span></span>{ <span class="hljs-keyword">return</span> doc.equals(v) });
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'date'</span>:
        <span class="hljs-keyword">var</span> val = +v;
        found = <span class="hljs-keyword">this</span>.some(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(d)</span></span>{ <span class="hljs-keyword">return</span> +d === val });
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">default</span>:
        found = ~<span class="hljs-keyword">this</span>.indexOf(v);
    }

    <span class="hljs-keyword">if</span> (!found) {
      [].push.call(<span class="hljs-keyword">this</span>, v);

      <span class="hljs-keyword">this</span>._markModified();
      [].push.call(added, v);
    }
  }, <span class="hljs-keyword">this</span>);

  <span class="hljs-keyword">return</span> added;
},</code></pre></div><hr></div><div class="item method public"><h3 id="types_array_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-indexOf"><a href="#types_array_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-indexOf">function Object() { [native code] }#indexOf(<code>obj</code>)</a></h3><p>Return the index of <code>obj</code> or <code>-1</code> if not found.</p><div class="params"><h4>Parameters:</h4><ul><li><code>obj</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>the item to look for</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">indexOf: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">indexOf</span> <span class="hljs-params">(obj)</span> </span>{
  <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">instanceof</span> ObjectId) obj = obj.toString();
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, len = <span class="hljs-keyword">this</span>.length; i &lt; len; ++i) {
    <span class="hljs-keyword">if</span> (obj == <span class="hljs-keyword">this</span>[i])
      <span class="hljs-keyword">return</span> i;
  }
  <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
}
};</code></pre></div><hr></div><div class="item method public"><h3 id="types_array_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-pop"><a href="#types_array_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-pop">function Object() { [native code] }#pop()</a></h3><p>Wraps <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/pop"><code>Array#pop</code></a> with proper change tracking.</p><div class="see"><h4>See:</h4><ul class="see"><li><a href="#types_array_StorageArray-%24pop" title="StorageArray#$pop">StorageArray#$pop</a></li></ul></div><div class="description"><h4>Note:</h4>
<p><em>marks the entire array as modified which will pass the entire thing to $set potentially overwritting any changes that happen between when you retrieved the object and when you save it.</em></p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">pop: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> ret = [].pop.call(<span class="hljs-keyword">this</span>);

  <span class="hljs-keyword">this</span>._markModified();
  <span class="hljs-keyword">return</span> ret;
},</code></pre></div><hr></div><div class="item method public"><h3 id="types_array_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-pull"><a href="#types_array_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-pull">function Object() { [native code] }#pull(<code>arguments</code>)</a></h3><p>Pulls items from the array atomically.</p><div class="params"><h4>Parameters:</h4><ul><li><code>arguments</code><span class="types"> &lt;<a href="#*">*</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://www.mongodb.org/display/DOCS/Updating/#Updating-%24pull" title="mongodb">mongodb</a></li></ul></div><div class="description"><h4>Examples:</h4>
<pre><code>doc.array.pull(ObjectId)
doc.array.pull({ _id: &amp;#<span class="hljs-number">39</span>;someId&amp;#<span class="hljs-number">39</span>; })
doc.array.pull(<span class="hljs-number">36</span>)
doc.array.pull(&amp;#<span class="hljs-number">39</span>;tag <span class="hljs-number">1</span>&amp;#<span class="hljs-number">39</span>;, &amp;#<span class="hljs-number">39</span>;tag <span class="hljs-number">2</span>&amp;#<span class="hljs-number">39</span>;)</code></pre><p>To remove a document from a subdocument array we may pass an object with a matching <code>_id</code>.</p><pre><code>doc.subdocs.push({ _id: <span class="hljs-number">4815162342</span> })
doc.subdocs.pull({ _id: <span class="hljs-number">4815162342</span> }) <span class="hljs-comment">// removed</span></code></pre><p>Or we may passing the _id directly and let storage take care of it.</p><pre><code>doc.subdocs.push({ _id: <span class="hljs-number">4815162342</span> })
doc.subdocs.pull(<span class="hljs-number">4815162342</span>); <span class="hljs-comment">// works</span></code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">pull: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> values = [].map.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-keyword">this</span>._cast, <span class="hljs-keyword">this</span>)
    , cur = <span class="hljs-keyword">this</span>._parent.get(<span class="hljs-keyword">this</span>._path)
    , i = cur.length
    , mem;

  <span class="hljs-keyword">while</span> (i--) {
    mem = cur[i];
    <span class="hljs-keyword">if</span> (mem <span class="hljs-keyword">instanceof</span> EmbeddedDocument) {
      <span class="hljs-keyword">if</span> (values.some(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v)</span> </span>{ <span class="hljs-keyword">return</span> v.equals(mem); } )) {
        [].splice.call(cur, i, <span class="hljs-number">1</span>);
      }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (~cur.indexOf.call(values, mem)) {
      [].splice.call(cur, i, <span class="hljs-number">1</span>);
    }
  }

  <span class="hljs-keyword">this</span>._markModified();
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
},</code></pre></div><hr></div><div class="item method public"><h3 id="types_array_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-push"><a href="#types_array_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-push">function Object() { [native code] }#push(<code>[args...]</code>)</a></h3><p>Wraps <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/push"><code>Array#push</code></a> with proper change tracking.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[args...]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">push: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> values = [].map.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-keyword">this</span>._cast, <span class="hljs-keyword">this</span>)
    , ret = [].push.apply(<span class="hljs-keyword">this</span>, values);

  <span class="hljs-keyword">this</span>._markModified();
  <span class="hljs-keyword">return</span> ret;
},</code></pre></div><hr></div><div class="item method public"><h3 id="types_array_StorageArray-remove"><a href="#types_array_StorageArray-remove">StorageArray#remove()</a></h3><p>Alias of <a href="#types_array_StorageArray-pull">pull</a></p><div class="see"><h4>See:</h4><ul class="see"><li><a href="#types_array_StorageArray-pull" title="StorageArray#pull">StorageArray#pull</a></li><li><a href="http://www.mongodb.org/display/DOCS/Updating/#Updating-%24pull" title="mongodb">mongodb</a></li></ul></div><div class="description"></div><hr></div><div class="item method public"><h3 id="types_array_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-set"><a href="#types_array_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-set">function Object() { [native code] }#set()</a></h3><p>Sets the casted <code>val</code> at index <code>i</code> and marks the array modified.</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span>this</span></li></ul></div><div class="description"><h4>Example:</h4>
<pre><code><span class="hljs-comment">// given documents based on the following</span>
<span class="hljs-keyword">var</span> docs = storage.createCollection(&amp;#<span class="hljs-number">39</span>;Doc&amp;#<span class="hljs-number">39</span>;, <span class="hljs-keyword">new</span> Schema({ array: [<span class="hljs-built_in">Number</span>] }));

<span class="hljs-keyword">var</span> doc = docs.add({ array: [<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>] })

<span class="hljs-built_in">console</span>.log(doc.array) <span class="hljs-comment">// [2,3,4]</span>

doc.array.set(<span class="hljs-number">1</span>,&amp;quot;<span class="hljs-number">5</span>&amp;quot;);
<span class="hljs-built_in">console</span>.log(doc.array); <span class="hljs-comment">// [2,5,4] // properly cast to number</span>
doc.save() <span class="hljs-comment">// the change is saved</span>

<span class="hljs-comment">// VS not using array#set</span>
doc.array[<span class="hljs-number">1</span>] = &amp;quot;<span class="hljs-number">5</span>&amp;quot;;
<span class="hljs-built_in">console</span>.log(doc.array); <span class="hljs-comment">// [2,&amp;quot;5&amp;quot;,4] // no casting</span>
doc.save() <span class="hljs-comment">// change is not saved</span></code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">set: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(i, val)</span> </span>{
  <span class="hljs-keyword">this</span>[i] = <span class="hljs-keyword">this</span>._cast(val);
  <span class="hljs-keyword">this</span>._markModified(i);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
},</code></pre></div><hr></div><div class="item method public"><h3 id="types_array_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-shift"><a href="#types_array_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-shift">function Object() { [native code] }#shift()</a></h3><p>Wraps <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/unshift"><code>Array#shift</code></a> with proper change tracking.</p><div class="description"><h4>Example:</h4>
<pre><code>doc.array = [<span class="hljs-number">2</span>,<span class="hljs-number">3</span>];
<span class="hljs-keyword">var</span> res = doc.array.shift();
<span class="hljs-built_in">console</span>.log(res) <span class="hljs-comment">// 2</span>
<span class="hljs-built_in">console</span>.log(doc.array) <span class="hljs-comment">// [3]</span></code></pre><h4>Note:</h4>
<p><em>marks the entire array as modified, which if saved, will store it as a <code>$set</code> operation, potentially overwritting any changes that happen between when you retrieved the object and when you save it.</em></p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">shift: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> ret = [].shift.call(<span class="hljs-keyword">this</span>);

  <span class="hljs-keyword">this</span>._markModified();
  <span class="hljs-keyword">return</span> ret;
},</code></pre></div><hr></div><div class="item method public"><h3 id="types_array_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-sort"><a href="#types_array_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-sort">function Object() { [native code] }#sort()</a></h3><p>Wraps <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/sort"><code>Array#sort</code></a> with proper change tracking.</p><div class="description"><h4>NOTE:</h4>
<p><em>marks the entire array as modified, which if saved, will store it as a <code>$set</code> operation, potentially overwritting any changes that happen between when you retrieved the object and when you save it.</em></p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">sort: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> ret = [].sort.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);

  <span class="hljs-keyword">this</span>._markModified();
  <span class="hljs-keyword">return</span> ret;
},</code></pre></div><hr></div><div class="item method public"><h3 id="types_array_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-splice"><a href="#types_array_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-splice">function Object() { [native code] }#splice()</a></h3><p>Wraps <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/splice"><code>Array#splice</code></a> with proper change tracking and casting.</p><div class="description"><h4>Note:</h4>
<p><em>marks the entire array as modified, which if saved, will store it as a <code>$set</code> operation, potentially overwritting any changes that happen between when you retrieved the object and when you save it.</em></p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">splice: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">splice</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> ret, vals, i;

  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length) {
    vals = [];
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">arguments</span>.length; ++i) {
      vals[i] = i &lt; <span class="hljs-number">2</span>
        ? <span class="hljs-built_in">arguments</span>[i]
        : <span class="hljs-keyword">this</span>._cast(<span class="hljs-built_in">arguments</span>[i]);
    }
    ret = [].splice.apply(<span class="hljs-keyword">this</span>, vals);

    <span class="hljs-keyword">this</span>._markModified();
  }

  <span class="hljs-keyword">return</span> ret;
},</code></pre></div><hr></div><div class="item method public"><h3 id="types_array_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-toObject"><a href="#types_array_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-toObject">function Object() { [native code] }#toObject(<code>options</code>)</a></h3><p>Returns a native js Array.</p><div class="params"><h4>Parameters:</h4><ul><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">toObject: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> </span>{
  <span class="hljs-keyword">if</span> (options &amp;&amp; options.depopulate) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{
      <span class="hljs-keyword">return</span> doc <span class="hljs-keyword">instanceof</span> Document
        ? doc.toObject(options)
        : doc
    });
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.slice();
},</code></pre></div><hr></div><div class="item method public"><h3 id="types_array_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-unshift"><a href="#types_array_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-unshift">function Object() { [native code] }#unshift()</a></h3><p>Wraps <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/unshift"><code>Array#unshift</code></a> with proper change tracking.</p><div class="description"><h4>Note:</h4>
<p><em>marks the entire array as modified, which if saved, will store it as a <code>$set</code> operation, potentially overwritting any changes that happen between when you retrieved the object and when you save it.</em></p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">unshift: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> values = [].map.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-keyword">this</span>._cast, <span class="hljs-keyword">this</span>);
  [].unshift.apply(<span class="hljs-keyword">this</span>, values);

  <span class="hljs-keyword">this</span>._markModified();
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.length;
},</code></pre></div><hr></div><div class="item property private"><h3 id="types_array_StorageArray-_parent"><a href="#types_array_StorageArray-_parent">StorageArray#<span>_parent</span></a></h3><p>Parent owner document</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">_parent: <span class="hljs-literal">undefined</span>,</code></pre></div><hr class="private"></div></li><li class="module"><a href="https://github.com/archangel-irk/storage/blob/0.0.1/lib/types/buffer.js" id="types-buffer-js">types/buffer.js</a><div class="item method private"><h3 id="types_buffer_StorageBuffer"><a href="#types_buffer_StorageBuffer">StorageBuffer(<code>value</code>, <code>encode</code>, <code>offset</code>)</a></h3><p>Storage Buffer constructor.</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="http://nodejs.org/api/buffer.html">Buffer</a>&gt; </span><span></span></li><li><code>encode</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>offset</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="http://nodejs.org/api/buffer.html">Buffer</a></li></ul></div><div class="description"><p>Values always have to be passed to the constructor to initialize.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">StorageBuffer</span> <span class="hljs-params">(value, encode, offset)</span> </span>{
  <span class="hljs-keyword">var</span> length = <span class="hljs-built_in">arguments</span>.length;
  <span class="hljs-keyword">var</span> val;

  <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> === length || <span class="hljs-literal">null</span> === <span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>] || <span class="hljs-literal">undefined</span> === <span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>]) {
    val = <span class="hljs-number">0</span>;
  } <span class="hljs-keyword">else</span> {
    val = value;
  }

  <span class="hljs-keyword">var</span> encoding;
  <span class="hljs-keyword">var</span> path;
  <span class="hljs-keyword">var</span> doc;

  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(encode)) {
    <span class="hljs-comment">// internal casting</span>
    path = encode[<span class="hljs-number">0</span>];
    doc = encode[<span class="hljs-number">1</span>];
  } <span class="hljs-keyword">else</span> {
    encoding = encode;
  }

  <span class="hljs-keyword">var</span> buf = <span class="hljs-keyword">new</span> Buffer(val, encoding, offset);
  _.mixin( buf, StorageBuffer.mixin );
  buf.isStorageBuffer = <span class="hljs-literal">true</span>;

  <span class="hljs-comment">// make sure these internal props don't show up in Object.keys()</span>
  <span class="hljs-built_in">Object</span>.defineProperties(buf, {
      validators: { value: [] }
    , _path: { value: path }
    , _parent: { value: doc }
  });

  <span class="hljs-keyword">if</span> (doc &amp;&amp; <span class="hljs-string">"string"</span> === <span class="hljs-keyword">typeof</span> path) {
    <span class="hljs-built_in">Object</span>.defineProperty(buf, <span class="hljs-string">'_schema'</span>, {
        value: doc.schema.path(path)
    });
  }

  buf._subtype = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">return</span> buf;
}</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="types_buffer_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-_markModified"><a href="#types_buffer_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-_markModified">function Object() { [native code] }#_markModified()</a></h3><p>Marks this buffer as modified.</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">_markModified: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> parent = <span class="hljs-keyword">this</span>._parent;

  <span class="hljs-keyword">if</span> (parent) {
    parent.markModified(<span class="hljs-keyword">this</span>._path);
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
},</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="types_buffer_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-copy"><a href="#types_buffer_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-copy">function Object() { [native code] }#copy(<code>target</code>)</a></h3><p>Copies the buffer.</p><div class="params"><h4>Parameters:</h4><ul><li><code>target</code><span class="types"> &lt;<a href="http://nodejs.org/api/buffer.html">Buffer</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#StorageBuffer">StorageBuffer</a>&gt; </span><span></span></li></ul></div><div class="description"><h4>Note:</h4>
<p><code>Buffer#copy</code> does not mark <code>target</code> as modified so you must copy from a <code>StorageBuffer</code> for it to work as expected. This is a work around since <code>copy</code> modifies the target, not this.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">copy: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(target)</span> </span>{
  <span class="hljs-keyword">var</span> ret = Buffer.prototype.copy.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);

  <span class="hljs-keyword">if</span> (target &amp;&amp; target.isStorageBuffer) {
    target._markModified();
  }

  <span class="hljs-keyword">return</span> ret;
}
};</code></pre></div><hr></div><div class="item method public"><h3 id="types_buffer_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-write"><a href="#types_buffer_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-write">function Object() { [native code] }#write()</a></h3><p>Writes the buffer.</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">write: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> written = Buffer.prototype.write.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);

  <span class="hljs-keyword">if</span> (written &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">this</span>._markModified();
  }

  <span class="hljs-keyword">return</span> written;
},</code></pre></div><hr></div><div class="item static public"><h3 id="types_buffer_StorageBuffer.mixin.equals"><a href="#types_buffer_StorageBuffer.mixin.equals">StorageBuffer.mixin.equals(<code>other</code>)</a></h3><p>Determines if this buffer is equals to <code>other</code> buffer</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">StorageBuffer.mixin.equals = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(other)</span> </span>{
  <span class="hljs-keyword">if</span> (!Buffer.isBuffer(other)) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.length !== other.length) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.length; ++i) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>[i] !== other[i]) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>other</code><span class="types"> &lt;<a href="http://nodejs.org/api/buffer.html">Buffer</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><hr></div><div class="item static public"><h3 id="types_buffer_StorageBuffer.mixin.subtype"><a href="#types_buffer_StorageBuffer.mixin.subtype">StorageBuffer.mixin.subtype(<code>subtype</code>)</a></h3><p>Sets the subtype option and marks the buffer modified.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">StorageBuffer.mixin.subtype = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(subtype)</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-string">'number'</span> != <span class="hljs-keyword">typeof</span> subtype) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">TypeError</span>(<span class="hljs-string">'Invalid subtype. Expected a number'</span>);
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._subtype != subtype) {
    <span class="hljs-keyword">this</span>._markModified();
  }

  <span class="hljs-keyword">this</span>._subtype = subtype;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>subtype</code><span class="types"> &lt;<a href="#Hex">Hex</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><url>= see.url || see.local</url><a href="types_buffer_StorageBuffer.mixin.subtype">http://bsonspec.org/#/specification</a></li></ul></div><h4>SubTypes:</h4>
<p>  var bson = require(&#39;bson&#39;)<br />  bson.BSON_BINARY_SUBTYPE_DEFAULT<br />  bson.BSON_BINARY_SUBTYPE_FUNCTION<br />  bson.BSON_BINARY_SUBTYPE_BYTE_ARRAY<br />  bson.BSON_BINARY_SUBTYPE_UUID<br />  bson.BSON_BINARY_SUBTYPE_MD5<br />  bson.BSON_BINARY_SUBTYPE_USER_DEFINED</p><p>  doc.buffer.subtype(bson.BSON_BINARY_SUBTYPE_UUID);</p><hr></div><div class="item static public"><h3 id="types_buffer_StorageBuffer.mixin.toObject"><a href="#types_buffer_StorageBuffer.mixin.toObject">StorageBuffer.mixin.toObject(<code>[subtype]</code>)</a></h3><p>Converts this buffer to its Binary type representation.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">StorageBuffer.mixin.toObject = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> </span>{
  <span class="hljs-keyword">var</span> subtype = <span class="hljs-string">'number'</span> == <span class="hljs-keyword">typeof</span> options
    ? options
    : (<span class="hljs-keyword">this</span>._subtype || <span class="hljs-number">0</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Binary(<span class="hljs-keyword">this</span>, subtype);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>[subtype]</code><span class="types"> &lt;<a href="#Hex">Hex</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://github.com/mongodb/js-bson/blob/master/lib/bson/binary.js">Binary</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><url>= see.url || see.local</url><a href="types_buffer_StorageBuffer.mixin.toObject">http://bsonspec.org/#/specification</a></li></ul></div><h4>SubTypes:</h4>
<p>  var bson = require(&#39;bson&#39;)<br />  bson.BSON_BINARY_SUBTYPE_DEFAULT<br />  bson.BSON_BINARY_SUBTYPE_FUNCTION<br />  bson.BSON_BINARY_SUBTYPE_BYTE_ARRAY<br />  bson.BSON_BINARY_SUBTYPE_UUID<br />  bson.BSON_BINARY_SUBTYPE_MD5<br />  bson.BSON_BINARY_SUBTYPE_USER_DEFINED</p><p>  doc.buffer.toObject(bson.BSON_BINARY_SUBTYPE_USER_DEFINED);</p><hr></div><div class="item property private"><h3 id="types_buffer_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-_parent"><a href="#types_buffer_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-_parent">function Object() { [native code] }#<span>_parent</span></a></h3><p>Parent owner document</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">_parent: <span class="hljs-literal">undefined</span>,</code></pre></div><hr class="private"></div><div class="item property private"><h3 id="types_buffer_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-_subtype"><a href="#types_buffer_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-_subtype">function Object() { [native code] }#<span>_subtype</span></a></h3><p>Default subtype for the Binary representing this Buffer</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">_subtype: <span class="hljs-literal">undefined</span>,</code></pre></div><hr class="private"></div></li><li class="module"><a href="https://github.com/archangel-irk/storage/blob/0.0.1/lib/types/documentarray.js" id="types-documentarray-js">types/documentarray.js</a><div class="item method private"><h3 id="types_documentarray_StorageDocumentArray"><a href="#types_documentarray_StorageDocumentArray">StorageDocumentArray(<code>values</code>, <code>path</code>, <code>doc</code>)</a></h3><p>DocumentArray constructor</p><div class="params"><h4>Parameters:</h4><ul><li><code>values</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span></span></li><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>the path to this array</span></li><li><code>doc</code><span class="types"> &lt;<a href="#document_Document">Document</a>&gt; </span><span>parent document</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#StorageDocumentArray">StorageDocumentArray</a>&gt; </span><span></span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="#StorageArray">StorageArray</a></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="TODO: подчистить код

Весь нужный код скопирован" title="http://bit.ly/f6CnZU">http://bit.ly/f6CnZU</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">StorageDocumentArray</span> <span class="hljs-params">(values, path, doc)</span> </span>{
  <span class="hljs-keyword">var</span> arr = [];

  <span class="hljs-comment">// Values always have to be passed to the constructor to initialize, since</span>
  <span class="hljs-comment">// otherwise StorageArray#push will mark the array as modified to the parent.</span>
  arr.push.apply(arr, values);
  _.mixin( arr, StorageDocumentArray.mixin );

  arr.validators = [];
  arr._path = path;
  arr.isStorageArray = <span class="hljs-literal">true</span>;
  arr.isStorageDocumentArray = <span class="hljs-literal">true</span>;

  <span class="hljs-keyword">if</span> (doc) {
    arr._parent = doc;
    arr._schema = doc.schema.path(path);
    arr._handlers = {
      isNew: arr.notify(<span class="hljs-string">'isNew'</span>),
      save: arr.notify(<span class="hljs-string">'save'</span>)
    };

    <span class="hljs-comment">// Проброс изменения состояния в поддокумент</span>
    doc.on(<span class="hljs-string">'save'</span>, arr._handlers.save);
    doc.on(<span class="hljs-string">'isNew'</span>, arr._handlers.isNew);
  }

  <span class="hljs-keyword">return</span> arr;
}</code></pre></div><hr class="private"></div><div class="item static private"><h3 id="types_documentarray_StorageDocumentArray.mixin._cast"><a href="#types_documentarray_StorageDocumentArray.mixin._cast">StorageDocumentArray.mixin._cast()</a></h3><p>Overrides StorageArray#cast</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">StorageDocumentArray.mixin._cast = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value)</span> </span>{
  <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> <span class="hljs-keyword">this</span>._schema.casterConstructor) {
    <span class="hljs-keyword">if</span> (!(value.__parent &amp;&amp; value.__parentArray)) {
      <span class="hljs-comment">// value may have been created using array.create()</span>
      value.__parent = <span class="hljs-keyword">this</span>._parent;
      value.__parentArray = <span class="hljs-keyword">this</span>;
    }
    <span class="hljs-keyword">return</span> value;
  }

  <span class="hljs-comment">// handle cast('string') or cast(ObjectId) etc.</span>
  <span class="hljs-comment">// only objects are permitted so we can safely assume that</span>
  <span class="hljs-comment">// non-objects are to be interpreted as _id</span>
  <span class="hljs-keyword">if</span> ( value <span class="hljs-keyword">instanceof</span> ObjectId || !_.isObject(value) ) {
    value = { _id: value };
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-keyword">this</span>._schema.casterConstructor(value, <span class="hljs-keyword">this</span>);
};</code></pre></div><hr class="private"></div><div class="item static public"><h3 id="types_documentarray_StorageDocumentArray.mixin.create"><a href="#types_documentarray_StorageDocumentArray.mixin.create">StorageDocumentArray.mixin.create(<code>obj</code>)</a></h3><p>Creates a subdocument casted to this schema.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">StorageDocumentArray.mixin.create = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-keyword">this</span>._schema.casterConstructor(obj);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>obj</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>the value to cast to this arrays SubDocument schema</span></li></ul></div><p>This is the same subdocument constructor used for casting.</p><hr></div><div class="item static public"><h3 id="types_documentarray_StorageDocumentArray.mixin.id"><a href="#types_documentarray_StorageDocumentArray.mixin.id">StorageDocumentArray.mixin.id(<code>id</code>)</a></h3><p>Searches array items for the first document with a matching _id.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">StorageDocumentArray.mixin.id = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(id)</span> </span>{
  <span class="hljs-keyword">var</span> casted
    , sid
    , _id;

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">var</span> casted_ = ObjectIdSchema.prototype.cast.call({}, id);
    <span class="hljs-keyword">if</span> (casted_) casted = <span class="hljs-built_in">String</span>(casted_);
  } <span class="hljs-keyword">catch</span> (e) {
    casted = <span class="hljs-literal">null</span>;
  }

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = <span class="hljs-keyword">this</span>.length; i &lt; l; i++) {
    _id = <span class="hljs-keyword">this</span>[i].get(<span class="hljs-string">'_id'</span>);

    <span class="hljs-keyword">if</span> (_id <span class="hljs-keyword">instanceof</span> Document) {
      sid || (sid = <span class="hljs-built_in">String</span>(id));
      <span class="hljs-keyword">if</span> (sid == _id._id) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>[i];
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!(_id <span class="hljs-keyword">instanceof</span> ObjectId)) {
      sid || (sid = <span class="hljs-built_in">String</span>(id));
      <span class="hljs-keyword">if</span> (sid == _id) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>[i];
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (casted == _id) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>[i];
    }
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>id</code><span class="types"> &lt;<a href="#types_objectid_ObjectId">ObjectId</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#types_embedded_EmbeddedDocument">EmbeddedDocument</a>, <a href="#null">null</a>&gt; </span><span>the subdocument or null if not found.</span></li></ul></div><h4>Example:</h4>
<pre><code><span class="hljs-keyword">var</span> embeddedDoc = m.array.id(some_id);</code></pre><hr></div><div class="item static private"><h3 id="types_documentarray_StorageDocumentArray.mixin.notify"><a href="#types_documentarray_StorageDocumentArray.mixin.notify">StorageDocumentArray.mixin.notify(<code>event</code>)</a></h3><p>Creates a fn that notifies all child docs of <code>event</code>.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">StorageDocumentArray.mixin.notify = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">notify</span> <span class="hljs-params">(event)</span> </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">notify</span> <span class="hljs-params">(val)</span> </span>{
    <span class="hljs-keyword">var</span> i = self.length;
    <span class="hljs-keyword">while</span> (i--) {
      <span class="hljs-keyword">if</span> (!self[i]) <span class="hljs-keyword">continue</span>;
      self[i].trigger(event, val);
    }
  }
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>event</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><hr class="private"></div><div class="item static public"><h3 id="types_documentarray_StorageDocumentArray.mixin.toObject"><a href="#types_documentarray_StorageDocumentArray.mixin.toObject">StorageDocumentArray.mixin.toObject(<code>[options]</code>)</a></h3><p>Returns a native js Array of plain js objects</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">StorageDocumentArray.mixin.toObject = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{
    <span class="hljs-keyword">return</span> doc &amp;&amp; doc.toObject(options) || <span class="hljs-literal">null</span>;
  });
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>optional options to pass to each documents `toObject` method call during conversion</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span></span></li></ul></div><h4>NOTE:</h4>
<p><em>Each sub-document is converted to a plain object by calling its <code>#toObject</code> method.</em></p><hr></div></li><li class="module"><a href="https://github.com/archangel-irk/storage/blob/0.0.1/lib/types/embedded.js" id="types-embedded-js">types/embedded.js</a><div class="item method private"><h3 id="types_embedded_EmbeddedDocument-%24__fullPath"><a href="#types_embedded_EmbeddedDocument-%24__fullPath">EmbeddedDocument#$__fullPath(<code>[path]</code>)</a></h3><p>Returns the full path to this document. If optional <code>path</code> is passed, it is appended to the full path.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[path]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="description"></div><hr class="private"></div><div class="item method private"><h3 id="types_embedded_EmbeddedDocument"><a href="#types_embedded_EmbeddedDocument">EmbeddedDocument(<code>data</code>, <code>parentArr</code>)</a></h3><p>EmbeddedDocument constructor.</p><div class="params"><h4>Parameters:</h4><ul><li><code>data</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>js object returned from the db</span></li><li><code>parentArr</code><span class="types"> &lt;<a href="#StorageDocumentArray">StorageDocumentArray</a>&gt; </span><span>the parent array of this document</span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="#document_Document">Document</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">EmbeddedDocument</span> <span class="hljs-params">( data, parentArr )</span> </span>{
  <span class="hljs-keyword">if</span> (parentArr) {
    <span class="hljs-keyword">this</span>.__parentArray = parentArr;
    <span class="hljs-keyword">this</span>.__parent = parentArr._parent;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">this</span>.__parentArray = <span class="hljs-literal">undefined</span>;
    <span class="hljs-keyword">this</span>.__parent = <span class="hljs-literal">undefined</span>;
  }

  Document.call( <span class="hljs-keyword">this</span>, data, <span class="hljs-literal">undefined</span> );

  <span class="hljs-comment">// Нужно для проброса изменения значения из родительского документа, например при сохранении</span>
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">this</span>.on(<span class="hljs-string">'isNew'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(val)</span> </span>{
    self.isNew = val;
  });
}</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="types_embedded_EmbeddedDocument-invalidate"><a href="#types_embedded_EmbeddedDocument-invalidate">EmbeddedDocument#invalidate(<code>path</code>, <code>err</code>)</a></h3><p>Marks a path as invalid, causing validation to fail.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>the field to invalidate</span></li><li><code>err</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Error">Error</a>&gt; </span><span>error which states the reason `path` was invalid</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">EmbeddedDocument.prototype.invalidate = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(path, err, val, first)</span> </span>{
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.__parent) {
    <span class="hljs-keyword">var</span> msg = <span class="hljs-string">'Unable to invalidate a subdocument that has not been added to an array.'</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(msg);
  }

  <span class="hljs-keyword">var</span> index = <span class="hljs-keyword">this</span>.__parentArray.indexOf(<span class="hljs-keyword">this</span>);
  <span class="hljs-keyword">var</span> parentPath = <span class="hljs-keyword">this</span>.__parentArray._path;
  <span class="hljs-keyword">var</span> fullPath = [parentPath, index, path].join(<span class="hljs-string">'.'</span>);

  <span class="hljs-comment">// sniffing arguments:</span>
  <span class="hljs-comment">// need to check if user passed a value to keep</span>
  <span class="hljs-comment">// our error message clean.</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-number">2</span> &lt; <span class="hljs-built_in">arguments</span>.length) {
    <span class="hljs-keyword">this</span>.__parent.invalidate(fullPath, err, val);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">this</span>.__parent.invalidate(fullPath, err);
  }

  <span class="hljs-keyword">if</span> (first)
    <span class="hljs-keyword">this</span>.$__.validationError = <span class="hljs-keyword">this</span>.ownerDocument().$__.validationError;
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
};</code></pre></div><hr></div><div class="item method public"><h3 id="types_embedded_EmbeddedDocument-markModified"><a href="#types_embedded_EmbeddedDocument-markModified">EmbeddedDocument#markModified(<code>path</code>)</a></h3><p>Marks the embedded doc modified.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>the path which changed</span></li></ul></div><div class="description"><h4>Example:</h4>
<pre><code><span class="hljs-keyword">var</span> doc = blogpost.comments.id(hexstring);
doc.mixed.type = &amp;#<span class="hljs-number">39</span>;changed&amp;#<span class="hljs-number">39</span>;;
doc.markModified(&amp;#<span class="hljs-number">39</span>;mixed.type&amp;#<span class="hljs-number">39</span>;);</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">EmbeddedDocument.prototype.markModified = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(path)</span> </span>{
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.__parentArray) <span class="hljs-keyword">return</span>;

  <span class="hljs-keyword">this</span>.$__.activePaths.modify(path);

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isNew) {
    <span class="hljs-comment">// Mark the WHOLE parent array as modified</span>
    <span class="hljs-comment">// if this is a new document (i.e., we are initializing</span>
    <span class="hljs-comment">// a document),</span>
    <span class="hljs-keyword">this</span>.__parentArray._markModified();
  } <span class="hljs-keyword">else</span>
    <span class="hljs-keyword">this</span>.__parentArray._markModified(<span class="hljs-keyword">this</span>, path);
};</code></pre></div><hr></div><div class="item method public"><h3 id="types_embedded_EmbeddedDocument-ownerDocument"><a href="#types_embedded_EmbeddedDocument-ownerDocument">EmbeddedDocument#ownerDocument()</a></h3><p>Returns the top level document of this sub-document.</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#document_Document">Document</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">EmbeddedDocument.prototype.ownerDocument = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.$__.ownerDocument) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.$__.ownerDocument;
  }

  <span class="hljs-keyword">var</span> parent = <span class="hljs-keyword">this</span>.__parent;
  <span class="hljs-keyword">if</span> (!parent) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;

  <span class="hljs-keyword">while</span> (parent.__parent) {
    parent = parent.__parent;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.$__.ownerDocument = parent;
};</code></pre></div><hr></div><div class="item method public"><h3 id="types_embedded_EmbeddedDocument-parent"><a href="#types_embedded_EmbeddedDocument-parent">EmbeddedDocument#parent()</a></h3><p>Returns this sub-documents parent document.</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">EmbeddedDocument.prototype.parent = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.__parent;
};</code></pre></div><hr></div><div class="item method public"><h3 id="types_embedded_EmbeddedDocument-parentArray"><a href="#types_embedded_EmbeddedDocument-parentArray">EmbeddedDocument#parentArray()</a></h3><p>Returns this sub-documents parent array.</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">EmbeddedDocument.prototype.parentArray = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.__parentArray;
};</code></pre></div><hr></div><div class="item method public"><h3 id="types_embedded_EmbeddedDocument-remove"><a href="#types_embedded_EmbeddedDocument-remove">EmbeddedDocument#remove(<code>[fn]</code>)</a></h3><p>Removes the subdocument from its parent array.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[fn]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">EmbeddedDocument.prototype.remove = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn)</span> </span>{
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.__parentArray) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;

  <span class="hljs-keyword">var</span> _id;
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.willRemove) {
    _id = <span class="hljs-keyword">this</span>._doc._id;
    <span class="hljs-keyword">if</span> (!_id) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'For your own good, Storage does not know '</span> +
                      <span class="hljs-string">'how to remove an EmbeddedDocument that has no _id'</span>);
    }
    <span class="hljs-keyword">this</span>.__parentArray.pull({ _id: _id });
    <span class="hljs-keyword">this</span>.willRemove = <span class="hljs-literal">true</span>;
  }

  <span class="hljs-keyword">if</span> (fn)
    fn(<span class="hljs-literal">null</span>);

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</code></pre></div><hr></div><div class="item method private"><h3 id="types_embedded_EmbeddedDocument-save"><a href="#types_embedded_EmbeddedDocument-save">EmbeddedDocument#save(<code>[fn]</code>)</a></h3><p>Used as a stub for <a href="https://github.com/bnoguchi/hooks-js/tree/31ec571cef0332e21121ee7157e0cf9728572cc3">hooks.js</a></p><div class="params"><h4>Parameters:</h4><ul><li><code>[fn]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span>resolved Promise</span></li></ul></div><div class="description"><h4>NOTE:</h4>
<p><em>This is a no-op. Does not actually save the doc to the db.</em></p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">EmbeddedDocument.prototype.save = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn)</span> </span>{
  <span class="hljs-keyword">var</span> promise = $.Deferred().done(fn);
  promise.resolve();
  <span class="hljs-keyword">return</span> promise;
}</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="types_embedded_EmbeddedDocument-update"><a href="#types_embedded_EmbeddedDocument-update">EmbeddedDocument#update()</a></h3><p>Override #update method of parent documents.</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">EmbeddedDocument.prototype.update = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'The #update method is not available on EmbeddedDocuments'</span>);
};</code></pre></div><hr class="private"></div></li><li class="module"><a href="https://github.com/archangel-irk/storage/blob/0.0.1/lib/types/objectid.js" id="types-objectid-js">types/objectid.js</a><div class="item method public"><h3 id="types_objectid_"><a href="#types_objectid_">()</a></h3><p>Module dependencies.</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="hljs-keyword">var</span> BinaryParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../binaryparser'</span>).BinaryParser;</code></pre></div><hr></div><div class="item method public"><h3 id="types_objectid_"><a href="#types_objectid_">()</a></h3><p>Machine id.</p><div class="description"><p>Create a random 3-byte value (i.e. unique for this<br />process). Other drivers use a md5 of the machine id here, but<br />that would mean an asyc call to gethostname, so we don&#39;t bother.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="hljs-keyword">var</span> MACHINE_ID = <span class="hljs-built_in">parseInt</span>(<span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">0xFFFFFF</span>, <span class="hljs-number">10</span>);

<span class="hljs-comment">// Regular expression that checks for hex value</span>
<span class="hljs-keyword">var</span> checkForHexRegExp = <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">"^[0-9a-fA-F]{24}$"</span>);</code></pre></div><hr></div><div class="item method public"><h3 id="types_objectid_ObjectId-equals"><a href="#types_objectid_ObjectId-equals">ObjectId#equals(<code>otherID</code>)</a></h3><p>Compares the equality of this ObjectId with <code>otherID</code>.</p><div class="params"><h4>Parameters:</h4><ul><li><code>otherID</code><span class="types"> &lt;<a href="#object">object</a>&gt; </span><span>ObjectId instance to compare against.</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#boolean">boolean</a>&gt; </span><span>the result of comparing two ObjectId's</span></li></ul></div><div class="description"></div><hr></div><div class="item method public"><h3 id="types_objectid_ObjectId-generate"><a href="#types_objectid_ObjectId-generate">ObjectId#generate(<code>[time]</code>)</a></h3><p>Generate a 12 byte id string used in ObjectId&#39;s</p><div class="params"><h4>Parameters:</h4><ul><li><code>[time]</code><span class="types"> &lt;<a href="#number">number</a>&gt; </span><span>optional parameter allowing to pass in a second based timestamp.</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#string">string</a>&gt; </span><span>return the 12 byte id binary string.</span></li></ul></div><div class="description"></div><hr></div><div class="item method public"><h3 id="types_objectid_ObjectId-getInc"><a href="#types_objectid_ObjectId-getInc">ObjectId#getInc()</a></h3><p>Update the ObjectId index used in generating new ObjectId&#39;s on the driver</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#number">number</a>&gt; </span><span>returns next index value.</span></li></ul></div><div class="description"></div><hr></div><div class="item method public"><h3 id="types_objectid_ObjectId-getTimestamp"><a href="#types_objectid_ObjectId-getTimestamp">ObjectId#getTimestamp()</a></h3><p>Returns the generation date (accurate up to the second) that this ID was generated.</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#date">date</a>&gt; </span><span>the generation date</span></li></ul></div><div class="description"></div><hr></div><div class="item method public"><h3 id="types_objectid_ObjectId-get_inc"><a href="#types_objectid_ObjectId-get_inc">ObjectId#get_inc()</a></h3><p>Update the ObjectId index used in generating new ObjectId&#39;s on the driver</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#number">number</a>&gt; </span><span>returns next index value.</span></li></ul></div><div class="description"></div><hr></div><div class="item method public"><h3 id="types_objectid_"><a href="#types_objectid_">()</a></h3><p>for time-based ObjectId the bytes following the time will be zeroed</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="hljs-keyword">var</span> machine3Bytes = BinaryParser.encodeInt(MACHINE_ID, <span class="hljs-number">24</span>, <span class="hljs-literal">false</span>);
<span class="hljs-keyword">var</span> pid2Bytes = BinaryParser.fromShort(<span class="hljs-keyword">typeof</span> process === <span class="hljs-string">'undefined'</span> ? <span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">100000</span>) : process.pid);
<span class="hljs-keyword">var</span> index3Bytes = BinaryParser.encodeInt(<span class="hljs-keyword">this</span>.get_inc(), <span class="hljs-number">24</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);

<span class="hljs-keyword">return</span> time4Bytes + machine3Bytes + pid2Bytes + index3Bytes;
};</code></pre></div><hr></div><div class="item method public"><h3 id="types_objectid_ObjectId-toHexString"><a href="#types_objectid_ObjectId-toHexString">ObjectId#toHexString()</a></h3><p>Return the ObjectId id as a 24 byte hex string representation</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#string">string</a>&gt; </span><span>return the 24 byte hex string representation.</span></li></ul></div><div class="description"></div><hr></div><div class="item method public"><h3 id="types_objectid_ObjectId-toJSON"><a href="#types_objectid_ObjectId-toJSON">ObjectId#toJSON()</a></h3><p>Converts to its JSON representation.</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>return the 24 byte hex string representation.</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">ObjectId.prototype.toJSON = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.toHexString();
};</code></pre></div><hr></div><div class="item method public"><h3 id="types_objectid_ObjectId-toString"><a href="#types_objectid_ObjectId-toString">ObjectId#toString()</a></h3><p>Converts the id into a 24 byte hex string for printing</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>return the 24 byte hex string representation.</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">ObjectId.prototype.toString = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.toHexString();
};</code></pre></div><hr></div><div class="item static public"><h3 id="types_objectid_ObjectId.createFromHexString"><a href="#types_objectid_ObjectId.createFromHexString">ObjectId.createFromHexString(<code>hexString</code>)</a></h3><p>Creates an ObjectId from a hex string representation of an ObjectId.</p><div class="params"><h4>Parameters:</h4><ul><li><code>hexString</code><span class="types"> &lt;<a href="#string">string</a>&gt; </span><span>create a ObjectId from a passed in 24 byte hexstring.</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#types_objectid_ObjectId">ObjectId</a>&gt; </span><span>return the created ObjectId</span></li></ul></div><hr></div><div class="item static public"><h3 id="types_objectid_ObjectId.createFromTime"><a href="#types_objectid_ObjectId.createFromTime">ObjectId.createFromTime(<code>time</code>)</a></h3><p>Creates an ObjectId from a second based number, with the rest of the ObjectId zeroed out. Used for comparisons or sorting the ObjectId.</p><div class="params"><h4>Parameters:</h4><ul><li><code>time</code><span class="types"> &lt;<a href="#number">number</a>&gt; </span><span>an integer number representing a number of seconds.</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#types_objectid_ObjectId">ObjectId</a>&gt; </span><span>return the created ObjectId</span></li></ul></div><hr></div><div class="item static public"><h3 id="types_objectid_ObjectId.createPk"><a href="#types_objectid_ObjectId.createPk">ObjectId.createPk()</a></h3><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">ObjectId.createPk = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createPk</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ObjectId();
};</code></pre></div><hr></div><div class="item static public"><h3 id="types_objectid_module.exports"><a href="#types_objectid_module.exports">module.exports</a></h3><p>Expose.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="hljs-built_in">module</span>.exports = ObjectId;
<span class="hljs-built_in">module</span>.exports.ObjectId = ObjectId;</code></pre></div><hr></div><div class="item static public"><h3 id="types_objectid_ObjectId.index"><a href="#types_objectid_ObjectId.index">ObjectId.index</a></h3><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">ObjectId.index = <span class="hljs-built_in">parseInt</span>(<span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">0xFFFFFF</span>, <span class="hljs-number">10</span>);</code></pre></div><hr></div><div class="item static public"><h3 id="types_objectid_ObjectId.isValid"><a href="#types_objectid_ObjectId.isValid">ObjectId.isValid()</a></h3><p>Checks if a value is a valid bson ObjectId</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#boolean">boolean</a>&gt; </span><span>return true if the value is a valid bson ObjectId, return false otherwise.</span></li></ul></div><hr></div><div class="item property public"><h3 id="types_objectid_ObjectId-ObjectId"><a href="#types_objectid_ObjectId-ObjectId">ObjectId#<span>ObjectId</span></a></h3><p>Create a new ObjectId instance</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ObjectId</span><span class="hljs-params">(id)</span> </span>{
  <span class="hljs-keyword">if</span>(!(<span class="hljs-keyword">this</span> <span class="hljs-keyword">instanceof</span> ObjectId)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ObjectId(id);
  <span class="hljs-keyword">if</span>((id <span class="hljs-keyword">instanceof</span> ObjectId)) <span class="hljs-keyword">return</span> id;

  <span class="hljs-keyword">this</span>._bsontype = <span class="hljs-string">'ObjectId'</span>;
  <span class="hljs-keyword">var</span> valid = ObjectId.isValid(id);

  <span class="hljs-comment">// Throw an error if it's not a valid setup</span>
  <span class="hljs-keyword">if</span>(!valid &amp;&amp; id != <span class="hljs-literal">null</span>){
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Argument passed in must be a single String of 12 bytes or a string of 24 hex characters"</span>);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(valid &amp;&amp; <span class="hljs-keyword">typeof</span> id == <span class="hljs-string">'string'</span> &amp;&amp; id.length == <span class="hljs-number">24</span>) {
    <span class="hljs-keyword">return</span> ObjectId.createFromHexString(id);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(id == <span class="hljs-literal">null</span> || <span class="hljs-keyword">typeof</span> id == <span class="hljs-string">'number'</span>) {
    <span class="hljs-comment">// convert to 12 byte binary string</span>
    <span class="hljs-keyword">this</span>.id = <span class="hljs-keyword">this</span>.generate(id);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(id != <span class="hljs-literal">null</span> &amp;&amp; id.length === <span class="hljs-number">12</span>) {
    <span class="hljs-comment">// assume 12 byte string</span>
    <span class="hljs-keyword">this</span>.id = id;
  }

  <span class="hljs-keyword">if</span>(ObjectId.cacheHexString) <span class="hljs-keyword">this</span>.__id = <span class="hljs-keyword">this</span>.toHexString();
}

<span class="hljs-comment">// Precomputed hex table enables speedy hex string conversion</span>
<span class="hljs-keyword">var</span> hexTable = [];
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">256</span>; i++) {
  hexTable[i] = (i &lt;= <span class="hljs-number">15</span> ? <span class="hljs-string">'0'</span> : <span class="hljs-string">''</span>) + i.toString(<span class="hljs-number">16</span>);
}</code></pre></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#types_objectid_ObjectId">ObjectId</a>&gt; </span><span>instance of ObjectId.</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="https://github.com/mongodb/js-bson/blob/master/lib/bson/objectid.js">https://github.com/mongodb/js-bson/blob/master/lib/bson/objectid.js</a></li></ul></div><hr></div></li><li class="module"><a href="https://github.com/archangel-irk/storage/blob/0.0.1/lib/utils.js" id="utils-js">utils.js</a><div class="item static public"><h3 id="utils_exports.pluralization"><a href="#utils_exports.pluralization">exports.pluralization</a></h3><p>Pluralization rules.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">exports.pluralization = [
  [<span class="hljs-regexp">/(m)an$/gi</span>, <span class="hljs-string">'$1en'</span>],
  [<span class="hljs-regexp">/(pe)rson$/gi</span>, <span class="hljs-string">'$1ople'</span>],
  [<span class="hljs-regexp">/(child)$/gi</span>, <span class="hljs-string">'$1ren'</span>],
  [<span class="hljs-regexp">/^(ox)$/gi</span>, <span class="hljs-string">'$1en'</span>],
  [<span class="hljs-regexp">/(ax|test)is$/gi</span>, <span class="hljs-string">'$1es'</span>],
  [<span class="hljs-regexp">/(octop|vir)us$/gi</span>, <span class="hljs-string">'$1i'</span>],
  [<span class="hljs-regexp">/(alias|status)$/gi</span>, <span class="hljs-string">'$1es'</span>],
  [<span class="hljs-regexp">/(bu)s$/gi</span>, <span class="hljs-string">'$1ses'</span>],
  [<span class="hljs-regexp">/(buffal|tomat|potat)o$/gi</span>, <span class="hljs-string">'$1oes'</span>],
  [<span class="hljs-regexp">/([ti])um$/gi</span>, <span class="hljs-string">'$1a'</span>],
  [<span class="hljs-regexp">/sis$/gi</span>, <span class="hljs-string">'ses'</span>],
  [<span class="hljs-regexp">/(?:([^f])fe|([lr])f)$/gi</span>, <span class="hljs-string">'$1$2ves'</span>],
  [<span class="hljs-regexp">/(hive)$/gi</span>, <span class="hljs-string">'$1s'</span>],
  [<span class="hljs-regexp">/([^aeiouy]|qu)y$/gi</span>, <span class="hljs-string">'$1ies'</span>],
  [<span class="hljs-regexp">/(x|ch|ss|sh)$/gi</span>, <span class="hljs-string">'$1es'</span>],
  [<span class="hljs-regexp">/(matr|vert|ind)ix|ex$/gi</span>, <span class="hljs-string">'$1ices'</span>],
  [<span class="hljs-regexp">/([m|l])ouse$/gi</span>, <span class="hljs-string">'$1ice'</span>],
  [<span class="hljs-regexp">/(kn|w|l)ife$/gi</span>, <span class="hljs-string">'$1ives'</span>],
  [<span class="hljs-regexp">/(quiz)$/gi</span>, <span class="hljs-string">'$1zes'</span>],
  [<span class="hljs-regexp">/s$/gi</span>, <span class="hljs-string">'s'</span>],
  [<span class="hljs-regexp">/([^a-z])$/</span>, <span class="hljs-string">'$1'</span>],
  [<span class="hljs-regexp">/$/gi</span>, <span class="hljs-string">'s'</span>]
];
<span class="hljs-keyword">var</span> rules = exports.pluralization;</code></pre></div><p>These rules are applied while processing the argument to <code>pluralize</code>.</p><hr></div><div class="item static public"><h3 id="utils_exports.uncountables"><a href="#utils_exports.uncountables">exports.uncountables</a></h3><p>Uncountable words.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">exports.uncountables = [
  <span class="hljs-string">'advice'</span>,
  <span class="hljs-string">'energy'</span>,
  <span class="hljs-string">'excretion'</span>,
  <span class="hljs-string">'digestion'</span>,
  <span class="hljs-string">'cooperation'</span>,
  <span class="hljs-string">'health'</span>,
  <span class="hljs-string">'justice'</span>,
  <span class="hljs-string">'labour'</span>,
  <span class="hljs-string">'machinery'</span>,
  <span class="hljs-string">'equipment'</span>,
  <span class="hljs-string">'information'</span>,
  <span class="hljs-string">'pollution'</span>,
  <span class="hljs-string">'sewage'</span>,
  <span class="hljs-string">'paper'</span>,
  <span class="hljs-string">'money'</span>,
  <span class="hljs-string">'species'</span>,
  <span class="hljs-string">'series'</span>,
  <span class="hljs-string">'rain'</span>,
  <span class="hljs-string">'rice'</span>,
  <span class="hljs-string">'fish'</span>,
  <span class="hljs-string">'sheep'</span>,
  <span class="hljs-string">'moose'</span>,
  <span class="hljs-string">'deer'</span>,
  <span class="hljs-string">'news'</span>,
  <span class="hljs-string">'expertise'</span>,
  <span class="hljs-string">'status'</span>,
  <span class="hljs-string">'media'</span>
];
<span class="hljs-keyword">var</span> uncountables = exports.uncountables;</code></pre></div><p>These words are applied while processing the argument to <code>pluralize</code>.</p><hr></div></li><li class="module"><a href="https://github.com/archangel-irk/storage/blob/0.0.1/lib/virtualtype.js" id="virtualtype-js">virtualtype.js</a><div class="item method public"><h3 id="virtualtype_VirtualType"><a href="#virtualtype_VirtualType">VirtualType()</a></h3><p>VirtualType constructor</p><div class="description"><p>This is what mongoose uses to define virtual attributes via <code>Schema.prototype.virtual</code>.</p><h4>Example:</h4>
<pre><code><span class="hljs-keyword">var</span> fullname = schema.virtual(&amp;#<span class="hljs-number">39</span>;fullname&amp;#<span class="hljs-number">39</span>;);
fullname <span class="hljs-keyword">instanceof</span> mongoose.VirtualType <span class="hljs-comment">// true</span></code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">VirtualType</span> <span class="hljs-params">(options, name)</span> </span>{
  <span class="hljs-keyword">this</span>.path = name;
  <span class="hljs-keyword">this</span>.getters = [];
  <span class="hljs-keyword">this</span>.setters = [];
  <span class="hljs-keyword">this</span>.options = options || {};
}</code></pre></div><hr></div><div class="item method public"><h3 id="virtualtype_VirtualType-applyGetters"><a href="#virtualtype_VirtualType-applyGetters">VirtualType#applyGetters(<code>value</code>, <code>scope</code>)</a></h3><p>Applies getters to <code>value</code> using optional <code>scope</code>.</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>scope</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#*">*</a>&gt; </span><span>the value after applying all getters</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">VirtualType.prototype.applyGetters = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value, scope)</span> </span>{
  <span class="hljs-keyword">var</span> v = value;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> l = <span class="hljs-keyword">this</span>.getters.length - <span class="hljs-number">1</span>; l &gt;= <span class="hljs-number">0</span>; l--) {
    v = <span class="hljs-keyword">this</span>.getters[l].call(scope, v, <span class="hljs-keyword">this</span>);
  }
  <span class="hljs-keyword">return</span> v;
};</code></pre></div><hr></div><div class="item method public"><h3 id="virtualtype_VirtualType-applySetters"><a href="#virtualtype_VirtualType-applySetters">VirtualType#applySetters(<code>value</code>, <code>scope</code>)</a></h3><p>Applies setters to <code>value</code> using optional <code>scope</code>.</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>scope</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#*">*</a>&gt; </span><span>the value after applying all setters</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">VirtualType.prototype.applySetters = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value, scope)</span> </span>{
  <span class="hljs-keyword">var</span> v = value;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> l = <span class="hljs-keyword">this</span>.setters.length - <span class="hljs-number">1</span>; l &gt;= <span class="hljs-number">0</span>; l--) {
    v = <span class="hljs-keyword">this</span>.setters[l].call(scope, v, <span class="hljs-keyword">this</span>);
  }
  <span class="hljs-keyword">return</span> v;
};</code></pre></div><hr></div><div class="item method public"><h3 id="virtualtype_VirtualType-get"><a href="#virtualtype_VirtualType-get">VirtualType#get(<code>fn</code>)</a></h3><p>Defines a getter.</p><div class="params"><h4>Parameters:</h4><ul><li><code>fn</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#virtualtype_VirtualType">VirtualType</a>&gt; </span><span>this</span></li></ul></div><div class="description"><h4>Example:</h4>
<pre><code><span class="hljs-keyword">var</span> virtual = schema.virtual(&amp;#<span class="hljs-number">39</span>;fullname&amp;#<span class="hljs-number">39</span>;);
virtual.get(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.name.first + &amp;#<span class="hljs-number">39</span>; &amp;#<span class="hljs-number">39</span>; + <span class="hljs-keyword">this</span>.name.last;
});</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">VirtualType.prototype.get = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn)</span> </span>{
  <span class="hljs-keyword">this</span>.getters.push(fn);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</code></pre></div><hr></div><div class="item method public"><h3 id="virtualtype_VirtualType-set"><a href="#virtualtype_VirtualType-set">VirtualType#set(<code>fn</code>)</a></h3><p>Defines a setter.</p><div class="params"><h4>Parameters:</h4><ul><li><code>fn</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#virtualtype_VirtualType">VirtualType</a>&gt; </span><span>this</span></li></ul></div><div class="description"><h4>Example:</h4>
<pre><code><span class="hljs-keyword">var</span> virtual = schema.virtual(&amp;#<span class="hljs-number">39</span>;fullname&amp;#<span class="hljs-number">39</span>;);
virtual.set(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v)</span> </span>{
  <span class="hljs-keyword">var</span> parts = v.split(&amp;#<span class="hljs-number">39</span>; &amp;#<span class="hljs-number">39</span>;);
  <span class="hljs-keyword">this</span>.name.first = parts[<span class="hljs-number">0</span>];
  <span class="hljs-keyword">this</span>.name.last = parts[<span class="hljs-number">1</span>];
});</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">VirtualType.prototype.set = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn)</span> </span>{
  <span class="hljs-keyword">this</span>.setters.push(fn);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</code></pre></div><hr></div></li><li class="module"><a href="https://github.com/archangel-irk/storage/blob/0.0.1/lib/collection.js" id="collection-js">collection.js</a><div class="item method public"><h3 id="collection_Collection"><a href="#collection_Collection">Collection(<code>name</code>, <code>schema</code>, <code>[api]</code>)</a></h3><p>Конструктор коллекций.</p><div class="params"><h4>Parameters:</h4><ul><li><code>name</code><span class="types"> &lt;<a href="#string">string</a>&gt; </span><span>- название коллекции</span></li><li><code>schema</code><span class="types"> &lt;<a href="#schema_Schema">Schema</a>&gt; </span><span>- Схема или объект описания схемы</span></li><li><code>[api]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>- ссылка на api ресурс</span></li></ul></div><div class="description"></div><hr></div><div class="item method public"><h3 id="collection_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-add"><a href="#collection_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-add">function Object() { [native code] }#add(<code>[doc]</code>, <code>[fields]</code>, <code>[init]</code>, <code>[_storageWillMutate]</code>)</a></h3><p>Добавить документ или массив документов.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[doc]</code><span class="types"> &lt;<a href="#object">object</a>, <a href="#Array.<object>">Array.<object></a>&gt; </span><span>- Документ</span></li><li><code>[fields]</code><span class="types"> &lt;<a href="#object">object</a>&gt; </span><span>- выбранные поля при запросе (не реализовано в документе)</span></li><li><code>[init]</code><span class="types"> &lt;<a href="#boolean">boolean</a>&gt; </span><span>- hydrate document - наполнить документ данными (используется в api-client)</span></li><li><code>[_storageWillMutate]</code><span class="types"> &lt;<a href="#boolean">boolean</a>&gt; </span><span>- Флаг добавления массива документов. только для внутреннего использования</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">add: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( doc, fields, init, _storageWillMutate )</span></span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;

  <span class="hljs-comment">// Если документа нет, значит будет пустой</span>
  <span class="hljs-keyword">if</span> ( doc == <span class="hljs-literal">null</span> ) doc = <span class="hljs-literal">null</span>;

  <span class="hljs-comment">// Массив документов</span>
  <span class="hljs-keyword">if</span> ( _.isArray( doc ) ){
    <span class="hljs-keyword">var</span> savedDocs = [];

    _.each( doc, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( doc )</span></span>{
      savedDocs.push( self.add( doc, fields, init, <span class="hljs-literal">true</span> ) );
    });

    <span class="hljs-keyword">this</span>.storageHasMutated();

    <span class="hljs-keyword">return</span> savedDocs;
  }

  <span class="hljs-keyword">var</span> id = doc &amp;&amp; doc._id;

  <span class="hljs-comment">// Если документ уже есть, то просто установить значения</span>
  <span class="hljs-keyword">if</span> ( id &amp;&amp; <span class="hljs-keyword">this</span>.documents[ id ] ){
    <span class="hljs-keyword">this</span>.documents[ id ].set( doc );

  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">var</span> discriminatorMapping = <span class="hljs-keyword">this</span>.schema
      ? <span class="hljs-keyword">this</span>.schema.discriminatorMapping
      : <span class="hljs-literal">null</span>;

    <span class="hljs-keyword">var</span> key = discriminatorMapping &amp;&amp; discriminatorMapping.isRoot
      ? discriminatorMapping.key
      : <span class="hljs-literal">null</span>;

    <span class="hljs-comment">// Выбираем схему, если есть дискриминатор</span>
    <span class="hljs-keyword">var</span> schema;
    <span class="hljs-keyword">if</span> (key &amp;&amp; doc &amp;&amp; doc[key] &amp;&amp; <span class="hljs-keyword">this</span>.schema.discriminators &amp;&amp; <span class="hljs-keyword">this</span>.schema.discriminators[doc[key]]) {
      schema = <span class="hljs-keyword">this</span>.schema.discriminators[doc[key]];

    } <span class="hljs-keyword">else</span> {
      schema = <span class="hljs-keyword">this</span>.schema;
    }

    <span class="hljs-keyword">var</span> newDoc = <span class="hljs-keyword">new</span> Document( doc, <span class="hljs-keyword">this</span>.name, schema, fields, init );
    id = newDoc._id.toString();
  }

  <span class="hljs-comment">// Для одиночных документов тоже нужно  вызвать storageHasMutated</span>
  <span class="hljs-keyword">if</span> ( !_storageWillMutate ){
    <span class="hljs-keyword">this</span>.storageHasMutated();
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.documents[ id ];
},</code></pre></div><hr></div><div class="item method public"><h3 id="collection_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-find"><a href="#collection_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-find">function Object() { [native code] }#find(<code></code>)</a></h3><p>Найти документы.</p><div class="params"><h4>Parameters:</h4><ul><li><code></code><span class="types"> &lt;<a href="#conditions">conditions</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">find: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( conditions )</span></span>{
  <span class="hljs-keyword">return</span> _.where( <span class="hljs-keyword">this</span>.documents, conditions );
},</code></pre></div><hr></div><div class="item method public"><h3 id="collection_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-findById"><a href="#collection_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-findById">function Object() { [native code] }#findById(<code></code>)</a></h3><p>Найти один документ по id.</p><div class="params"><h4>Parameters:</h4><ul><li><code></code><span class="types"> &lt;<a href="#_id">_id</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">findById: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( _id )</span></span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.documents[ _id ];
},</code></pre></div><hr></div><div class="item method public"><h3 id="collection_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-findByIdAndRemove"><a href="#collection_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-findByIdAndRemove">function Object() { [native code] }#findByIdAndRemove(<code></code>)</a></h3><p>Найти по id документ и удалить его.</p><div class="params"><h4>Parameters:</h4><ul><li><code></code><span class="types"> &lt;<a href="#_id">_id</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="Collection.findById" title="Collection.findById">Collection.findById</a></li><li><a href="Collection.remove " title="Collection.remove">Collection.remove</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">findByIdAndRemove: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( _id )</span></span>{
  <span class="hljs-keyword">this</span>.remove( <span class="hljs-keyword">this</span>.findById( _id ) );
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
},</code></pre></div><hr></div><div class="item method public"><h3 id="collection_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-findByIdAndUpdate"><a href="#collection_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-findByIdAndUpdate">function Object() { [native code] }#findByIdAndUpdate(<code></code>, <code>path</code>, <code>value</code>)</a></h3><p>Найти по id документ и обновить его.</p><div class="params"><h4>Parameters:</h4><ul><li><code></code><span class="types"> &lt;<a href="#_id">_id</a>&gt; </span><span></span></li><li><code>path</code><span class="types"> &lt;<a href="#string">string</a>, <a href="#object">object</a>&gt; </span><span></span></li><li><code>value</code><span class="types"> &lt;<a href="#object">object</a>, <a href="#boolean">boolean</a>, <a href="#number">number</a>, <a href="#string">string</a>, <a href="#null">null</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/undefined">undefined</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="Collection.findById" title="Collection.findById">Collection.findById</a></li><li><a href="Collection.update " title="Collection.update">Collection.update</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">findByIdAndUpdate: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( _id, path, value )</span></span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.update( <span class="hljs-keyword">this</span>.findById( _id ), path, value );
},</code></pre></div><hr></div><div class="item method public"><h3 id="collection_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-findOne"><a href="#collection_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-findOne">function Object() { [native code] }#findOne(<code></code>)</a></h3><p>Найти один документ.</p><div class="params"><h4>Parameters:</h4><ul><li><code></code><span class="types"> &lt;<a href="#conditions">conditions</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">findOne: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( conditions )</span></span>{
  <span class="hljs-keyword">return</span> _.findWhere( <span class="hljs-keyword">this</span>.documents, conditions );
},</code></pre></div><hr></div><div class="item method public"><h3 id="collection_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-findOneAndRemove"><a href="#collection_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-findOneAndRemove">function Object() { [native code] }#findOneAndRemove(<code>conditions</code>)</a></h3><p>Найти по условию один документ и удалить его.</p><div class="params"><h4>Parameters:</h4><ul><li><code>conditions</code><span class="types"> &lt;<a href="#object">object</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="Collection.findOne" title="Collection.findOne">Collection.findOne</a></li><li><a href="Collection.remove " title="Collection.remove">Collection.remove</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">findOneAndRemove: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( conditions )</span></span>{
  <span class="hljs-keyword">this</span>.remove( <span class="hljs-keyword">this</span>.findOne( conditions ) );
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
},</code></pre></div><hr></div><div class="item method public"><h3 id="collection_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-findOneAndUpdate"><a href="#collection_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-findOneAndUpdate">function Object() { [native code] }#findOneAndUpdate(<code>conditions</code>, <code>path</code>, <code>value</code>)</a></h3><p>Найти документ по условию и обновить его.</p><div class="params"><h4>Parameters:</h4><ul><li><code>conditions</code><span class="types"> &lt;<a href="#object">object</a>&gt; </span><span></span></li><li><code>path</code><span class="types"> &lt;<a href="#string">string</a>, <a href="#object">object</a>&gt; </span><span></span></li><li><code>value</code><span class="types"> &lt;<a href="#object">object</a>, <a href="#boolean">boolean</a>, <a href="#number">number</a>, <a href="#string">string</a>, <a href="#null">null</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/undefined">undefined</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="Collection.findOne" title="Collection.findOne">Collection.findOne</a></li><li><a href="Collection.update " title="Collection.update">Collection.update</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">findOneAndUpdate: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( conditions, path, value )</span></span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.update( <span class="hljs-keyword">this</span>.findOne( conditions ), path, value );
},</code></pre></div><hr></div><div class="item method public"><h3 id="collection_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-remove"><a href="#collection_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-remove">function Object() { [native code] }#remove(<code>document</code>)</a></h3><p>Удаленить документ.</p><div class="params"><h4>Parameters:</h4><ul><li><code>document</code><span class="types"> &lt;<a href="#object">object</a>, <a href="#number">number</a>&gt; </span><span>- Сам документ или его id.</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">remove: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( document )</span></span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.documents[ <span class="hljs-built_in">document</span>._id || <span class="hljs-built_in">document</span> ];
},</code></pre></div><hr></div><div class="item method public"><h3 id="collection_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-storageHasMutated"><a href="#collection_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-storageHasMutated">function Object() { [native code] }#storageHasMutated()</a></h3><p>Обработчик на изменения (добавление, удаление) данных в коллекции</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">storageHasMutated: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
  <span class="hljs-comment">// Обновим массив документов (специальное отображение для перебора нокаутом)</span>
  <span class="hljs-keyword">this</span>.array = _.toArray( <span class="hljs-keyword">this</span>.documents );
}
};</code></pre></div><hr></div><div class="item method public"><h3 id="collection_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-update"><a href="#collection_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-update">function Object() { [native code] }#update(<code>document</code>, <code>path</code>, <code>value</code>)</a></h3><p>Обновить существующие поля в документе.</p><div class="params"><h4>Parameters:</h4><ul><li><code>document</code><span class="types"> &lt;<a href="#number">number</a>, <a href="#object">object</a>&gt; </span><span></span></li><li><code>path</code><span class="types"> &lt;<a href="#string">string</a>, <a href="#object">object</a>&gt; </span><span></span></li><li><code>value</code><span class="types"> &lt;<a href="#object">object</a>, <a href="#boolean">boolean</a>, <a href="#number">number</a>, <a href="#string">string</a>, <a href="#null">null</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/undefined">undefined</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">update: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( document, path, value )</span></span>{
  <span class="hljs-keyword">var</span> doc = <span class="hljs-keyword">this</span>.documents[ <span class="hljs-built_in">document</span>._id || <span class="hljs-built_in">document</span> ];

  <span class="hljs-keyword">if</span> ( doc == <span class="hljs-literal">null</span> ){
    <span class="hljs-built_in">console</span>.warn(<span class="hljs-string">'storage::update: Document is not found.'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  <span class="hljs-keyword">return</span> doc.set( path, value );
},</code></pre></div><hr></div></li></ul></div><script>document.body.className = 'load';</script><script src="/docs/js/zepto.min.js"></script><script src="/docs/js/cookies.min.js"></script><script>$(".module").on("click", ".showcode", function (e) {
  $(this).closest(".item").find(".sourcecode").first().toggle();
});
$("#content .controls input").on("click", function (e) {
  $(".private").toggle()
  var checked = $(this).prop('checked');
  Cookies.set('prv', checked);
});
;(function(){
  var checked = 'true' === Cookies.get('prv');
  if (checked) {
    $("#content .controls input").prop('checked', 'checked');
    $(".private").show()
  }
  $("#links, #content").on("click", "a", function (e) {
    if (_gaq && this.hash) {
      _gaq.push(['_trackEvent', 'anchor', 'click', this.hash])
    }
  })
})()</script></body></html>